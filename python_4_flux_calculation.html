<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/New_BAI_DataAnalysis/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/New_BAI_DataAnalysis/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li:not(:nth-child(6)) > a, .site-nav > ul.nav-list:first-child > li > ul > li a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(6) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(6) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(6) > ul.nav-list { display: block; } </style> <script src="/New_BAI_DataAnalysis/assets/js/vendor/lunr.min.js"></script> <script src="/New_BAI_DataAnalysis/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>FLUX CALCULATION | Data Analysis for Ecologist</title> <meta name="generator" content="Jekyll v3.10.0" /> <meta property="og:title" content="FLUX CALCULATION" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="A tutorial for starters learning how to use python to munipulate climate data!" /> <meta property="og:description" content="A tutorial for starters learning how to use python to munipulate climate data!" /> <link rel="canonical" href="https://ericluoyuu.github.io/New_BAI_DataAnalysis/python_4_flux_calculation.html" /> <meta property="og:url" content="https://ericluoyuu.github.io/New_BAI_DataAnalysis/python_4_flux_calculation.html" /> <meta property="og:site_name" content="Data Analysis for Ecologist" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="FLUX CALCULATION" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"A tutorial for starters learning how to use python to munipulate climate data!","headline":"FLUX CALCULATION","url":"https://ericluoyuu.github.io/New_BAI_DataAnalysis/python_4_flux_calculation.html"}</script> <!-- End Jekyll SEO tag --> </head> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']], displayMath: [ ['$$', '$$'] ], processEscapes: true, processEnvironments: true } }); </script> <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"> </script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"> </script> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <header class="side-bar"> <div class="site-header"> <a href="/New_BAI_DataAnalysis/" class="site-title lh-tight"> Data Analysis for Ecologist </a> <button id="menu-button" class="site-button btn-reset" aria-label="Menu" aria-expanded="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/New_BAI_DataAnalysis/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/New_BAI_DataAnalysis/python_0_installation.html" class="nav-list-link">0. INSTALLATION</a></li><li class="nav-list-item"><a href="/New_BAI_DataAnalysis/python_1_basics.html" class="nav-list-link">1. BASICS OF PYTHON</a></li><li class="nav-list-item"><a href="/New_BAI_DataAnalysis/python_2_data_visualization.html" class="nav-list-link">2. DATA HANDLING AND VISUALIZATION</a></li><li class="nav-list-item"><a href="/New_BAI_DataAnalysis/python_3_regression.html" class="nav-list-link">3. REGRESSION</a></li><li class="nav-list-item"><a href="/New_BAI_DataAnalysis/python_4_flux_calculation.html" class="nav-list-link">4. FLUX CALCULATION</a></li></ul> </nav> <div class="d-md-block d-none"> <div class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </div> </div> </header> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Data Analysis for Ecologist" autocomplete="off"> <label for="search-input" class="search-label"> <span class="sr-only">Search Data Analysis for Ecologist</span> <svg viewBox="0 0 24 24" class="search-icon" aria-hidden="true"><use xlink:href="#svg-search"></use></svg> </label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div class="main-content-wrap"> <div id="main-content" class="main-content"> <main> <h1 id="flux-calculation"> <a href="#flux-calculation" class="anchor-heading" aria-labelledby="flux-calculation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <strong>Flux Calculation</strong> </h1> <p>In this tutorial, we’re going to analyze the data you collected on your field trip to the Lüner forest! Your instruments measured raw gas concentrations, but as ecologists, we need to turn that into gas fluxes. Why? Because fluxes represent a rate—the speed at which gases are being exchanged. With CO₂ fluxes, we can estimate crucial metrics like ecosystem respiration (RECO) and net ecosystem exchange (NEE). With fluxes of a potent greenhouse gas like Nitrous Oxide (N₂O), we can understand a key part of the nitrogen cycle. This guide will walk you through the entire process: from cleaning the raw concentration data, to calculating meaningful fluxes, and finally to comparing the results between different land cover types.</p> <blockquote> <p><strong>Notice:</strong> In the following sections, we will start using new functions and libraries that we haven’t introduced yet. Don’t worry or feel overwhelmed! This is a normal part of learning to code. For each new tool we use, I will: Briefly explain what it is and why we are using it. Provide a link to its official documentation if you’re curious and want to learn more. Think of it as adding new tools to your data analysis toolbox. We’ll introduce them one at a time, right when we need them.</p> </blockquote> <h3 id="table-of-contents"> <a href="#table-of-contents" class="anchor-heading" aria-labelledby="table-of-contents"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of Contents </h3> <ol> <li><a href="#1-read-in-and-merge-data-files">Read in and merge data files</a></li> <li><a href="#2-visualizing-and-cleaning-the-data">Visualizing and cleaning the data</a></li> <li><a href="#3-calculating-flux-for-a-single-measurement">Calculating flux for a single measurement</a></li> <li><a href="#4-automating-gas-flux-calculation">Automating gas flux calculation</a></li> </ol> <h2 id="1read-in-and-merge-data-files"> <a href="#1read-in-and-merge-data-files" class="anchor-heading" aria-labelledby="1read-in-and-merge-data-files"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1.Read in and merge data files </h2> <p>Different from the simple CSV files we might have worked with before, the raw data from the gas analyzer is more complex. When you open the file, you’ll see it contains two parts: A metadata header: This block at the top contains useful information about the measurement (like timezone, device model, etc.), but we don’t need it for our flux calculations. The data block: This is the core data we need, with columns for date, time, and gas concentrations. Our first challenge is to programmatically read only the data block and ignore the metadata.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Model:	LI-7820
SN:	TG20-01072
Software Version:	2.3.8
Timestamp:	2025-08-15 11:00:00
Timezone:	Europe/Paris
</code></pre></div></div> <p>To do this, we’ll need the pandas library for creating our DataFrame and the io library, we need to import them.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">io</span>
</code></pre></div></div> <p>Our strategy will be to read the file line-by-line, find the start of the data, and then pass only those lines to pandas.</p> <h3 id="11-loading-no-data"> <a href="#11-loading-no-data" class="anchor-heading" aria-labelledby="11-loading-no-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1.1 Loading N₂O Data </h3> <p>The analyzer produces tab-separated files with a metadata block at the top. The data section is marked by a line starting with DATAH. Our strategy is to read the file line-by-line, find the DATAH marker, and pass only the data lines to pandas.</p> <h3 id="reading-and-parsing-the-file"> <a href="#reading-and-parsing-the-file" class="anchor-heading" aria-labelledby="reading-and-parsing-the-file"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Reading and parsing the file </h3> <p>First, we read the entire file into a single string, and then split that string into a list of individual lines. This gives us the flexibility to find our data “landmarks.”</p> <blockquote> <p><strong>Info: The <code class="language-plaintext highlighter-rouge">split()</code> Method</strong></p> <p>The <code class="language-plaintext highlighter-rouge">split()</code> method breaks a string into a <strong>list of substrings</strong> based on a delimiter (separator character). You can specify the speperator by passing it to the split method as an agrgument (if nothing is passed to the method, it would be ‘ ‘(spaces) by default).</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Split by spaces (default)
</span><span class="n">sentence</span> <span class="o">=</span> <span class="s">"Hello World Python"</span>
<span class="n">words</span> <span class="o">=</span> <span class="n">sentence</span><span class="p">.</span><span class="n">split</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>  <span class="c1"># ['Hello', 'World', 'Python']
</span>
<span class="c1"># Split by a specific character
</span><span class="n">data</span> <span class="o">=</span> <span class="s">"apple,banana,cherry"</span>
<span class="n">fruits</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">','</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">fruits</span><span class="p">)</span>  <span class="c1"># ['apple', 'banana', 'cherry']
</span>
<span class="c1"># Split by newline character
</span><span class="n">text</span> <span class="o">=</span> <span class="s">"Line 1</span><span class="se">\n</span><span class="s">Line 2</span><span class="se">\n</span><span class="s">Line 3"</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>  <span class="c1"># ['Line 1', 'Line 2', 'Line 3']
</span></code></pre></div> </div> <p><strong>Common delimiters:</strong></p> <div class="table-wrapper"><table> <thead> <tr> <th>Delimiter</th> <th>Meaning</th> <th>Use Case</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">'\n'</code></td> <td>Newline</td> <td>Split text into lines</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">'\t'</code></td> <td>Tab</td> <td>Tab-separated data</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">','</code></td> <td>Comma</td> <td>CSV-style data</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">'; '</code></td> <td>Semicolon+space</td> <td>Custom lists</td> </tr> </tbody> </table></div> <p><strong>Resources:</strong> <a href="https://docs.python.org/3/library/stdtypes.html#str.split">Python split() documentation</a></p> </blockquote> <p>Now let’s apply this to our file, first we read in the raw data as a string, then we split the string into lines making use of ‘\n’ speperator (as we know that ‘\n’ are always used to speperate lines).</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Read in raw data as a string
</span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"./BAI_StudyProject_LuentenerWald/raw_data/N2O/TG20-01072-2025-08-15T110000.data.txt"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">file_content</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>

<span class="c1"># Split the string into a list of lines
# '\n' is the special character for a newline
</span><span class="n">lines</span> <span class="o">=</span> <span class="n">file_content</span><span class="p">.</span><span class="n">strip</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Total lines in file: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"First line: </span><span class="si">{</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Last line: </span><span class="si">{</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div> <p>Next, we need to find the exact line that contains our column headers to further locate and extract lines containing data. Looking at the file, we know this line always starts with the word DATAH. We can write a short command to find the index of that line.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This code searches through our list 'lines' and gets the index of the first line that starts with 'DATAH'
</span><span class="n">header_index</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'DATAH'</span><span class="p">))</span>

<span class="c1"># The actual data starts 2 lines after the header line (to skip the "DATAU" units line)
</span><span class="n">data_start_index</span> <span class="o">=</span> <span class="n">header_index</span> <span class="o">+</span> <span class="mi">2</span>

<span class="c1"># Now we can grab the headers themselves from that line
# The values are separated by tabs ('\t'), so we split by tab
</span><span class="n">headers</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">header_index</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\t</span><span class="s">'</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Header found at line: </span><span class="si">{</span><span class="n">header_index</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Number of columns: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Column names: </span><span class="si">{</span><span class="n">headers</span><span class="p">[</span><span class="si">:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s">..."</span><span class="p">)</span>  <span class="c1"># Show first 5 columns
</span></code></pre></div></div> <h3 id="using-iostringio-to-read-our-cleaned-data"> <a href="#using-iostringio-to-read-our-cleaned-data" class="anchor-heading" aria-labelledby="using-iostringio-to-read-our-cleaned-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using io.StringIO to Read Our Cleaned Data </h3> <p>The pd.read_csv() function is built to read from a file. We don’t have a clean file; we have a list of Python strings (lines) that we’ve already processed. So, how do we make pandas read from our list? We use io.StringIO to trick pandas. It takes our cleaned-up data lines and presents them to pandas as if they were a file stored in the computer’s memory.</p> <blockquote> <p><strong>Info</strong>: The Python io module helps us manage data streams. io.StringIO specifically allows us to treat a regular text string as a &gt;file. This is incredibly useful when you need to pass text data to a function that expects a file, just like we’re doing &gt;with pd.read_csv().</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Join our data lines back into a single string, separated by newlines
</span><span class="n">data_string</span> <span class="o">=</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">data_start_index</span><span class="p">:])</span>
<span class="c1"># Read the data string into a DataFrame
</span><span class="n">df_n2o</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">io</span><span class="p">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">data_string</span><span class="p">),</span>  <span class="c1"># Treat our string as a file
</span>    <span class="n">sep</span><span class="o">=</span><span class="s">'</span><span class="se">\t</span><span class="s">'</span><span class="p">,</span>                  <span class="c1"># Tell pandas the data is separated by tabs
</span>    <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>               <span class="c1"># We are providing the headers ourselves, so there isn't one in the data
</span>    <span class="n">names</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>             <span class="c1"># Use the 'headers' list we extracted earlier to set headers
</span>    <span class="n">na_values</span><span class="o">=</span><span class="s">'nan'</span>            <span class="c1"># Recognize 'nan' strings as missing values
</span><span class="p">)</span>
</code></pre></div></div> <h3 id="data-formatting"> <a href="#data-formatting" class="anchor-heading" aria-labelledby="data-formatting"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Data Formatting </h3> <p>The last step is to tidy up the DataFrame. We will:</p> <ol> <li>Remove the useless DATAH column.</li> <li>Combine the separate DATE and TIME columns into a single Timestamp object. This is crucial for the gas flux calculation later on. The original files use speperate ‘DATE’ (day/month/year) and ‘TIME’ (hour/minute/second) columns to store time infomation, we can not locate a single measurement period based on one of them, so we need they to be combined.</li> <li>Set this new Timestamp as the DataFrame’s index, which makes plotting and selecting data by time much easier.</li> </ol> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Drop the first column which is just the 'DATAH' label
</span><span class="k">if</span> <span class="s">'DATAH'</span> <span class="ow">in</span> <span class="n">df_n2o</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">df_n2o</span> <span class="o">=</span> <span class="n">df_n2o</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'DATAH'</span><span class="p">])</span>

<span class="c1"># Combine 'DATE' and 'TIME' into a proper Timestamp and set it as the index
</span><span class="k">if</span> <span class="s">'DATE'</span> <span class="ow">in</span> <span class="n">df_n2o</span><span class="p">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s">'TIME'</span> <span class="ow">in</span> <span class="n">df_n2o</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">df_n2o</span><span class="p">[</span><span class="s">'Timestamp'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_n2o</span><span class="p">[</span><span class="s">'DATE'</span><span class="p">]</span> <span class="o">+</span> <span class="s">' '</span> <span class="o">+</span> <span class="n">df_n2o</span><span class="p">[</span><span class="s">'TIME'</span><span class="p">])</span>
    <span class="n">df_n2o</span> <span class="o">=</span> <span class="n">df_n2o</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'DATE'</span><span class="p">,</span> <span class="s">'TIME'</span><span class="p">])</span>
    <span class="n">df_n2o</span> <span class="o">=</span> <span class="n">df_n2o</span><span class="p">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'Timestamp'</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Data loaded and formatted successfully!"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_n2o</span><span class="p">.</span><span class="n">head</span><span class="p">())</span>
</code></pre></div></div> <p>Great! Now, we have successfully read in and formatted our raw data. However, think about our field campaigns. We went out several times and generate a new data file for each trip. If we wanted to analyze all of them, we would have to copy and paste our loading code multiple times. To avoid repetition and make our code cleaner and more reliable, it’s a best practice to wrap a reusable process into a function. Let’s turn our loading and cleaning steps into a function called load_n2o_data.</p> <div style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 5px;"> <div class="notice--primary"> <h3 id="exercise"> <a href="#exercise" class="anchor-heading" aria-labelledby="exercise"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exercise </h3> <p>Try to write this function yourself based on the code snippets we created for data loading! Tip: The function will need to accept one argument: the filepath of the file you want to open.</p> <details> <summary>Solution!</summary> <p>Hint: it’s the exact same logic as before, just defined within a def block. The function should take a filepath as input and return a formatted dataframe.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">load_n2o_data</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="s">"""
    Loads N2O data from a text file, remove metadata, and returns a DataFrame.

    Parameters:
    - filepath (str): The path to the input data file.

    Returns:
    - pd.DataFrame: A cleaned DataFrame with a DatetimeIndex.
    """</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">file_content</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="n">file_content</span><span class="p">.</span><span class="n">strip</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
    <span class="n">header_index</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'DATAH'</span><span class="p">))</span>
    <span class="n">data_start_index</span> <span class="o">=</span> <span class="n">header_index</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">header_index</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\t</span><span class="s">'</span><span class="p">)</span>

    <span class="n">df_n2o</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="n">io</span><span class="p">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">data_start_index</span><span class="p">:])),</span>
        <span class="n">sep</span><span class="o">=</span><span class="s">'</span><span class="se">\t</span><span class="s">'</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">names</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
        <span class="n">na_values</span><span class="o">=</span><span class="s">'nan'</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="s">'DATAH'</span> <span class="ow">in</span> <span class="n">df_n2o</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df_n2o</span> <span class="o">=</span> <span class="n">df_n2o</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'DATAH'</span><span class="p">])</span>

    <span class="k">if</span> <span class="s">'DATE'</span> <span class="ow">in</span> <span class="n">df_n2o</span><span class="p">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s">'TIME'</span> <span class="ow">in</span> <span class="n">df_n2o</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df_n2o</span><span class="p">[</span><span class="s">'Timestamp'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_n2o</span><span class="p">[</span><span class="s">'DATE'</span><span class="p">]</span> <span class="o">+</span> <span class="s">' '</span> <span class="o">+</span> <span class="n">df_n2o</span><span class="p">[</span><span class="s">'TIME'</span><span class="p">])</span>
        <span class="n">df_n2o</span> <span class="o">=</span> <span class="n">df_n2o</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'DATE'</span><span class="p">,</span> <span class="s">'TIME'</span><span class="p">])</span>
        <span class="n">df_n2o</span> <span class="o">=</span> <span class="n">df_n2o</span><span class="p">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'Timestamp'</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"N2O data loaded and cleaned successfully."</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_n2o</span>
</code></pre></div> </div> </details> </div> </div> <h3 id="12-loading-ch-and-co-data"> <a href="#12-loading-ch-and-co-data" class="anchor-heading" aria-labelledby="12-loading-ch-and-co-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1.2 Loading CH₄ and CO₂ Data </h3> <p>Different from N2O files, the GGA analyzer produces <strong>comma-separated files</strong> with a different structure: The first line includes instrument metadata (version, serial number, etc.), The second are column headers, Lines 3+ hold measurement data.</p> <p>Here’s an example of the first few lines:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>VC:2f90039 BD:Jan 16 2014 SN:
                     Time,      [CH4]_ppm,   [CH4]_ppm_sd,      [H2O]_ppm, ...
  08/15/2025 11:00:03.747,   2.080375e+00,   0.000000e+00,   1.103072e+03, ...
</code></pre></div></div> <p>Besides, GGA files contain extra non-data content at the end (such as digital signatures or log messages). We need to filter these out. Let’s build our loader step by step.</p> <h3 id="read-the-csv-file"> <a href="#read-the-csv-file" class="anchor-heading" aria-labelledby="read-the-csv-file"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Read the CSV File </h3> <p>First, we read the file with <code class="language-plaintext highlighter-rouge">pd.read_csv()</code>, skipping the first metadata line:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_gga</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s">"./BAI_StudyProject_LuentenerWald/raw_data/GGA/gga_2025-08-15_f0000.txt"</span><span class="p">,</span>
    <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>            <span class="c1"># Skip instrument metadata header (line 1)
</span>    <span class="n">skipinitialspace</span><span class="o">=</span><span class="bp">True</span>  <span class="c1"># Handle leading whitespace in columns
</span><span class="p">)</span>

<span class="c1"># Clean column names (remove extra spaces)
</span><span class="n">df_gga</span><span class="p">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df_gga</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nb">str</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Rows loaded: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_gga</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="n">df_gga</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div> <h3 id="identify-valid-data-rows"> <a href="#identify-valid-data-rows" class="anchor-heading" aria-labelledby="identify-valid-data-rows"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Identify Valid Data Rows </h3> <p>If we look at the end of some files, we might find non-data content like this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-----BEGIN PGP MESSAGE-----
Version: GnuPG v1.4.11 (GNU/Linux)
jA0EAwMC1o7j8zNG6eRgye1CgI1h0/yQoOa8fycg+...
</code></pre></div></div> <p>We need to keep only the rows where the <code class="language-plaintext highlighter-rouge">Time</code> column contains an actual timestamp. Valid timestamps in our data look like <code class="language-plaintext highlighter-rouge">08/15/2025 11:00:03.747</code> — they always start with a date in <code class="language-plaintext highlighter-rouge">MM/DD/YYYY</code> format.</p> <p>To identify these rows programmatically, we use a <strong>regular expression</strong> (regex). A regex is a pattern that describes what text should look like.</p> <blockquote> <p><strong>Info: What is a Regular Expression?</strong></p> <p>A regular expression is a sequence of characters that defines a search pattern. It’s like a template that says “I’m looking for text that looks like THIS.” Regular expressions are extremely powerful for finding, matching, and filtering text data.</p> </blockquote> <p>Here’s the regex pattern we’ll use: <code class="language-plaintext highlighter-rouge">^\s*\d{2}/\d{2}/\d{4}</code></p> <p>Let’s break it down piece by piece:</p> <div class="table-wrapper"><table> <thead> <tr> <th>Pattern</th> <th>Meaning</th> <th>Example Match</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">^</code></td> <td>Start of the string</td> <td>(anchors the match to the beginning)</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">\s*</code></td> <td>Zero or more whitespace characters</td> <td>Matches leading spaces like <code class="language-plaintext highlighter-rouge">" "</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">\d{2}</code></td> <td>Exactly 2 digits</td> <td><code class="language-plaintext highlighter-rouge">08</code> (month)</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">/</code></td> <td>A literal forward slash</td> <td><code class="language-plaintext highlighter-rouge">/</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">\d{2}</code></td> <td>Exactly 2 digits</td> <td><code class="language-plaintext highlighter-rouge">15</code> (day)</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">/</code></td> <td>A literal forward slash</td> <td><code class="language-plaintext highlighter-rouge">/</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">\d{4}</code></td> <td>Exactly 4 digits</td> <td><code class="language-plaintext highlighter-rouge">2025</code> (year)</td> </tr> </tbody> </table></div> <p>So the full pattern <code class="language-plaintext highlighter-rouge">^\s*\d{2}/\d{2}/\d{4}</code> means: “Starting from the beginning, allow optional spaces, then match a date in MM/DD/YYYY format.”</p> <blockquote> <p><strong>Learn More About Regular Expressions</strong></p> <p>Regular expressions are a powerful tool worth learning. Here are some helpful resources:</p> <ul> <li><a href="https://regexr.com/">RegExr</a> — Interactive regex tester with real-time explanations</li> <li><a href="https://regex101.com/">Regex101</a> — Another great tester with detailed breakdown of patterns</li> <li><a href="https://docs.python.org/3/library/re.html">Python re documentation</a> — Official Python regex documentation</li> <li><a href="https://www.dataquest.io/blog/regex-cheatsheet/">Regular Expressions Cheat Sheet</a> — Quick reference for common patterns</li> </ul> </blockquote> <p>Let’s see it in action:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">re</span>

<span class="c1"># Test the pattern on different strings
</span><span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s">'^\s*\d{2}/\d{2}/\d{4}'</span>

<span class="n">test_strings</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'  08/15/2025 11:00:03.747'</span><span class="p">,</span>    <span class="c1"># Valid timestamp (with leading spaces)
</span>    <span class="s">'08/15/2025 11:00:03.747'</span><span class="p">,</span>       <span class="c1"># Valid timestamp (no leading spaces)
</span>    <span class="s">'-----BEGIN PGP MESSAGE-----'</span><span class="p">,</span>   <span class="c1"># Invalid (PGP signature)
</span>    <span class="s">'jA0EAwMC1o7j8zNG6eRgye1C'</span><span class="p">,</span>      <span class="c1"># Invalid (encrypted data)
</span>    <span class="s">'nan'</span><span class="p">,</span>                            <span class="c1"># Invalid (missing value)
</span><span class="p">]</span>

<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">test_strings</span><span class="p">:</span>
    <span class="n">match</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="p">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"'</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="si">:</span><span class="mi">30</span><span class="p">]</span><span class="si">:</span><span class="mi">30</span><span class="n">s</span><span class="si">}</span><span class="s">' → </span><span class="si">{</span><span class="n">match</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div> <p>Output:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'  08/15/2025 11:00:03.747     ' → True
'08/15/2025 11:00:03.747       ' → True
'-----BEGIN PGP MESSAGE-----  ' → False
'jA0EAwMC1o7j8zNG6eRgye1C      ' → False
'nan                           ' → False
</code></pre></div></div> <p>Now we can use this pattern to filter our DataFrame: first we convert the ‘Time’ column into string format and utilize the regex to create a mask where only rows with valid timestamp are hold and lastly apply the mask to get clean data.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create a boolean mask: True for valid rows, False for invalid
# As regular expression can only be applied on string, we need to make sure timestamp is in string format
</span><span class="n">valid_mask</span> <span class="o">=</span> <span class="n">df_gga</span><span class="p">[</span><span class="s">'Time'</span><span class="p">].</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">).</span><span class="nb">str</span><span class="p">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s">'^\s*\d{2}/\d{2}/\d{4}'</span><span class="p">)</span>

<span class="c1"># Count how many rows we're keeping vs. dropping
</span><span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Valid rows: </span><span class="si">{</span><span class="n">valid_mask</span><span class="p">.</span><span class="nb">sum</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Invalid rows (will be dropped): </span><span class="si">{</span><span class="p">(</span><span class="o">~</span><span class="n">valid_mask</span><span class="p">).</span><span class="nb">sum</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># Keep only valid rows
</span><span class="n">df_gga</span> <span class="o">=</span> <span class="n">df_gga</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">].</span><span class="n">copy</span><span class="p">()</span>
</code></pre></div></div> <h3 id="parse-timestamps"> <a href="#parse-timestamps" class="anchor-heading" aria-labelledby="parse-timestamps"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Parse Timestamps </h3> <p>Now that we have only valid data, we convert the <code class="language-plaintext highlighter-rouge">Time</code> column to proper datetime objects:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Remove any leading/trailing whitespace and parse the timestamp
</span><span class="n">df_gga</span><span class="p">[</span><span class="s">'Time'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span>
    <span class="n">df_gga</span><span class="p">[</span><span class="s">'Time'</span><span class="p">].</span><span class="nb">str</span><span class="p">.</span><span class="n">strip</span><span class="p">(),</span> 
    <span class="nb">format</span><span class="o">=</span><span class="s">'%m/%d/%Y %H:%M:%S.%f'</span>
<span class="p">)</span>

<span class="c1"># Rename to 'Timestamp' for consistency and set as index
</span><span class="n">df_gga</span> <span class="o">=</span> <span class="n">df_gga</span><span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">'Time'</span><span class="p">:</span> <span class="s">'Timestamp'</span><span class="p">})</span>
<span class="n">df_gga</span> <span class="o">=</span> <span class="n">df_gga</span><span class="p">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'Timestamp'</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Time range: </span><span class="si">{</span><span class="n">df_gga</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nb">min</span><span class="p">()</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">df_gga</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nb">max</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"check the last five rows of the table to see if we really removed the non-data part"</span><span class="p">)</span>
<span class="n">df_gga</span><span class="p">.</span><span class="n">tail</span><span class="p">()</span>
</code></pre></div></div> <h3 id="putting-it-all-together"> <a href="#putting-it-all-together" class="anchor-heading" aria-labelledby="putting-it-all-together"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Putting It All Together </h3> <p>Now let’s wrap everything into a reusable function:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">load_gga_data</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="s">"""
    Load CH4/CO2 data from a Los Gatos GGA analyzer file.
    
    Parameters:
        filepath: Path to the GGA .txt file
        
    Returns:
        DataFrame with DatetimeIndex
    """</span>
    <span class="c1"># Step 1: Read CSV, skip metadata header
</span>    <span class="n">df_gga</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="n">filepath</span><span class="p">,</span>
        <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">skipinitialspace</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span>
    <span class="n">df_gga</span><span class="p">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df_gga</span><span class="p">.</span><span class="n">columns</span><span class="p">.</span><span class="nb">str</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
    
    <span class="c1"># Step 2: Filter to valid data rows using regex
</span>    <span class="c1"># Pattern: optional whitespace, then MM/DD/YYYY date format
</span>    <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">df_gga</span><span class="p">[</span><span class="s">'Time'</span><span class="p">].</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">).</span><span class="nb">str</span><span class="p">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s">'^\s*\d{2}/\d{2}/\d{4}'</span><span class="p">)</span>
    <span class="n">df_gga</span> <span class="o">=</span> <span class="n">df_gga</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">].</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># Step 3: Parse timestamps and set as index
</span>    <span class="n">df_gga</span><span class="p">[</span><span class="s">'Time'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_gga</span><span class="p">[</span><span class="s">'Time'</span><span class="p">].</span><span class="nb">str</span><span class="p">.</span><span class="n">strip</span><span class="p">(),</span> <span class="nb">format</span><span class="o">=</span><span class="s">'%m/%d/%Y %H:%M:%S.%f'</span><span class="p">)</span>
    <span class="n">df_gga</span> <span class="o">=</span> <span class="n">df_gga</span><span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">'Time'</span><span class="p">:</span> <span class="s">'Timestamp'</span><span class="p">})</span>
    <span class="n">df_gga</span> <span class="o">=</span> <span class="n">df_gga</span><span class="p">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'Timestamp'</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df_gga</span>
</code></pre></div></div> <p>Let’s test it:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_gga</span> <span class="o">=</span> <span class="n">load_gga_data</span><span class="p">(</span><span class="s">"./BAI_StudyProject_LuentenerWald/raw_data/GGA/gga_2025-08-15_f0000.txt"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_gga</span><span class="p">)</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="s"> rows"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Time range: </span><span class="si">{</span><span class="n">df_gga</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nb">min</span><span class="p">()</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">df_gga</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nb">max</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="n">df_gga</span><span class="p">.</span><span class="n">tail</span><span class="p">()</span>
</code></pre></div></div> <h3 id="13-loading-multiple-files"> <a href="#13-loading-multiple-files" class="anchor-heading" aria-labelledby="13-loading-multiple-files"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1.3 Loading Multiple Files </h3> <p>Now that we have loader functions, we can easily handle data from multiple field trips (data were measured on 06, 15 and 26th Aug). Instead of copying code, we can simply iterate data files and apply our function on files. First, we create a list of all the file paths we want to load. Then, we can loop through this list, call our function for each path, and store the resulting DataFrames in a new list.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># First, let's list all the files we want to load.
# Make sure the file paths are complete and correct.
</span><span class="n">base_path</span> <span class="o">=</span> <span class="s">"./BAI_StudyProject_LuentenerWald/raw_data/"</span>
<span class="n">n2o_files</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'N2O/TG20-01072-2025-08-15T110000.data.txt'</span><span class="p">,</span>
    <span class="s">'N2O/TG20-01072-2025-08-26T093000.data.txt'</span>
<span class="p">]</span>

<span class="n">gga_files</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'GGA/gga_2025-08-15_f0000.txt'</span><span class="p">,</span>
    <span class="s">'GGA/gga_2025-08-06_f0000.txt'</span><span class="p">,</span>
    <span class="s">'GGA/gga_2025-08-26_f0000.txt'</span>
<span class="p">]</span>

<span class="c1"># Create the full file paths
</span><span class="n">n2o_full_file_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_path</span> <span class="o">+</span> <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">n2o_files</span><span class="p">]</span>
<span class="n">gga_full_file_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_path</span> <span class="o">+</span> <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">gga_files</span><span class="p">]</span>

<span class="c1"># Create an empty list to hold the loaded DataFrames
</span><span class="n">n2o_data_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">gga_data_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Loop through each path, load the data, and append it to our list
</span><span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">n2o_full_file_paths</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">load_n2o_data</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">n2o_data_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Successfully loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">n2o_data_list</span><span class="p">)</span><span class="si">}</span><span class="s"> N2O data files."</span><span class="p">)</span>

<span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">gga_full_file_paths</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">load_gga_data</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">gga_data_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Successfully loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gga_data_list</span><span class="p">)</span><span class="si">}</span><span class="s"> GGA data files."</span><span class="p">)</span>
</code></pre></div></div> <p>The loop above is clear and correct. However, a more concise way to write this in Python is with a list comprehension. It achieves the exact same result in a single, readable line:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">n2o_data_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">load_n2o_data</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">n2o_full_file_paths</span><span class="p">]</span>
<span class="n">gga_data_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">load_gga_data</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">gga_full_file_paths</span><span class="p">]</span>
</code></pre></div></div> <p>For our flux calculations to be accurate, we need more than just gas concentrations. The Ideal Gas Law, which is the basis of the calculation, requires the temperature and air pressure at the time of each measurement. We will use the same workflow as before: load each file and then combine them.</p> <div style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 5px;"> <div class="notice--primary"> <h3 id="exercise"> <a href="#exercise" class="anchor-heading" aria-labelledby="exercise"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exercise </h3> <p>You have three Excel files containing air temperature. Create lists of the file paths for the temperature data. Load each Excel file into a pandas DataFrame. Try using a list comprehension as we learned before!</p> <details> <summary>Click here for the solution!</summary> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># the base path is the same as before
</span><span class="n">base_path</span> <span class="o">=</span> <span class="s">"./BAI_StudyProject_LuentenerWald/raw_data/Ta/"</span>

<span class="c1"># --- Load Air Temperature Data ---
</span><span class="n">file_names_Ta</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'Haube 2025-08-06 15_24_26 CEST (Data CEST).xlsx'</span><span class="p">,</span> 
    <span class="s">'Haube 2025-08-15 15_22_46 CEST (Data CEST).xlsx'</span> <span class="p">,</span>
    <span class="s">'Haube 2025-08-26 14_58_20 MESZ (Data MESZ).xlsx'</span>
<span class="p">]</span>
<span class="n">full_file_paths_Ta</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_path</span> <span class="o">+</span> <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">file_names_Ta</span><span class="p">]</span>
<span class="n">ta_data_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="p">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">full_file_paths_Ta</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Successfully loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ta_data_list</span><span class="p">)</span><span class="si">}</span><span class="s"> air temperature files."</span><span class="p">)</span>
</code></pre></div> </div> </details> </div> </div> <h3 id="14-concatenating-and-merging-all-data"> <a href="#14-concatenating-and-merging-all-data" class="anchor-heading" aria-labelledby="14-concatenating-and-merging-all-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1.4 Concatenating and Merging All Data </h3> <p>Now we will combine everything into one master DataFrame. Understanding our data structure is important:</p> <ul> <li><strong>Gas measurements (N₂O, CH₄, CO₂):</strong> Recorded at different times. It doesn’t matter if they overlap in time, we simply need to stack them together.</li> <li><strong>Temperature data:</strong> Recorded continuously and DOES overlap with all gas measurements. We need to match each gas reading with its corresponding temperature.</li> </ul> <p>This means our workflow is:</p> <ol> <li><strong>Concatenate</strong> all gas data files into one DataFrame (stacking rows)</li> <li><strong>Merge</strong> temperature into the gas data using time-matching</li> </ol> <h3 id="concatenate-gas-data-from-all-files"> <a href="#concatenate-gas-data-from-all-files" class="anchor-heading" aria-labelledby="concatenate-gas-data-from-all-files"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Concatenate Gas Data from All Files </h3> <p>First, let’s combine files from differnt filed trip of the same type (gga, n2o and temperature) into one dataframe:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Concatenate N2O data from multiple files
</span><span class="n">df_n2o</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span><span class="n">n2o_data_list</span><span class="p">)</span>
<span class="n">df_n2o</span> <span class="o">=</span> <span class="n">df_n2o</span><span class="p">.</span><span class="n">sort_index</span><span class="p">()</span>

<span class="c1"># Concatenate GGA data (CH4 and CO2) from multiple files
</span><span class="n">df_gga</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span><span class="n">gga_data_list</span><span class="p">)</span>
<span class="n">df_gga</span> <span class="o">=</span> <span class="n">df_gga</span><span class="p">.</span><span class="n">sort_index</span><span class="p">()</span>

<span class="c1"># Concatenate and format temperature data
</span><span class="n">df_Ta</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span><span class="n">ta_data_list</span><span class="p">)</span>
<span class="n">df_Ta</span><span class="p">[</span><span class="s">'Timestamp'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_Ta</span><span class="p">[</span><span class="s">'Date-Time (CEST)'</span><span class="p">])</span>
<span class="c1"># Rename temperature column
</span><span class="n">df_Ta</span><span class="p">[</span><span class="s">'Ta_C'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_Ta</span><span class="p">[</span><span class="s">'Temperature , °C'</span><span class="p">]</span>
<span class="n">df_Ta</span> <span class="o">=</span> <span class="n">df_Ta</span><span class="p">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'Timestamp'</span><span class="p">)</span>
<span class="n">df_Ta</span> <span class="o">=</span> <span class="n">df_Ta</span><span class="p">.</span><span class="n">sort_index</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">"--- N2O DataFrame ---"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Rows: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_n2o</span><span class="p">)</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="s">, Time range: </span><span class="si">{</span><span class="n">df_n2o</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nb">min</span><span class="p">()</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">df_n2o</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nb">max</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">--- GGA DataFrame (CH4/CO2) ---"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Rows: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_gga</span><span class="p">)</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="s">, Time range: </span><span class="si">{</span><span class="n">df_gga</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nb">min</span><span class="p">()</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">df_gga</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nb">max</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">--- Temperature DataFrame ---"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Rows: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_Ta</span><span class="p">)</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="s">, Time range: </span><span class="si">{</span><span class="n">df_Ta</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nb">min</span><span class="p">()</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">df_Ta</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nb">max</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div> <h3 id="combine-all-gas-data-into-one-master-table"> <a href="#combine-all-gas-data-into-one-master-table" class="anchor-heading" aria-labelledby="combine-all-gas-data-into-one-master-table"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Combine All Gas Data into One Master Table </h3> <p>Since N₂O and CH₄/CO₂ measurements don’t overlap in time, we can safely stack them together. First, we need to select and rename columns so they’re consistent:</p> <p>When selecting columns from the GGA data, you’ll notice two versions of each gas measurement:</p> <ul> <li><code class="language-plaintext highlighter-rouge">[CH4]_ppm</code> — Raw (wet) concentration</li> <li><code class="language-plaintext highlighter-rouge">[CH4]d_ppm</code> — Dry-corrected concentration</li> </ul> <p><strong>What’s the difference?</strong></p> <p>The air inside your chamber contains water vapor. This water vapor <strong>dilutes</strong> the sample, it takes up space that would otherwise be occupied by other gas molecules. The raw <code class="language-plaintext highlighter-rouge">[CH4]_ppm</code> value measures CH₄ as a fraction of the <strong>total air (including water vapor)</strong>.</p> <p>The problem: humidity varies between measurements! A humid day will show artificially lower CH₄ concentrations simply because more of the sample is water.</p> <p><strong>The solution: Dry correction</strong></p> <p>The analyzer also measures water vapor content <code class="language-plaintext highlighter-rouge">[H2O]_ppm</code>. It then calculates what the concentration <strong>would be</strong> if there were no water vapor present:</p> \[[\text{CH}_4]_{\text{dry}} = \frac{[\text{CH}_4]_{\text{wet}}}{1 - \frac{[\text{H}_2\text{O}]}{10^6}}\] <blockquote> <p><strong>Rule:</strong> Always use <strong>dry-corrected values</strong> (<code class="language-plaintext highlighter-rouge">_d_ppm</code>) for flux calculations. This ensures your measurements are comparable across different humidity conditions.</p> </blockquote> <blockquote> <p><strong>Note:</strong> N₂O data from the LI-7820 analyzer is already reported as dry mole fraction, so no additional correction is needed.</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Select key columns from N2O data
</span><span class="n">df_n2o_clean</span> <span class="o">=</span> <span class="n">df_n2o</span><span class="p">[[</span><span class="s">'N2O'</span><span class="p">]].</span><span class="n">copy</span><span class="p">()</span>
<span class="c1"># Rename the column with unit
</span><span class="n">df_n2o_clean</span><span class="p">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">'N2O_ppb'</span><span class="p">]</span>

<span class="c1"># Select key columns from GGA data (dry-corrected values)
</span><span class="n">df_gga_clean</span> <span class="o">=</span> <span class="n">df_gga</span><span class="p">[[</span><span class="s">'[CH4]d_ppm'</span><span class="p">,</span> <span class="s">'[CO2]d_ppm'</span><span class="p">]].</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_gga_clean</span><span class="p">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">'CH4_ppm'</span><span class="p">,</span> <span class="s">'CO2_ppm'</span><span class="p">]</span>

<span class="c1"># Stack them together - rows from different time periods
</span><span class="n">df_gas</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_n2o_clean</span><span class="p">,</span> <span class="n">df_gga_clean</span><span class="p">])</span>
<span class="n">df_gas</span> <span class="o">=</span> <span class="n">df_gas</span><span class="p">.</span><span class="n">sort_index</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Combined gas DataFrame: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_gas</span><span class="p">)</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="s"> rows"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Time range: </span><span class="si">{</span><span class="n">df_gas</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nb">min</span><span class="p">()</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">df_gas</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nb">max</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="n">df_gas</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div> <p>Notice that each row will have values in either <code class="language-plaintext highlighter-rouge">N2O_ppb</code> OR <code class="language-plaintext highlighter-rouge">CH4_ppm</code>/<code class="language-plaintext highlighter-rouge">CO2_ppm</code>, but not both—because the measurements were taken at different times:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Check the structure
</span><span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Sample from N2O measurement period:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_gas</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_gas</span><span class="p">[</span><span class="s">'N2O_ppb'</span><span class="p">].</span><span class="n">notna</span><span class="p">()].</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Sample from CH4/CO2 measurement period:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_gas</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_gas</span><span class="p">[</span><span class="s">'CH4_ppm'</span><span class="p">].</span><span class="n">notna</span><span class="p">()].</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</code></pre></div></div> <h3 id="merge-temperature-with-gas-data"> <a href="#merge-temperature-with-gas-data" class="anchor-heading" aria-labelledby="merge-temperature-with-gas-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Merge Temperature with Gas Data </h3> <p>The gas analyzers record data every second, while the weather station might record only every minute. A simple merge would leave many empty rows. The solution is <code class="language-plaintext highlighter-rouge">pd.merge_asof()</code>, which performs a “nearest-neighbor” merge. It is ideal for combining time-series data with different frequencies.</p> <blockquote> <p><strong>Note:</strong> pd.merge() performs exact matches and links rows only when keys are identical, whereas pd.merge_asof() performs approximate matches, finding the closest prior key in the second DataFrame to the key in the first. While pd.merge() is a general-purpose tool for relational data that works regardless of order, pd.merge_asof() is specialized for time-series data (or other ordered data) where timestamps might not align perfectly; consequently, pd.merge_asof() strictly requires the join keys to be sorted to function correctly.</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Reset index for merge_asof (requires sorted column, not index)
</span><span class="n">df_gas_reset</span> <span class="o">=</span> <span class="n">df_gas</span><span class="p">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df_Ta_reset</span> <span class="o">=</span> <span class="n">df_Ta</span><span class="p">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="c1"># Merge gas data with temperature
# direction='backward' means: for each gas reading, find the most recent temperature
</span><span class="n">df_merged</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">merge_asof</span><span class="p">(</span>
    <span class="n">df_gas_reset</span><span class="p">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s">'Timestamp'</span><span class="p">),</span>
    <span class="n">df_Ta_reset</span><span class="p">[[</span><span class="s">'Timestamp'</span><span class="p">,</span> <span class="s">'Ta_C'</span><span class="p">]].</span><span class="n">sort_values</span><span class="p">(</span><span class="s">'Timestamp'</span><span class="p">),</span>
    <span class="n">on</span><span class="o">=</span><span class="s">'Timestamp'</span><span class="p">,</span>
    <span class="n">direction</span><span class="o">=</span><span class="s">'backward'</span>
<span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Merged DataFrame: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_merged</span><span class="p">)</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="s"> rows"</span><span class="p">)</span>
<span class="n">df_merged</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div> <h3 id="final-master-dataframe"> <a href="#final-master-dataframe" class="anchor-heading" aria-labelledby="final-master-dataframe"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Final Master DataFrame </h3> <p>Let’s verify our final dataset:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">"--- Master DataFrame ---"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Total rows: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_merged</span><span class="p">)</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Time range: </span><span class="si">{</span><span class="n">df_merged</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nb">min</span><span class="p">()</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">df_merged</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nb">max</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Columns: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">df_merged</span><span class="p">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">--- Sample rows with N2O data ---"</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="n">display</span><span class="p">(</span><span class="n">df_merged</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_merged</span><span class="p">[</span><span class="s">'N2O_ppb'</span><span class="p">].</span><span class="n">notna</span><span class="p">()].</span><span class="n">head</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">--- Sample rows with CH4/CO2 data ---"</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">df_merged</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_merged</span><span class="p">[</span><span class="s">'CH4_ppm'</span><span class="p">].</span><span class="n">notna</span><span class="p">()].</span><span class="n">head</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
</code></pre></div></div> <p>The master DataFrame now contains:</p> <ul> <li><code class="language-plaintext highlighter-rouge">N2O_ppb</code>: N₂O concentration (only during N₂O measurement periods)</li> <li><code class="language-plaintext highlighter-rouge">CH4_ppm</code>: CH₄ concentration (only during GGA measurement periods)</li> <li><code class="language-plaintext highlighter-rouge">CO2_ppm</code>: CO₂ concentration (only during GGA measurement periods)</li> <li><code class="language-plaintext highlighter-rouge">Ta_C</code>: Air temperature (matched to each gas reading)</li> </ul> <h2 id="2-visualizing-and-cleaning-the-data"> <a href="#2-visualizing-and-cleaning-the-data" class="anchor-heading" aria-labelledby="2-visualizing-and-cleaning-the-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. Visualizing and Cleaning the Data </h2> <p>Now that we have a single, merged DataFrame, our next step is to inspect the data quality. Raw sensor data from the field is almost never perfect. Visualizing it is the best way to diagnose issues like noise, drift, or outliers before we attempt any calculations.</p> <h3 id="21-creating-a-reusable-plotting-function-with-plotly"> <a href="#21-creating-a-reusable-plotting-function-with-plotly" class="anchor-heading" aria-labelledby="21-creating-a-reusable-plotting-function-with-plotly"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2.1 Creating a Reusable Plotting Function with Plotly </h3> <p>For visualization, we’ll use <strong>Plotly</strong>, a powerful library for creating interactive plots. Unlike static plots from Matplotlib, Plotly allows you to zoom, pan, and hover over data points—perfect for inspecting time-series data. Just as we did with data loading, we’ll be plotting our time-series data many times. To make this efficient and keep our plots looking consistent, let’s create a dedicated function.</p> <div style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 5px;"> <div class="notice--primary"> <h3 id="exercise"> <a href="#exercise" class="anchor-heading" aria-labelledby="exercise"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exercise </h3> <p>The plotting function is partly provided below. Complete the function by filling in the <code class="language-plaintext highlighter-rouge">add_trace()</code> and <code class="language-plaintext highlighter-rouge">update_layout()</code> calls!</p> <p><strong>Hints:</strong></p> <ul> <li>Use <code class="language-plaintext highlighter-rouge">go.Scatter()</code> for the trace with <code class="language-plaintext highlighter-rouge">x=</code>, <code class="language-plaintext highlighter-rouge">y=</code>, <code class="language-plaintext highlighter-rouge">mode=</code>, and <code class="language-plaintext highlighter-rouge">name=</code> parameters</li> <li>The layout should include <code class="language-plaintext highlighter-rouge">title</code>, <code class="language-plaintext highlighter-rouge">xaxis_title</code>, <code class="language-plaintext highlighter-rouge">yaxis_title</code>, and <code class="language-plaintext highlighter-rouge">template</code></li> </ul> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="n">go</span>
<span class="kn">import</span> <span class="nn">plotly.io</span> <span class="k">as</span> <span class="n">pio</span>

<span class="c1"># This setting forces Plotly to open plots in your default web browser
</span><span class="n">pio</span><span class="p">.</span><span class="n">renderers</span><span class="p">.</span><span class="n">default</span> <span class="o">=</span> <span class="s">"browser"</span>

<span class="k">def</span> <span class="nf">plot_time_series</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">y_column</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'lines'</span><span class="p">):</span>
    <span class="s">"""
    Generates an interactive time-series plot using Plotly.

    Parameters:
    - df (pd.DataFrame): DataFrame with a DatetimeIndex.
    - y_column (str): The name of the column to plot on the y-axis.
    - title (str): The title for the plot.
    - mode (str): Plotly mode ('lines', 'markers', or 'lines+markers').
    """</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="p">.</span><span class="n">Figure</span><span class="p">()</span>

    <span class="n">fig</span><span class="p">.</span><span class="n">add_trace</span><span class="p">(...)</span>  <span class="c1"># TODO: Add a Scatter trace
</span>
    <span class="n">fig</span><span class="p">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="p">...</span>  <span class="c1"># TODO: Set title, axis labels, and template
</span>    <span class="p">)</span>
    
    <span class="n">fig</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div> <details> <summary>Click here for the solution!</summary> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="n">go</span>
<span class="kn">import</span> <span class="nn">plotly.io</span> <span class="k">as</span> <span class="n">pio</span>

<span class="c1"># This setting forces Plotly to open plots in your default web browser,
# which can be more stable in some environments.
</span><span class="n">pio</span><span class="p">.</span><span class="n">renderers</span><span class="p">.</span><span class="n">default</span> <span class="o">=</span> <span class="s">"browser"</span>

<span class="k">def</span> <span class="nf">plot_time_series</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">y_column</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'lines'</span><span class="p">):</span>
    <span class="s">"""
    Generates an interactive time-series plot using Plotly.
    This function will automatically try to set a 'Timestamp' column as the 
    index if the existing index is not a datetime type.

    Parameters:
    - df (pd.DataFrame): DataFrame to plot.
    - y_column (str): The name of the column to plot on the y-axis.
    - title (str): The title for the plot.
    - mode (str): Plotly mode ('lines', 'markers', or 'lines+markers').
    """</span>
    <span class="c1"># --- Input Validation and Auto-Correction ---
</span>    
    <span class="c1"># Work on a copy to avoid changing the user's original DataFrame
</span>    <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">types</span><span class="p">.</span><span class="n">is_datetime64_any_dtype</span><span class="p">(</span><span class="n">df_plot</span><span class="p">.</span><span class="n">index</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Note: The DataFrame index is not a DatetimeIndex."</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">'Timestamp'</span> <span class="ow">in</span> <span class="n">df_plot</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"--&gt; Found a 'Timestamp' column. Setting it as the index."</span><span class="p">)</span>
            <span class="n">df_plot</span><span class="p">[</span><span class="s">'Timestamp'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_plot</span><span class="p">[</span><span class="s">'Timestamp'</span><span class="p">])</span>
            <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df_plot</span><span class="p">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'Timestamp'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">TypeError</span><span class="p">(</span>
                <span class="s">"The DataFrame index is not a DatetimeIndex and a 'Timestamp' "</span>
                <span class="s">"column was not found. Please set a DatetimeIndex before plotting."</span>
            <span class="p">)</span>
            
    <span class="c1"># --- Plotting ---
</span>    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="p">.</span><span class="n">Figure</span><span class="p">()</span>

    <span class="n">fig</span><span class="p">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="p">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">df_plot</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> 
        <span class="n">y</span><span class="o">=</span><span class="n">df_plot</span><span class="p">[</span><span class="n">y_column</span><span class="p">],</span> 
        <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> 
        <span class="n">name</span><span class="o">=</span><span class="n">y_column</span>
    <span class="p">))</span>

    <span class="c1"># Update layout for a clean, professional look
</span>    <span class="n">fig</span><span class="p">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> 
        <span class="n">xaxis_title</span><span class="o">=</span><span class="s">'Time'</span><span class="p">,</span> 
        <span class="n">yaxis_title</span><span class="o">=</span><span class="n">y_column</span><span class="p">,</span> 
        <span class="n">template</span><span class="o">=</span><span class="s">'plotly_white'</span><span class="p">,</span> 
        <span class="n">title_font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">24</span><span class="p">),</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">tickfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span> <span class="n">title_font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)),</span> 
        <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">tickfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span> <span class="n">title_font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">))</span>
    <span class="p">)</span>
    
    <span class="n">fig</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div> </div> </details> </div> </div> <h3 id="22-visualizing-the-raw-gas-data"> <a href="#22-visualizing-the-raw-gas-data" class="anchor-heading" aria-labelledby="22-visualizing-the-raw-gas-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2.2 Visualizing the Raw Gas Data </h3> <p>Now, let’s use our new function to look at the raw N₂O data. The interactive plot allows you to zoom and pan to inspect noisy areas.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1. Ensure Timestamp is the index and sorted
# Only set index if 'Timestamp' is currently a column
</span><span class="k">if</span> <span class="s">'Timestamp'</span> <span class="ow">in</span> <span class="n">df_merged</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">df_merged</span> <span class="o">=</span> <span class="n">df_merged</span><span class="p">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'Timestamp'</span><span class="p">)</span>

<span class="n">df_merged</span> <span class="o">=</span> <span class="n">df_merged</span><span class="p">.</span><span class="n">sort_index</span><span class="p">()</span>

<span class="c1"># 2. Select where N2O has valid values (Drop NaNs), we also need the temperature column for flux calculation later on
</span><span class="n">df_N2O</span> <span class="o">=</span> <span class="n">df_merged</span><span class="p">[[</span><span class="s">'N2O_ppb'</span><span class="p">,</span> <span class="s">'Ta_C'</span><span class="p">]].</span><span class="n">dropna</span><span class="p">()</span> 

<span class="c1"># 3. Plot
</span><span class="n">plot_time_series</span><span class="p">(</span>
    <span class="n">df_N2O</span><span class="p">,</span> 
    <span class="n">y_column</span><span class="o">=</span><span class="s">'N2O_ppb'</span><span class="p">,</span> 
    <span class="n">title</span><span class="o">=</span><span class="s">'N₂O Concentration'</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s">'markers'</span>
<span class="p">)</span>
</code></pre></div></div> <p><img src="/New_BAI_DataAnalysis/assets/images/python/5/raw_data_plot.png" alt="raw data plotting" /></p> <p><strong>What do we see?</strong></p> <p>The raw data is very noisy! There are several problems:</p> <ul> <li><strong>Negative values</strong>: Physically impossible for gas concentrations</li> <li><strong>Extreme spikes</strong>: Values far outside the expected range</li> <li><strong>Sensor noise</strong>: Random fluctuations due to electrical interference</li> </ul> <p>These artifacts are common in field measurements and must be removed before we can calculate meaningful fluxes.</p> <h3 id="23-filtering-with-a-quantile-filter"> <a href="#23-filtering-with-a-quantile-filter" class="anchor-heading" aria-labelledby="23-filtering-with-a-quantile-filter"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2.3 Filtering with a Quantile Filter </h3> <p>To remove outliers, we’ll use a <strong>quantile filter</strong>, it can help us see the real data patterns (signal) by removing all outliers/noise. This method calculates percentiles of the data and keeps only values within a specified range.</p> <h3 id="why-quantile-filtering"> <a href="#why-quantile-filtering" class="anchor-heading" aria-labelledby="why-quantile-filtering"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Why Quantile Filtering? </h3> <p>Quantile filtering is <strong>robust to outliers</strong>. Unlike methods based on mean and standard deviation, extreme values have very little influence on percentile calculations. This makes it ideal for sensor data with occasional spikes.</p> <p>The approach:</p> <ol> <li>Calculate the 3th percentile ($P_{3}$) and 97th percentile ($P_{97}$)</li> <li>Keep only data points where: $P_{3} \leq x \leq P_{97}$</li> <li>Discard everything else</li> </ol> <blockquote> <p><strong>Info: What are Quantiles?</strong></p> <p>A <strong>quantile</strong> divides your data into equal-sized groups. Common examples:</p> <ul> <li><strong>Median</strong> (50th percentile): Half the data is below, half is above</li> <li><strong>Quartiles</strong>: Divide data into 4 parts (25th, 50th, 75th percentiles)</li> <li><strong>Percentiles</strong>: Divide data into 100 parts</li> </ul> <p>The 10th percentile means “10% of values are below this point.”</p> <p><strong>Resources:</strong></p> <ul> <li><a href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.quantile.html">Pandas quantile() documentation</a></li> <li><a href="https://www.khanacademy.org/math/statistics-probability/summarizing-quantitative-data/percentile-rankings/v/calculating-percentile">Understanding Percentiles (Khan Academy)</a></li> </ul> </blockquote> <h3 id="applying-the-filter"> <a href="#applying-the-filter" class="anchor-heading" aria-labelledby="applying-the-filter"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Applying the Filter </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Calculate the 3rd and 97th percentiles
</span><span class="n">p_3</span> <span class="o">=</span> <span class="n">df_N2O</span><span class="p">[</span><span class="s">'N2O_ppb'</span><span class="p">].</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.03</span><span class="p">)</span>
<span class="n">p_97</span> <span class="o">=</span> <span class="n">df_N2O</span><span class="p">[</span><span class="s">'N2O_ppb'</span><span class="p">].</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.97</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"3rd percentile:  </span><span class="si">{</span><span class="n">p_3</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> ppb"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"97th percentile: </span><span class="si">{</span><span class="n">p_97</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> ppb"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Keeping data in range [</span><span class="si">{</span><span class="n">p_3</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">p_97</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">]"</span><span class="p">)</span>

<span class="c1"># Apply the filter
</span><span class="n">df_filtered</span> <span class="o">=</span> <span class="n">df_N2O</span><span class="p">[</span>
    <span class="p">(</span><span class="n">df_N2O</span><span class="p">[</span><span class="s">'N2O_ppb'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">p_3</span><span class="p">)</span> <span class="o">&amp;</span> 
    <span class="p">(</span><span class="n">df_N2O</span><span class="p">[</span><span class="s">'N2O_ppb'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">p_97</span><span class="p">)</span>
<span class="p">].</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Calculate statistics based on the N2O dataframe, not the merged one
</span><span class="n">n_raw</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_N2O</span><span class="p">)</span>
<span class="n">n_clean</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_filtered</span><span class="p">)</span>
<span class="n">n_removed</span> <span class="o">=</span> <span class="n">n_raw</span> <span class="o">-</span> <span class="n">n_clean</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Valid rows before filtering: </span><span class="si">{</span><span class="n">n_raw</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Rows after filtering:        </span><span class="si">{</span><span class="n">n_clean</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Outliers removed:            </span><span class="si">{</span><span class="n">n_removed</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="p">(</span><span class="n">n_removed</span><span class="o">/</span><span class="n">n_raw</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">%)"</span><span class="p">)</span>
</code></pre></div></div> <p>Now let’s visualize the filtered data:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Plot filtered data using markers to see individual points
</span><span class="n">plot_time_series</span><span class="p">(</span>
    <span class="n">df_filtered</span><span class="p">,</span> 
    <span class="n">y_column</span><span class="o">=</span><span class="s">'N2O_ppb'</span><span class="p">,</span> 
    <span class="n">title</span><span class="o">=</span><span class="s">'Filtered N₂O Concentration Over Time'</span><span class="p">,</span> 
    <span class="n">mode</span><span class="o">=</span><span class="s">'markers'</span>
<span class="p">)</span>
</code></pre></div></div> <p><img src="/New_BAI_DataAnalysis/assets/images/python/5/filtered_N2O.png" alt="Filtered N2O" /></p> <p>This looks much better! The noise is gone, now please pan and zoom in to check the N2O data measured on 15th and 26th of Aug. You can see a clear, meaningful pattern.</p> <p><strong>filtered N2O data on <code class="language-plaintext highlighter-rouge">08-15</code></strong></p> <p><img src="/New_BAI_DataAnalysis/assets/images/python/5/Filtered_N2O_0815.png" alt="Filtered_N2O_0815" /></p> <p><strong>filtered N2O data on <code class="language-plaintext highlighter-rouge">08-26</code></strong></p> <p><img src="/New_BAI_DataAnalysis/assets/images/python/5/Filtered_N2O_0826.png" alt="Filtered_N2O_0826" /></p> <h3 id="24-understanding-the-data-pattern"> <a href="#24-understanding-the-data-pattern" class="anchor-heading" aria-labelledby="24-understanding-the-data-pattern"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2.4 Understanding the Data Pattern </h3> <p>The filtered data reveals a repeating pattern characteristic of the <strong>static chamber method</strong>. Let’s break down what we’re seeing:</p> <div class="table-wrapper"><table> <thead> <tr> <th>Phase</th> <th>What’s Happening</th> <th>What You See in the Plot</th> </tr> </thead> <tbody> <tr> <td><strong>1. Baseline</strong></td> <td>Chamber is open, sensor measures ambient air</td> <td>Long, flat periods at ~background concentration</td> </tr> <tr> <td><strong>2. Accumulation</strong></td> <td>Chamber closed over soil, gases accumulate</td> <td>Steady, linear increase in concentration</td> </tr> <tr> <td><strong>3. Release</strong></td> <td>Chamber lifted, gases escape</td> <td>Sharp vertical drop back to baseline</td> </tr> <tr> <td><strong>4. Leveling off</strong></td> <td>(If chamber left too long) Soil-air gradient decreases</td> <td>Rate of increase slows, curve flattens</td> </tr> </tbody> </table></div> <h3 id="the-critical-insight-linear-increase"> <a href="#the-critical-insight-linear-increase" class="anchor-heading" aria-labelledby="the-critical-insight-linear-increase"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The Critical Insight: Linear Increase </h3> <p>The <strong>rate of concentration increase</strong> during the accumulation phase is what we use to calculate flux. Mathematically:</p> \[\text{Flux} \propto \frac{dC}{dt}\] <p>Where:</p> <ul> <li>$C$ = gas concentration inside the chamber</li> <li>$t$ = time</li> <li>$\frac{dC}{dt}$ = rate of change (slope of the linear portion)</li> </ul> <blockquote> <p><strong>Important: Use Only the Linear Portion</strong></p> <p>If a chamber is left on the ground too long, gas buildup inside the chamber reduces the concentration gradient between soil and chamber air. This causes the accumulation rate to slow down (“leveling off”).</p> <p>For accurate flux calculations, we must identify and use <strong>only the initial, linear part</strong> of each accumulation period. We’ll learn how to do this in the next section.</p> </blockquote> <p>The same visualization and filtering workflow applies to the GGA data (CH₄ and CO₂). But does the GGA data actually need filtering? Let’s find out!</p> <div style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 5px;"> <div class="notice--primary"> <h3 id="exercise-inspect-and-clean-the-gga-data"> <a href="#exercise-inspect-and-clean-the-gga-data" class="anchor-heading" aria-labelledby="exercise-inspect-and-clean-the-gga-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exercise: Inspect and Clean the GGA Data </h3> <p><strong>Part 1: Visualize the raw data</strong></p> <p>First, plot the raw CH₄ and CO₂ data to see if they contain noise or outliers.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Plot raw CH4 data
</span><span class="n">plot_time_series</span><span class="p">(</span>
    <span class="n">df_merged</span><span class="p">[</span><span class="n">df_merged</span><span class="p">[</span><span class="s">'CH4_ppm'</span><span class="p">].</span><span class="n">notna</span><span class="p">()],</span> 
    <span class="n">y_column</span><span class="o">=</span><span class="s">'CH4_ppm'</span><span class="p">,</span> 
    <span class="n">title</span><span class="o">=</span><span class="s">'Raw CH₄ Concentration Over Time'</span><span class="p">,</span> 
    <span class="n">mode</span><span class="o">=</span><span class="s">'markers'</span>
<span class="p">)</span>

<span class="c1"># Plot raw CO2 data
</span><span class="n">plot_time_series</span><span class="p">(</span>
    <span class="n">df_merged</span><span class="p">[</span><span class="n">df_merged</span><span class="p">[</span><span class="s">'CO2_ppm'</span><span class="p">].</span><span class="n">notna</span><span class="p">()],</span> 
    <span class="n">y_column</span><span class="o">=</span><span class="s">'CO2_ppm'</span><span class="p">,</span> 
    <span class="n">title</span><span class="o">=</span><span class="s">'Raw CO₂ Concentration Over Time'</span><span class="p">,</span> 
    <span class="n">mode</span><span class="o">=</span><span class="s">'markers'</span>
<span class="p">)</span>
</code></pre></div></div> <p><strong>Questions to consider:</strong></p> <ol> <li>Do you see any obvious outliers or impossible values (like negative concentrations)?</li> <li>Are there extreme spikes that look like sensor errors?</li> <li>Use the zoom and pan features to inspect different time periods.</li> </ol> <p><strong>Part 2: Decide on filtering</strong></p> <p>Based on your visual inspection:</p> <ul> <li><strong>If the data looks clean:</strong> No filtering needed! Move on to the next section.</li> <li><strong>If the data contains outliers:</strong> Apply a quantile filter like we did for N₂O.</li> </ul> <p><strong>Part 3: Apply filtering (if needed)</strong></p> <p>If you determined that filtering is necessary, apply the quantile filter to CH₄ and CO₂.</p> <p><strong>Hints:</strong></p> <ul> <li>Use <code class="language-plaintext highlighter-rouge">.quantile(0.03)</code> and <code class="language-plaintext highlighter-rouge">.quantile(0.97)</code> to get the 10th and 90th percentiles</li> </ul> <details> <summary>Click here for the solution!</summary> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1. Create clean copies for CH4 and CO2 (removing NaNs first simplifies everything)
</span><span class="n">df_CH4</span> <span class="o">=</span> <span class="n">df_merged</span><span class="p">[[</span><span class="s">'CH4_ppm'</span><span class="p">]].</span><span class="n">dropna</span><span class="p">().</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_CO2</span> <span class="o">=</span> <span class="n">df_merged</span><span class="p">[[</span><span class="s">'CO2_ppm'</span><span class="p">]].</span><span class="n">dropna</span><span class="p">().</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># --- Filter CH4 data (3rd - 97th percentile) ---
</span><span class="n">ch4_p03</span> <span class="o">=</span> <span class="n">df_CH4</span><span class="p">[</span><span class="s">'CH4_ppm'</span><span class="p">].</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.03</span><span class="p">)</span>
<span class="n">ch4_p97</span> <span class="o">=</span> <span class="n">df_CH4</span><span class="p">[</span><span class="s">'CH4_ppm'</span><span class="p">].</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.97</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"CH4 filter range: [</span><span class="si">{</span><span class="n">ch4_p03</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">ch4_p97</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">] ppm"</span><span class="p">)</span>

<span class="c1"># Apply filter to the specific dataframe
</span><span class="n">df_CH4_clean</span> <span class="o">=</span> <span class="n">df_CH4</span><span class="p">[</span>
    <span class="p">(</span><span class="n">df_CH4</span><span class="p">[</span><span class="s">'CH4_ppm'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ch4_p03</span><span class="p">)</span> <span class="o">&amp;</span> 
    <span class="p">(</span><span class="n">df_CH4</span><span class="p">[</span><span class="s">'CH4_ppm'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ch4_p97</span><span class="p">)</span>
<span class="p">].</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># --- Filter CO2 data (3rd - 97th percentile) ---
</span><span class="n">co2_p03</span> <span class="o">=</span> <span class="n">df_CO2</span><span class="p">[</span><span class="s">'CO2_ppm'</span><span class="p">].</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.03</span><span class="p">)</span>
<span class="n">co2_p97</span> <span class="o">=</span> <span class="n">df_CO2</span><span class="p">[</span><span class="s">'CO2_ppm'</span><span class="p">].</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.97</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"CO2 filter range: [</span><span class="si">{</span><span class="n">co2_p03</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">co2_p97</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">] ppm"</span><span class="p">)</span>

<span class="c1"># Apply filter to the specific dataframe
</span><span class="n">df_CO2_clean</span> <span class="o">=</span> <span class="n">df_CO2</span><span class="p">[</span>
    <span class="p">(</span><span class="n">df_CO2</span><span class="p">[</span><span class="s">'CO2_ppm'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">co2_p03</span><span class="p">)</span> <span class="o">&amp;</span> 
    <span class="p">(</span><span class="n">df_CO2</span><span class="p">[</span><span class="s">'CO2_ppm'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">co2_p97</span><span class="p">)</span>
<span class="p">].</span><span class="n">copy</span><span class="p">()</span>
</code></pre></div> </div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plot_time_series</span><span class="p">(</span>
    <span class="n">df_CH4_clean</span><span class="p">,</span> 
    <span class="n">y_column</span><span class="o">=</span><span class="s">'CH4_ppm'</span><span class="p">,</span> 
    <span class="n">title</span><span class="o">=</span><span class="s">'Filtered CH₄ Concentration (3rd-97th Percentile)'</span><span class="p">,</span> 
    <span class="n">mode</span><span class="o">=</span><span class="s">'markers'</span> <span class="c1"># Markers are safer for high-frequency data
</span><span class="p">)</span>

<span class="c1"># Visualize the cleaned CO2 data
</span><span class="n">plot_time_series</span><span class="p">(</span>
    <span class="n">df_CO2_clean</span><span class="p">,</span> 
    <span class="n">y_column</span><span class="o">=</span><span class="s">'CO2_ppm'</span><span class="p">,</span> 
    <span class="n">title</span><span class="o">=</span><span class="s">'Filtered CO₂ Concentration (3rd-97th Percentile)'</span><span class="p">,</span> 
    <span class="n">mode</span><span class="o">=</span><span class="s">'markers'</span>
<span class="p">)</span>
</code></pre></div> </div> <p><strong>Note:</strong> Depending on your dataset, you may find that the GGA data is already quite clean and filtering removes very few points. This is because the Los Gatos GGA analyzer tends to produce more stable measurements than some other sensors. Always visualize first before deciding to filter!</p> </details> </div> </div> <h2 id="3-calculating-flux-for-a-single-measurement"> <a href="#3-calculating-flux-for-a-single-measurement" class="anchor-heading" aria-labelledby="3-calculating-flux-for-a-single-measurement"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. Calculating Flux for a Single Measurement </h2> <p>After loading and filtering our raw data and getting an overview of the patterns, it’s time to calculate the fluxes. Excited?</p> <p>In this section, we will focus on a <strong>single measurement period</strong> to understand the process in detail.</p> <h3 id="31-the-flux-calculation-formula"> <a href="#31-the-flux-calculation-formula" class="anchor-heading" aria-labelledby="31-the-flux-calculation-formula"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.1 The Flux Calculation Formula </h3> <p>Before we start coding, let’s understand the physics behind flux calculation.</p> <h4 id="what-is-flux"> <a href="#what-is-flux" class="anchor-heading" aria-labelledby="what-is-flux"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> What is “Flux”? </h4> <p>In the context of greenhouse gas research, <strong>flux</strong> refers to the exchange of gases between different parts of the Earth system, in our case, between the <strong>soil</strong> and the <strong>atmosphere</strong> inside our measurement chamber.</p> <blockquote> <p><strong>Learn More:</strong> <a href="https://climate.sustainability-directory.com/term/greenhouse-gas-fluxes/">Greenhouse Gas Fluxes - Sustainability Directory</a></p> </blockquote> <p>You might ask: <em>“Doesn’t the rate of concentration change (ΔC/t) already represent the flux?”</em></p> <p>Not quite! The raw concentration change rate (in ppb/s) is evidence of a flux, but it’s <strong>not standardized</strong>. It only describes what’s happening inside our specific chamber under specific conditions. We cannot compare measurements directly because:</p> <ul> <li><strong>Gas density varies with temperature and pressure</strong> — The same volume can contain different amounts of gas molecules</li> <li><strong>Chamber size matters</strong> — A larger chamber captures more gas, giving a higher concentration change rate</li> </ul> <p>To make measurements comparable, we need to convert our raw observation into a standardized unit: <strong>µmol m⁻² s⁻¹</strong> (micromoles per square meter per second).</p> <h3 id="the-formula"> <a href="#the-formula" class="anchor-heading" aria-labelledby="the-formula"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The Formula </h3> <p>The flux calculation is a two-step process:</p> <p><strong>Step 1: Calculate moles of air in the chamber</strong> using the Ideal Gas Law:</p> \[n = \frac{P \cdot V}{R \cdot T}\] <p><strong>Step 2: Calculate flux</strong> by combining the slope with moles of air:</p> \[\text{Flux} = \frac{n \cdot \text{slope}}{A}\] <p>Where:</p> <div class="table-wrapper"><table> <thead> <tr> <th>Symbol</th> <th>Description</th> <th>Unit</th> </tr> </thead> <tbody> <tr> <td>$n$</td> <td>Moles of air in the chamber</td> <td>mol</td> </tr> <tr> <td>$P$</td> <td>Atmospheric pressure</td> <td>atm</td> </tr> <tr> <td>$V$</td> <td>Chamber headspace volume</td> <td>L (liters)</td> </tr> <tr> <td>$R$</td> <td>Ideal gas constant</td> <td>0.0821 L·atm·K⁻¹·mol⁻¹</td> </tr> <tr> <td>$T$</td> <td>Air temperature</td> <td>K (Kelvin)</td> </tr> <tr> <td>slope</td> <td>Rate of concentration change</td> <td>ppm s⁻¹</td> </tr> <tr> <td>$A$</td> <td>Surface area covered by chamber</td> <td>m²</td> </tr> </tbody> </table></div> <h3 id="understanding-why-this-works"> <a href="#understanding-why-this-works" class="anchor-heading" aria-labelledby="understanding-why-this-works"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Understanding Why This Works </h3> <p>The key insight is understanding what <strong>ppm</strong> means:</p> <blockquote> <p><strong>ppm = parts per million = µmol per mol of air</strong></p> </blockquote> <p>So when we multiply:</p> <ul> <li><code class="language-plaintext highlighter-rouge">slope (ppm/s)</code> × <code class="language-plaintext highlighter-rouge">n (moles of air)</code> = <strong>µmol/s</strong></li> </ul> <p>Then dividing by area gives us:</p> <ul> <li><code class="language-plaintext highlighter-rouge">µmol/s</code> ÷ <code class="language-plaintext highlighter-rouge">area (m²)</code> = <strong>µmol m⁻² s⁻¹</strong></li> </ul> <p>This is our final flux unit—no additional conversion factor needed!</p> <blockquote> <p><strong>Info: ppb vs ppm - Which Unit to Use?</strong></p> <p>Gas concentrations can be expressed in different units:</p> <ul> <li><strong>ppm</strong> (parts per million) = 1 molecule per 1,000,000 air molecules</li> <li><strong>ppb</strong> (parts per billion) = 1 molecule per 1,000,000,000 air molecules</li> <li><strong>1 ppm = 1000 ppb</strong></li> </ul> <p>Typical usage by gas type:</p> <ul> <li><strong>CO₂</strong>: Usually measured in <strong>ppm</strong> (atmospheric ~420 ppm)</li> <li><strong>CH₄</strong>: Can be ppm or ppb (atmospheric ~1.9 ppm = 1900 ppb)</li> <li><strong>N₂O</strong>: Usually measured in <strong>ppb</strong> (atmospheric ~330 ppb)</li> </ul> <p>Always check your instrument output to know which unit your slope is in!</p> </blockquote> <blockquote> <p><strong>Info: The Ideal Gas Law</strong></p> <p>The equation $PV = nRT$ relates pressure, volume, and temperature to the number of moles of gas.</p> <p>Rearranging: $n = \frac{PV}{RT}$</p> <p><strong>Important:</strong> Be careful with units! If using:</p> <ul> <li>$R = 0.0821$ L·atm·K⁻¹·mol⁻¹ → use $V$ in liters, $P$ in atm</li> <li>$R = 8.314$ J·K⁻¹·mol⁻¹ → use $V$ in m³, $P$ in Pa</li> </ul> <p><strong>Resources:</strong></p> <ul> <li><a href="https://www.khanacademy.org/science/physics/thermodynamics/temp-kinetic-theory-ideal-gas-law/a/what-is-the-ideal-gas-law">Ideal Gas Law (Khan Academy)</a></li> <li><a href="https://chem.libretexts.org/Bookshelves/General_Chemistry/Map%3A_Chemistry_-_The_Central_Science_(Brown_et_al.)/10%3A_Gases/10.04%3A_The_Ideal_Gas_Law">Gas Laws (Chemistry LibreTexts)</a></li> </ul> </blockquote> <h3 id="creating-the-flux-calculation-function"> <a href="#creating-the-flux-calculation-function" class="anchor-heading" aria-labelledby="creating-the-flux-calculation-function"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Creating the Flux Calculation Function </h3> <p>Now let’s implement this formula as a Python function.</p> <div style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 5px;"> <div class="notice--primary"> <h3 id="exercise"> <a href="#exercise" class="anchor-heading" aria-labelledby="exercise"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exercise </h3> <p>The function <code class="language-plaintext highlighter-rouge">calculate_flux</code> is provided below but is incomplete. Fill in the missing parts based on the formula.</p> <p><strong>Hints:</strong></p> <ul> <li>Handle both ppb/s and ppm/s slope units using a parameter</li> <li>Use the Ideal Gas Law to calculate moles: $n = \frac{PV}{RT}$</li> <li>Remember: ppm means µmol per mol, so <code class="language-plaintext highlighter-rouge">slope_ppm × n</code> already gives µmol!</li> </ul> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Define the ideal gas constant (using L, atm, K, mol units)
</span><span class="n">R</span> <span class="o">=</span> <span class="mf">0.0821</span>  <span class="c1"># L·atm·K⁻¹·mol⁻¹
</span>
<span class="k">def</span> <span class="nf">calculate_flux</span><span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">temp_k</span><span class="p">,</span> <span class="n">pressure_atm</span><span class="p">,</span> <span class="n">volume_L</span><span class="p">,</span> <span class="n">area_m2</span><span class="p">,</span> <span class="n">slope_unit</span><span class="o">=</span><span class="s">'ppb'</span><span class="p">):</span>
    <span class="s">"""
    Calculates gas flux from chamber measurements.

    Parameters:
    - slope (float): Rate of concentration change
    - temp_k (float): Temperature in Kelvin
    - pressure_atm (float): Pressure in atmospheres (typically 1 atm)
    - volume_L (float): Chamber volume in liters
    - area_m2 (float): Chamber area in square meters
    - slope_unit (str): Unit of slope - 'ppb' for ppb/s or 'ppm' for ppm/s
    
    Returns:
    - float: Flux in µmol m⁻² s⁻¹
    """</span>
    <span class="c1"># Step 1: Convert slope to ppm/s if needed
</span>    <span class="k">if</span> <span class="n">slope_unit</span> <span class="o">==</span> <span class="s">'ppb'</span><span class="p">:</span>
        <span class="n">slope_ppm_s</span> <span class="o">=</span> <span class="p">...</span>
    <span class="k">elif</span> <span class="n">slope_unit</span> <span class="o">==</span> <span class="s">'ppm'</span><span class="p">:</span>
        <span class="n">slope_ppm_s</span> <span class="o">=</span> <span class="p">...</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(...)</span>
    
    <span class="c1"># Step 2: Calculate moles of air using Ideal Gas Law (n = PV/RT)
</span>    <span class="n">n_moles</span> <span class="o">=</span> <span class="p">...</span>
    
    <span class="c1"># Step 3: Calculate flux in µmol m⁻² s⁻¹
</span>    <span class="c1"># Note: ppm = µmol/mol, so (slope_ppm × n_moles) gives µmol/s
</span>    <span class="n">flux</span> <span class="o">=</span> <span class="p">...</span>
    
    <span class="k">return</span> <span class="n">flux</span>
</code></pre></div></div> <details> <summary>Click here for the solution!</summary> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Define the ideal gas constant (using L, atm, K, mol units)
</span><span class="n">R</span> <span class="o">=</span> <span class="mf">0.0821</span>  <span class="c1"># L·atm·K⁻¹·mol⁻¹
</span>
<span class="k">def</span> <span class="nf">calculate_flux</span><span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">temp_k</span><span class="p">,</span> <span class="n">pressure_atm</span><span class="p">,</span> <span class="n">volume_L</span><span class="p">,</span> <span class="n">area_m2</span><span class="p">,</span> <span class="n">slope_unit</span><span class="o">=</span><span class="s">'ppb'</span><span class="p">):</span>
    <span class="s">"""
    Calculates gas flux from chamber measurements.

    Parameters:
    - slope (float): Rate of concentration change
    - temp_k (float): Temperature in Kelvin
    - pressure_atm (float): Pressure in atmospheres (typically 1 atm)
    - volume_L (float): Chamber volume in liters
    - area_m2 (float): Chamber area in square meters
    - slope_unit (str): Unit of slope - 'ppb' for ppb/s or 'ppm' for ppm/s
    
    Returns:
    - float: Flux in µmol m⁻² s⁻¹
    """</span>
    <span class="c1"># Step 1: Convert slope to ppm/s if needed
</span>    <span class="k">if</span> <span class="n">slope_unit</span> <span class="o">==</span> <span class="s">'ppb'</span><span class="p">:</span>
        <span class="n">slope_ppm_s</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">/</span> <span class="mf">1000.0</span>  <span class="c1"># Convert ppb to ppm
</span>    <span class="k">elif</span> <span class="n">slope_unit</span> <span class="o">==</span> <span class="s">'ppm'</span><span class="p">:</span>
        <span class="n">slope_ppm_s</span> <span class="o">=</span> <span class="n">slope</span>  <span class="c1"># Already in ppm
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"slope_unit must be 'ppb' or 'ppm', got '</span><span class="si">{</span><span class="n">slope_unit</span><span class="si">}</span><span class="s">'"</span><span class="p">)</span>
    
    <span class="c1"># Step 2: Calculate moles of air using Ideal Gas Law (n = PV/RT)
</span>    <span class="n">n_moles</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressure_atm</span> <span class="o">*</span> <span class="n">volume_L</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">R</span> <span class="o">*</span> <span class="n">temp_k</span><span class="p">)</span>
    
    <span class="c1"># Step 3: Calculate flux in µmol m⁻² s⁻¹
</span>    <span class="c1"># Note: ppm = µmol/mol, so (slope_ppm × n_moles) gives µmol/s
</span>    <span class="c1"># Dividing by area gives µmol/m²/s - NO additional conversion needed!
</span>    <span class="n">flux</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_moles</span> <span class="o">*</span> <span class="n">slope_ppm_s</span><span class="p">)</span> <span class="o">/</span> <span class="n">area_m2</span>
    
    <span class="k">return</span> <span class="n">flux</span>
</code></pre></div> </div> <p><strong>Example calculations:</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example 1: Using slope in ppb/s (typical for N2O)
</span><span class="n">flux_n2o</span> <span class="o">=</span> <span class="n">calculate_flux</span><span class="p">(</span>
    <span class="n">slope</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>           <span class="c1"># 0.05 ppb/s
</span>    <span class="n">temp_k</span><span class="o">=</span><span class="mf">298.15</span><span class="p">,</span>
    <span class="n">pressure_atm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">volume_L</span><span class="o">=</span><span class="mf">12.6</span><span class="p">,</span>
    <span class="n">area_m2</span><span class="o">=</span><span class="mf">0.1257</span><span class="p">,</span>
    <span class="n">slope_unit</span><span class="o">=</span><span class="s">'ppb'</span>      <span class="c1"># Specify unit
</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"N2O Flux: </span><span class="si">{</span><span class="n">flux_n2o</span><span class="si">:</span><span class="p">.</span><span class="mi">6</span><span class="n">f</span><span class="si">}</span><span class="s"> µmol m⁻² s⁻¹"</span><span class="p">)</span>

<span class="c1"># Example 2: Using slope in ppm/s (typical for CO2)
</span><span class="n">flux_co2</span> <span class="o">=</span> <span class="n">calculate_flux</span><span class="p">(</span>
    <span class="n">slope</span><span class="o">=</span><span class="mf">0.0842</span><span class="p">,</span>         <span class="c1"># 0.0842 ppm/s
</span>    <span class="n">temp_k</span><span class="o">=</span><span class="mf">306.11</span><span class="p">,</span>
    <span class="n">pressure_atm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="n">volume_L</span><span class="o">=</span><span class="mf">41.46</span><span class="p">,</span>
    <span class="n">area_m2</span><span class="o">=</span><span class="mf">0.123</span><span class="p">,</span>
    <span class="n">slope_unit</span><span class="o">=</span><span class="s">'ppm'</span>      <span class="c1"># Specify unit
</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"CO2 Flux: </span><span class="si">{</span><span class="n">flux_co2</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> µmol m⁻² s⁻¹"</span><span class="p">)</span>
<span class="c1"># Expected: ~1.13 µmol m⁻² s⁻¹
</span></code></pre></div> </div> </details> </div> </div> <h3 id="32-isolating-and-visualizing-the-measurement-data"> <a href="#32-isolating-and-visualizing-the-measurement-data" class="anchor-heading" aria-labelledby="32-isolating-and-visualizing-the-measurement-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.2 Isolating and Visualizing the Measurement Data </h3> <p>Now let’s apply our formula to real data. We’ll use an example measurement period from our field campaign.</p> <h3 id="define-the-time-window"> <a href="#define-the-time-window" class="anchor-heading" aria-labelledby="define-the-time-window"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Define the Time Window </h3> <p>Let’s select a measurement window from our filtered data:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Define the start and end times for our measurement window
</span><span class="n">start_time</span> <span class="o">=</span> <span class="s">'2025-08-15 12:04:00'</span>
<span class="n">end_time</span> <span class="o">=</span> <span class="s">'2025-08-15 12:09:30'</span>

<span class="c1"># Select the data for this specific time window
</span><span class="n">measurement_data</span> <span class="o">=</span> <span class="n">df_filtered</span><span class="p">[</span>
    <span class="p">(</span><span class="n">df_filtered</span><span class="p">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">&amp;</span> 
    <span class="p">(</span><span class="n">df_filtered</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">end_time</span><span class="p">)</span>
<span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Selected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">measurement_data</span><span class="p">)</span><span class="si">}</span><span class="s"> data points"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Time range: </span><span class="si">{</span><span class="n">measurement_data</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nb">min</span><span class="p">()</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">measurement_data</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nb">max</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div> <h3 id="visualize-the-raw-measurement-window"> <a href="#visualize-the-raw-measurement-window" class="anchor-heading" aria-labelledby="visualize-the-raw-measurement-window"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Visualize the Raw Measurement Window </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Plot the measurement window
</span><span class="n">plot_time_series</span><span class="p">(</span>
    <span class="n">measurement_data</span><span class="p">,</span> 
    <span class="n">y_column</span><span class="o">=</span><span class="s">'N2O_ppb'</span><span class="p">,</span> 
    <span class="n">title</span><span class="o">=</span><span class="s">'N₂O Concentration - Full Measurement Window'</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s">'markers'</span>
<span class="p">)</span>
</code></pre></div></div> <h3 id="understanding-the-pattern"> <a href="#understanding-the-pattern" class="anchor-heading" aria-labelledby="understanding-the-pattern"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Understanding the Pattern </h3> <p>Looking at the plot, we can identify <strong>three distinct phases</strong>:</p> <div class="table-wrapper"><table> <thead> <tr> <th>Phase</th> <th>Description</th> <th>What You See</th> </tr> </thead> <tbody> <tr> <td><strong>1. Pre-measurement Baseline</strong></td> <td>Sensor measuring ambient air before chamber placement</td> <td>Flat period at the beginning</td> </tr> <tr> <td><strong>2. Accumulation (Linear Increase)</strong></td> <td>Chamber sealed, N₂O accumulating from soil</td> <td>Steady, linear rise ✓</td> </tr> <tr> <td><strong>3. Post-measurement Drop</strong></td> <td>Chamber lifted, sensor exposed to ambient air</td> <td>Sharp, sudden drop</td> </tr> </tbody> </table></div> <blockquote> <p>** Critical: Use Only the Linear Phase**</p> <p>Our flux calculation relies on the <strong>slope</strong> from linear regression. If we include the flat baseline or the sharp drop, the regression line will not represent the true accumulation rate, leading to <strong>inaccurate flux values</strong>.</p> <p>We must visually inspect the data and select <strong>only the linear increase phase</strong>.</p> </blockquote> <h3 id="refine-the-time-window"> <a href="#refine-the-time-window" class="anchor-heading" aria-labelledby="refine-the-time-window"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Refine the Time Window </h3> <p>Use the zoom and pan features on the interactive plot to identify the linear portion. In this example, the clean linear increase occurs approximately between <strong>12:05:30</strong> and <strong>12:09:00</strong>.</p> <div style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 5px;"> <div class="notice--primary"> <h3 id="exercise"> <a href="#exercise" class="anchor-heading" aria-labelledby="exercise"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exercise </h3> <p>Slice the DataFrame to include only the linear accumulation phase, then plot it to verify your selection.</p> <details> <summary>Click here for the solution!</summary> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Define the refined time window (linear portion only)
</span><span class="n">start_linear</span> <span class="o">=</span> <span class="s">'2025-08-15 12:05:30'</span>
<span class="n">end_linear</span> <span class="o">=</span> <span class="s">'2025-08-15 12:09:00'</span>

<span class="c1"># Create a new DataFrame with only the linear phase
# Use .copy() to avoid SettingWithCopyWarning
</span><span class="n">regression_data</span> <span class="o">=</span> <span class="n">df_filtered</span><span class="p">[</span>
    <span class="p">(</span><span class="n">df_filtered</span><span class="p">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">start_linear</span><span class="p">)</span> <span class="o">&amp;</span> 
    <span class="p">(</span><span class="n">df_filtered</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">end_linear</span><span class="p">)</span>
<span class="p">].</span><span class="n">copy</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Selected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">regression_data</span><span class="p">)</span><span class="si">}</span><span class="s"> points for regression"</span><span class="p">)</span>

<span class="c1"># Visualize to confirm our selection
</span><span class="n">plot_time_series</span><span class="p">(</span>
    <span class="n">regression_data</span><span class="p">,</span> 
    <span class="n">y_column</span><span class="o">=</span><span class="s">'N2O_ppb'</span><span class="p">,</span> 
    <span class="n">title</span><span class="o">=</span><span class="s">'Refined Regression Window (Linear Phase Only)'</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s">'markers'</span>
<span class="p">)</span>
</code></pre></div> </div> </details> </div> </div> <p>Great! The plot should now show a clear, linear increase in N₂O concentration. This is exactly what we need for our regression.</p> <h3 id="33-linear-regression-to-derive-the-rate-of-change"> <a href="#33-linear-regression-to-derive-the-rate-of-change" class="anchor-heading" aria-labelledby="33-linear-regression-to-derive-the-rate-of-change"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.3 Linear Regression to Derive the Rate of Change </h3> <p>Now we’ll fit a linear regression line to our data. The <strong>slope</strong> of this line is the $\frac{\Delta C}{\Delta t}$ we need for our flux formula.</p> <h3 id="convert-timestamps-to-elapsed-seconds"> <a href="#convert-timestamps-to-elapsed-seconds" class="anchor-heading" aria-labelledby="convert-timestamps-to-elapsed-seconds"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Convert Timestamps to Elapsed Seconds </h3> <p>For regression, We can not use ‘Timestamps’ as x-values because numeric x-values are required. We’ll convert timestamps to “seconds elapsed since start of measurement” (time passed in seconds compared to the start of measurement):</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="c1"># Work on a copy to avoid modifying the original
</span><span class="n">regression_data</span> <span class="o">=</span> <span class="n">regression_data</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Get the start time
</span><span class="n">start_timestamp</span> <span class="o">=</span> <span class="n">regression_data</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nb">min</span><span class="p">()</span>

<span class="c1"># Calculate elapsed seconds for each data point
</span><span class="n">regression_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">regression_data</span><span class="p">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">start_timestamp</span>
<span class="p">).</span><span class="n">total_seconds</span><span class="p">()</span>

<span class="c1"># Check the result
</span><span class="k">print</span><span class="p">(</span><span class="n">regression_data</span><span class="p">[[</span><span class="s">'elapsed_seconds'</span><span class="p">,</span> <span class="s">'N2O_ppb'</span><span class="p">]].</span><span class="n">head</span><span class="p">())</span>
</code></pre></div></div> <h3 id="perform-linear-regression"> <a href="#perform-linear-regression" class="anchor-heading" aria-labelledby="perform-linear-regression"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Perform Linear Regression </h3> <p>Use SciPy’s <code class="language-plaintext highlighter-rouge">linregress</code> function to fit a line:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Perform linear regression
</span><span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">std_err</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">linregress</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">regression_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">],</span>
    <span class="n">y</span><span class="o">=</span><span class="n">regression_data</span><span class="p">[</span><span class="s">'N2O_ppb'</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Calculate R-squared (coefficient of determination)
</span><span class="n">r_squared</span> <span class="o">=</span> <span class="n">r_value</span> <span class="o">**</span> <span class="mi">2</span>

<span class="k">print</span><span class="p">(</span><span class="s">"--- Regression Results ---"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Slope (ΔC/Δt): </span><span class="si">{</span><span class="n">slope</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> ppb/s"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Intercept: </span><span class="si">{</span><span class="n">intercept</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> ppb"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"R-squared: </span><span class="si">{</span><span class="n">r_squared</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"P-value: </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div> <blockquote> <p><strong>Info: Interpreting R-squared</strong></p> <p>The <strong>R-squared</strong> ($R^2$) value tells us how well the line fits the data:</p> <ul> <li>$R^2 = 1.0$: Perfect fit</li> <li>$R^2 &gt; 0.9$: Excellent fit</li> <li>$R^2 &gt; 0.7$: Good fit (acceptable for flux calculation)</li> <li>$R^2 &lt; 0.7$: Poor fit (flux may not be reliable)</li> </ul> <p>If $R^2 &lt; 0.7$, the concentration change may not be significant enough to calculate a meaningful flux.</p> <p><strong>Resources:</strong></p> <ul> <li><a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.linregress.html">SciPy linregress documentation</a></li> <li><a href="https://www.khanacademy.org/math/statistics-probability/describing-relationships-quantitative-data/introduction-to-trend-lines/a/linear-regression-review">Linear Regression (Khan Academy)</a></li> </ul> </blockquote> <h3 id="34-visualizing-the-regression-fit"> <a href="#34-visualizing-the-regression-fit" class="anchor-heading" aria-labelledby="34-visualizing-the-regression-fit"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.4 Visualizing the Regression Fit </h3> <p>Before calculating the flux, let’s visualize the regression line to confirm it fits well. Visualizing the regression fit is a critical quality control step that allows you to assess the physical validity of your flux measurement before accepting the calculated rate. By overlaying the raw $N_2O$ concentration points with the fitted regression line (derived from your calculated slope and intercept), you can visually confirm that the gas accumulation follows the expected linear pattern of a closed static chamber and easily spot anomalies like leaks, saturation curves, or pneumatic disturbances that mere summary statistics might miss.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="n">go</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="p">.</span><span class="n">Figure</span><span class="p">()</span>

<span class="c1"># Add the raw data points
</span><span class="n">fig</span><span class="p">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="p">.</span><span class="n">Scatter</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">regression_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">],</span> 
    <span class="n">y</span><span class="o">=</span><span class="n">regression_data</span><span class="p">[</span><span class="s">'N2O_ppb'</span><span class="p">],</span> 
    <span class="n">mode</span><span class="o">=</span><span class="s">'markers'</span><span class="p">,</span> 
    <span class="n">name</span><span class="o">=</span><span class="s">'Measured Data'</span><span class="p">,</span>
    <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="p">))</span>

<span class="c1"># Add the fitted regression line
</span><span class="n">fig</span><span class="p">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="p">.</span><span class="n">Scatter</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">regression_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">],</span> 
    <span class="n">y</span><span class="o">=</span><span class="n">intercept</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">regression_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">],</span>
    <span class="n">mode</span><span class="o">=</span><span class="s">'lines'</span><span class="p">,</span> 
    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s">'Fitted Line (R²=</span><span class="si">{</span><span class="n">r_squared</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">)'</span><span class="p">,</span> 
    <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">'red'</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="p">))</span>

<span class="n">fig</span><span class="p">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s">'Linear Regression: Slope = </span><span class="si">{</span><span class="n">slope</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> ppb/s'</span><span class="p">,</span>
    <span class="n">xaxis_title</span><span class="o">=</span><span class="s">'Elapsed Time (seconds)'</span><span class="p">,</span> 
    <span class="n">yaxis_title</span><span class="o">=</span><span class="s">'N₂O Concentration (ppb)'</span><span class="p">,</span> 
    <span class="n">template</span><span class="o">=</span><span class="s">'plotly_white'</span><span class="p">,</span>
    <span class="n">legend</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.98</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div> <p>If the red line closely follows the data points and $R^2 &gt; 0.7$, we can proceed with confidence!</p> <h3 id="35-final-flux-calculation"> <a href="#35-final-flux-calculation" class="anchor-heading" aria-labelledby="35-final-flux-calculation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.5 Final Flux Calculation </h3> <p>Now we have all the pieces. Let’s put them together!</p> <h3 id="get-average-temperature-and-pressure"> <a href="#get-average-temperature-and-pressure" class="anchor-heading" aria-labelledby="get-average-temperature-and-pressure"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Get Average Temperature and Pressure </h3> <p>We need the mean temperature and pressure during the measurement. <strong>Unit conversion is critical!</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Get average temperature (convert °C to Kelvin)
</span><span class="n">avg_temp_c</span> <span class="o">=</span> <span class="n">regression_data</span><span class="p">[</span><span class="s">'Ta_C'</span><span class="p">].</span><span class="n">mean</span><span class="p">()</span>
<span class="n">avg_temp_k</span> <span class="o">=</span> <span class="n">avg_temp_c</span> <span class="o">+</span> <span class="mf">273.15</span>

<span class="c1"># For pressure, we assume standard atmospheric pressure
</span><span class="n">pressure_atm</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># atm
</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Average Temperature: </span><span class="si">{</span><span class="n">avg_temp_c</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> °C = </span><span class="si">{</span><span class="n">avg_temp_k</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> K"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Pressure: </span><span class="si">{</span><span class="n">pressure_atm</span><span class="si">}</span><span class="s"> atm"</span><span class="p">)</span>
</code></pre></div></div> <h3 id="define-chamber-dimensions"> <a href="#define-chamber-dimensions" class="anchor-heading" aria-labelledby="define-chamber-dimensions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Define Chamber Dimensions </h3> <p>The chamber volume and area are constants for our setup.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Chamber specifications (measure these for your specific equipment!)
</span><span class="n">CHAMBER_VOLUME_L</span> <span class="o">=</span> <span class="mf">41.4567</span>    <span class="c1"># liters
</span><span class="n">COLLAR_AREA_M2</span> <span class="o">=</span> <span class="mf">0.123</span>    <span class="c1"># m²
</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Chamber Volume: </span><span class="si">{</span><span class="n">CHAMBER_VOLUME_L</span><span class="si">}</span><span class="s"> L"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Collar Area: </span><span class="si">{</span><span class="n">COLLAR_AREA_M2</span><span class="si">}</span><span class="s"> m²"</span><span class="p">)</span>
</code></pre></div></div> <h3 id="calculate-moles-of-air"> <a href="#calculate-moles-of-air" class="anchor-heading" aria-labelledby="calculate-moles-of-air"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Calculate Moles of Air </h3> <p>Now apply the Ideal Gas Law to get moles:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Ideal gas constant (L·atm·K⁻¹·mol⁻¹)
</span><span class="n">R</span> <span class="o">=</span> <span class="mf">0.0821</span>

<span class="c1"># Calculate moles of air in the chamber
</span><span class="n">n_moles</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressure_atm</span> <span class="o">*</span> <span class="n">CHAMBER_VOLUME_L</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">R</span> <span class="o">*</span> <span class="n">avg_temp_k</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Moles of air in chamber: </span><span class="si">{</span><span class="n">n_moles</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> mol"</span><span class="p">)</span>
</code></pre></div></div> <h3 id="calculate-the-flux"> <a href="#calculate-the-flux" class="anchor-heading" aria-labelledby="calculate-the-flux"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Calculate the Flux </h3> <p>The flux is here:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Convert slope from ppb/s to ppm/s
</span><span class="n">slope_ppm_s</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">/</span> <span class="mf">1000.0</span>

<span class="c1"># Calculate flux!
# Remember: ppm = µmol/mol, so (n × slope_ppm) gives µmol/s
</span><span class="n">flux_n2o</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_moles</span> <span class="o">*</span> <span class="n">slope_ppm_s</span><span class="p">)</span> <span class="o">/</span> <span class="n">COLLAR_AREA_M2</span>

<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span> <span class="o">+</span> <span class="s">"="</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"        FINAL FLUX CALCULATION RESULT"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"="</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Slope:       </span><span class="si">{</span><span class="n">slope</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> ppb/s = </span><span class="si">{</span><span class="n">slope_ppm_s</span><span class="si">:</span><span class="p">.</span><span class="mi">6</span><span class="n">f</span><span class="si">}</span><span class="s"> ppm/s"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Temperature: </span><span class="si">{</span><span class="n">avg_temp_k</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> K"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Pressure:    </span><span class="si">{</span><span class="n">pressure_atm</span><span class="si">}</span><span class="s"> atm"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Volume:      </span><span class="si">{</span><span class="n">CHAMBER_VOLUME_L</span><span class="si">}</span><span class="s"> L"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Moles (n):   </span><span class="si">{</span><span class="n">n_moles</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> mol"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Area:        </span><span class="si">{</span><span class="n">COLLAR_AREA_M2</span><span class="si">}</span><span class="s"> m²"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"-"</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  N₂O Flux:    </span><span class="si">{</span><span class="n">flux_n2o</span><span class="si">:</span><span class="p">.</span><span class="mi">5</span><span class="n">f</span><span class="si">}</span><span class="s"> µmol m⁻² s⁻¹"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"="</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
</code></pre></div></div> <p>Or use our function:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">flux_n2o</span> <span class="o">=</span> <span class="n">calculate_flux</span><span class="p">(</span>
    <span class="n">slope</span><span class="o">=</span><span class="n">slope</span><span class="p">,</span>
    <span class="n">temp_k</span><span class="o">=</span><span class="n">avg_temp_k</span><span class="p">,</span>
    <span class="n">pressure_atm</span><span class="o">=</span><span class="n">pressure_atm</span><span class="p">,</span>
    <span class="n">volume_L</span><span class="o">=</span><span class="n">CHAMBER_VOLUME_L</span><span class="p">,</span>
    <span class="n">area_m2</span><span class="o">=</span><span class="n">COLLAR_AREA_M2</span><span class="p">,</span>
    <span class="n">slope_unit</span><span class="o">=</span><span class="s">'ppb'</span>  <span class="c1"># Our regression slope is in ppb/s
</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"N₂O Flux: </span><span class="si">{</span><span class="n">flux_n2o</span><span class="si">:</span><span class="p">.</span><span class="mi">5</span><span class="n">f</span><span class="si">}</span><span class="s"> µmol m⁻² s⁻¹"</span><span class="p">)</span>
</code></pre></div></div> <p><strong>Congratulations!</strong> You’ve successfully converted raw gas concentration data into a standardized flux value!</p> <h3 id="36-challenge-making-the-function-more-robust"> <a href="#36-challenge-making-the-function-more-robust" class="anchor-heading" aria-labelledby="36-challenge-making-the-function-more-robust"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.6 Challenge: Making the Function More Robust </h3> <div style="background-color: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 5px; border-left: 4px solid #ffc107;"> <div class="notice--primary"> <h3 id="challenge-exercise"> <a href="#challenge-exercise" class="anchor-heading" aria-labelledby="challenge-exercise"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Challenge Exercise </h3> <p>Our <code class="language-plaintext highlighter-rouge">calculate_flux</code> function works, but it has a hidden weakness: it assumes the user provides inputs in the correct units. What if someone accidentally passes temperature in Celsius instead of Kelvin? The function would run without error but produce <strong>wildly incorrect results</strong>.</p> <p><strong>Your Task:</strong> Upgrade the function to be more robust by:</p> <ol> <li><strong>Detecting units</strong> based on plausible value ranges</li> <li><strong>Auto-converting</strong> common unit mistakes</li> <li><strong>Raising errors</strong> for implausible values</li> </ol> <p><strong>Tips for detecting units:</strong></p> <div class="table-wrapper"><table> <thead> <tr> <th>Variable</th> <th>If value is in range…</th> <th>It’s probably…</th> </tr> </thead> <tbody> <tr> <td>Temperature</td> <td>-50 to 60</td> <td>Celsius</td> </tr> <tr> <td>Temperature</td> <td>220 to 330</td> <td>Kelvin</td> </tr> <tr> <td>Pressure</td> <td>0.8 to 1.2</td> <td>atm</td> </tr> <tr> <td>Pressure</td> <td>800 to 1200</td> <td>hPa/mbar</td> </tr> <tr> <td>Volume</td> <td>1 to 1000</td> <td>Liters</td> </tr> <tr> <td>Volume</td> <td>0.001 to 1</td> <td>m³</td> </tr> <tr> <td>Area</td> <td>100 to 10,000</td> <td>cm²</td> </tr> <tr> <td>Area</td> <td>0.01 to 1</td> <td>m²</td> </tr> </tbody> </table></div> <details> <summary>Click here for the solution!</summary> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Ideal gas constant (using L, atm, K, mol units)
</span><span class="n">R</span> <span class="o">=</span> <span class="mf">0.0821</span>  <span class="c1"># L·atm·K⁻¹·mol⁻¹
</span>
<span class="k">def</span> <span class="nf">calculate_flux_robust</span><span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">slope_unit</span><span class="o">=</span><span class="s">'ppb'</span><span class="p">):</span>
    <span class="s">"""
    Calculates gas flux with automatic unit detection and conversion.
    
    All inputs are auto-converted to standard units:
    - Temperature → Kelvin
    - Pressure → atm
    - Volume → Liters
    - Area → m²

    Parameters:
    - slope (float): Rate of concentration change
    - temperature (float): Temperature in Celsius or Kelvin (auto-detected)
    - pressure (float): Pressure in atm or hPa (auto-detected)
    - volume (float): Chamber volume in m³ or Liters (auto-detected)
    - area (float): Chamber area in m² or cm² (auto-detected)
    - slope_unit (str): Unit of slope - 'ppb' for ppb/s or 'ppm' for ppm/s
    
    Returns:
    - float: Flux in µmol m⁻² s⁻¹
    """</span>
    
    <span class="c1"># --- Slope Unit Check ---
</span>    <span class="k">if</span> <span class="n">slope_unit</span> <span class="o">==</span> <span class="s">'ppb'</span><span class="p">:</span>
        <span class="n">slope_ppm_s</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">/</span> <span class="mf">1000.0</span>
    <span class="k">elif</span> <span class="n">slope_unit</span> <span class="o">==</span> <span class="s">'ppm'</span><span class="p">:</span>
        <span class="n">slope_ppm_s</span> <span class="o">=</span> <span class="n">slope</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"slope_unit must be 'ppb' or 'ppm', got '</span><span class="si">{</span><span class="n">slope_unit</span><span class="si">}</span><span class="s">'"</span><span class="p">)</span>
    
    <span class="c1"># --- Temperature Check ---
</span>    <span class="k">if</span> <span class="o">-</span><span class="mi">50</span> <span class="o">&lt;=</span> <span class="n">temperature</span> <span class="o">&lt;=</span> <span class="mi">60</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  [Auto-convert] Temperature </span><span class="si">{</span><span class="n">temperature</span><span class="si">}</span><span class="s"> detected as °C → converting to K"</span><span class="p">)</span>
        <span class="n">temp_k</span> <span class="o">=</span> <span class="n">temperature</span> <span class="o">+</span> <span class="mf">273.15</span>
    <span class="k">elif</span> <span class="mi">220</span> <span class="o">&lt;=</span> <span class="n">temperature</span> <span class="o">&lt;=</span> <span class="mi">330</span><span class="p">:</span>
        <span class="n">temp_k</span> <span class="o">=</span> <span class="n">temperature</span>  <span class="c1"># Already in Kelvin
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s">"Temperature (</span><span class="si">{</span><span class="n">temperature</span><span class="si">}</span><span class="s">) outside plausible range. "</span>
            <span class="sa">f</span><span class="s">"Expected: -50 to 60 (°C) or 220 to 330 (K)"</span>
        <span class="p">)</span>

    <span class="c1"># --- Pressure Check ---
</span>    <span class="k">if</span> <span class="mf">0.8</span> <span class="o">&lt;=</span> <span class="n">pressure</span> <span class="o">&lt;=</span> <span class="mf">1.2</span><span class="p">:</span>
        <span class="n">pressure_atm</span> <span class="o">=</span> <span class="n">pressure</span>  <span class="c1"># Already in atm
</span>    <span class="k">elif</span> <span class="mi">800</span> <span class="o">&lt;=</span> <span class="n">pressure</span> <span class="o">&lt;=</span> <span class="mi">1200</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  [Auto-convert] Pressure </span><span class="si">{</span><span class="n">pressure</span><span class="si">}</span><span class="s"> detected as hPa → converting to atm"</span><span class="p">)</span>
        <span class="n">pressure_atm</span> <span class="o">=</span> <span class="n">pressure</span> <span class="o">/</span> <span class="mf">1013.25</span>  <span class="c1"># Convert hPa to atm
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s">"Pressure (</span><span class="si">{</span><span class="n">pressure</span><span class="si">}</span><span class="s">) outside plausible range. "</span>
            <span class="sa">f</span><span class="s">"Expected: 0.8 to 1.2 (atm) or 800 to 1200 (hPa)"</span>
        <span class="p">)</span>
        
    <span class="c1"># --- Volume Check ---
</span>    <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">volume</span> <span class="o">&lt;=</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="n">volume_L</span> <span class="o">=</span> <span class="n">volume</span>  <span class="c1"># Already in Liters
</span>    <span class="k">elif</span> <span class="mf">0.001</span> <span class="o">&lt;=</span> <span class="n">volume</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  [Auto-convert] Volume </span><span class="si">{</span><span class="n">volume</span><span class="si">}</span><span class="s"> detected as m³ → converting to L"</span><span class="p">)</span>
        <span class="n">volume_L</span> <span class="o">=</span> <span class="n">volume</span> <span class="o">*</span> <span class="mf">1000.0</span>  <span class="c1"># Convert m³ to L
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s">"Volume (</span><span class="si">{</span><span class="n">volume</span><span class="si">}</span><span class="s">) outside plausible range. "</span>
            <span class="sa">f</span><span class="s">"Expected: 1 to 1000 (L) or 0.001 to 1 (m³)"</span>
        <span class="p">)</span>

    <span class="c1"># --- Area Check ---
</span>    <span class="k">if</span> <span class="mi">100</span> <span class="o">&lt;=</span> <span class="n">area</span> <span class="o">&lt;=</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  [Auto-convert] Area </span><span class="si">{</span><span class="n">area</span><span class="si">}</span><span class="s"> detected as cm² → converting to m²"</span><span class="p">)</span>
        <span class="n">area_m2</span> <span class="o">=</span> <span class="n">area</span> <span class="o">/</span> <span class="mf">10000.0</span>
    <span class="k">elif</span> <span class="mf">0.01</span> <span class="o">&lt;=</span> <span class="n">area</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">area_m2</span> <span class="o">=</span> <span class="n">area</span>  <span class="c1"># Already in m²
</span>    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s">"Area (</span><span class="si">{</span><span class="n">area</span><span class="si">}</span><span class="s">) outside plausible range. "</span>
            <span class="sa">f</span><span class="s">"Expected: 100 to 10000 (cm²) or 0.01 to 1 (m²)"</span>
        <span class="p">)</span>

    <span class="c1"># --- Core Calculation ---
</span>    <span class="c1"># Calculate moles of air (n = PV/RT)
</span>    <span class="n">n_moles</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressure_atm</span> <span class="o">*</span> <span class="n">volume_L</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">R</span> <span class="o">*</span> <span class="n">temp_k</span><span class="p">)</span>
    
    <span class="c1"># Calculate flux
</span>    <span class="c1"># ppm = µmol/mol, so (n × slope_ppm) gives µmol/s
</span>    <span class="c1"># Dividing by area gives µmol/m²/s
</span>    <span class="n">flux</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_moles</span> <span class="o">*</span> <span class="n">slope_ppm_s</span><span class="p">)</span> <span class="o">/</span> <span class="n">area_m2</span>
    
    <span class="k">return</span> <span class="n">flux</span>
</code></pre></div> </div> <p><strong>Example usage:</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example 1: N2O with slope in ppb/s
</span><span class="n">flux_n2o</span> <span class="o">=</span> <span class="n">calculate_flux_robust</span><span class="p">(</span>
    <span class="n">slope</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>             <span class="c1"># 50 ppb/s
</span>    <span class="n">temperature</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>       <span class="c1"># Celsius - will be converted to K
</span>    <span class="n">pressure</span><span class="o">=</span><span class="mi">1013</span><span class="p">,</span>        <span class="c1"># hPa - will be converted to atm
</span>    <span class="n">volume</span><span class="o">=</span><span class="mf">12.6</span><span class="p">,</span>          <span class="c1"># Liters - already correct
</span>    <span class="n">area</span><span class="o">=</span><span class="mi">1257</span><span class="p">,</span>            <span class="c1"># cm² - will be converted to m²
</span>    <span class="n">slope_unit</span><span class="o">=</span><span class="s">'ppb'</span>
<span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"N2O Flux: </span><span class="si">{</span><span class="n">flux_n2o</span><span class="si">:</span><span class="p">.</span><span class="mi">5</span><span class="n">f</span><span class="si">}</span><span class="s"> µmol m⁻² s⁻¹"</span><span class="p">)</span>

<span class="c1"># Example 2: CO2 with slope in ppm/s
</span><span class="n">flux_co2</span> <span class="o">=</span> <span class="n">calculate_flux_robust</span><span class="p">(</span>
    <span class="n">slope</span><span class="o">=</span><span class="mf">0.0842</span><span class="p">,</span>         <span class="c1"># 0.0842 ppm/s
</span>    <span class="n">temperature</span><span class="o">=</span><span class="mi">33</span><span class="p">,</span>       <span class="c1"># Celsius
</span>    <span class="n">pressure</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>         <span class="c1"># atm - already correct
</span>    <span class="n">volume</span><span class="o">=</span><span class="mf">41.46</span><span class="p">,</span>         <span class="c1"># Liters
</span>    <span class="n">area</span><span class="o">=</span><span class="mf">0.123</span><span class="p">,</span>           <span class="c1"># m² - already correct
</span>    <span class="n">slope_unit</span><span class="o">=</span><span class="s">'ppm'</span>
<span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"CO2 Flux: </span><span class="si">{</span><span class="n">flux_co2</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> µmol m⁻² s⁻¹"</span><span class="p">)</span>
</code></pre></div> </div> </details> <blockquote> <p><strong>Info: Python’s <code class="language-plaintext highlighter-rouge">raise</code> Keyword</strong></p> <p>The <code class="language-plaintext highlighter-rouge">raise</code> keyword is used to trigger an exception (error) when something goes wrong:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">"Your error message here"</span><span class="p">)</span>
</code></pre></div> </div> <p>Common exception types:</p> <ul> <li><code class="language-plaintext highlighter-rouge">ValueError</code>: Input has wrong value (but correct type)</li> <li><code class="language-plaintext highlighter-rouge">TypeError</code>: Input has wrong type</li> <li><code class="language-plaintext highlighter-rouge">RuntimeError</code>: General runtime error</li> </ul> <p><strong>Resources:</strong> <a href="https://www.geeksforgeeks.org/python-raise-keyword/">Python raise keyword (GeeksforGeeks)</a></p> </blockquote> </div> </div> <h2 id="4-automating-gas-flux-calculation"> <a href="#4-automating-gas-flux-calculation" class="anchor-heading" aria-labelledby="4-automating-gas-flux-calculation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4. Automating Gas Flux Calculation </h2> <p>In Section 3, we calculated flux for a single measurement by hand. Now it’s time to scale up! With dozens of measurements across multiple plots, dates, and gas types, we need automation.</p> <h3 id="41-structuring-measurement-metadata"> <a href="#41-structuring-measurement-metadata" class="anchor-heading" aria-labelledby="41-structuring-measurement-metadata"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4.1 Structuring Measurement Metadata </h3> <p>The first and crucial step of automation is to store the key information (metadata) for each measurement in a structured way that a program can loop through. For this, we will use a Python <strong>dictionary</strong> that can be converted to a DataFrame. The dictionary keys will be our data “columns” (e.g., ‘plot_id’, ‘land_use’), and the values will be lists containing the data for each plot.</p> <h3 id="the-challenge-multiple-measurements-per-plot"> <a href="#the-challenge-multiple-measurements-per-plot" class="anchor-heading" aria-labelledby="the-challenge-multiple-measurements-per-plot"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The Challenge: Multiple Measurements per Plot </h3> <p>Now, there is an issue: we take multiple measurements at the same plot, perhaps on different days or at different times. How can we store this information efficiently?</p> <p><strong>Solution:</strong> We can store the multiple start and end times for a single <strong>plot</strong> as a single string, with each timestamp separated by a semicolon (;). Of course, the order of the multiple starttime and endtime for a plot should match. By doing this, we can keep the metadata table concise and still tell our program to perform multiple calculations for that plot:</p> <ul> <li><code class="language-plaintext highlighter-rouge">plot_id</code>: The unique plot identifier</li> <li><code class="language-plaintext highlighter-rouge">land_use</code>: The land cover type</li> <li><code class="language-plaintext highlighter-rouge">start_time</code>: All measurement start times, separated by <code class="language-plaintext highlighter-rouge">;</code></li> <li><code class="language-plaintext highlighter-rouge">end_time</code>: All measurement end times, separated by <code class="language-plaintext highlighter-rouge">;</code></li> <li><code class="language-plaintext highlighter-rouge">variable</code>: The gas measured for each time window, separated by <code class="language-plaintext highlighter-rouge">;</code></li> </ul> <blockquote> <p><strong>Important:</strong> The order must match! The 1st start_time goes with the 1st end_time and 1st variable, etc.</p> </blockquote> <h3 id="creating-the-metadata-dictionary"> <a href="#creating-the-metadata-dictionary" class="anchor-heading" aria-labelledby="creating-the-metadata-dictionary"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Creating the Metadata Dictionary </h3> <p>Now let’s create our metadata. A Python dictionary uses <strong>keys</strong> (column names) and <strong>values</strong> (lists of data):</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="c1"># --- Create Compact Measurement Metadata ---
# Each plot appears only once; multiple measurements are semicolon-separated
</span>
<span class="n">measurement_info</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'plot_id'</span><span class="p">:</span> <span class="p">[</span><span class="s">'1-1'</span><span class="p">,</span> <span class="s">'1-2'</span><span class="p">,</span> <span class="s">'1-3'</span><span class="p">,</span> <span class="s">'2-1'</span><span class="p">,</span> <span class="s">'2-2'</span><span class="p">,</span> <span class="s">'2-3'</span><span class="p">],</span>
    <span class="s">'land_use'</span><span class="p">:</span> <span class="p">[</span><span class="s">'forest'</span><span class="p">,</span> <span class="s">'forest'</span><span class="p">,</span> <span class="s">'forest'</span><span class="p">,</span> <span class="s">'grassland'</span><span class="p">,</span> <span class="s">'grassland'</span><span class="p">,</span> <span class="s">'grassland'</span><span class="p">],</span>
    <span class="s">'start_time'</span><span class="p">:</span> <span class="p">[</span>
        <span class="s">'2025-08-06 11:41:35; 2025-08-06 11:41:35; 2025-08-15 11:08:25; 2025-08-15 11:08:25; 2025-08-15 11:09:36; 2025-08-26 11:12:39; 2025-08-26 11:12:39; 2025-08-26 11:14:16'</span><span class="p">,</span>
        <span class="s">'2025-08-06 11:52:00; 2025-08-06 11:52:00; 2025-08-15 11:20:30; 2025-08-15 11:20:30; 2025-08-15 11:21:41; 2025-08-26 11:18:35; 2025-08-26 11:18:35; 2025-08-26 11:20:10'</span><span class="p">,</span>
        <span class="s">'2025-08-26 11:24:51; 2025-08-26 11:24:51; 2025-08-26 11:26:35'</span><span class="p">,</span>
        <span class="s">'2025-08-06 12:11:13; 2025-08-06 12:11:13; 2025-08-15 12:11:38; 2025-08-15 12:11:38; 2025-08-15 12:12:49; 2025-08-26 11:49:07; 2025-08-26 11:50:40; 2025-08-26 11:50:40'</span><span class="p">,</span>
        <span class="s">'2025-08-06 12:21:00; 2025-08-06 12:21:00; 2025-08-15 12:03:45; 2025-08-15 12:03:45; 2025-08-15 12:04:56; 2025-08-26 12:04:23; 2025-08-26 12:04:23; 2025-08-26 12:05:31'</span><span class="p">,</span>
        <span class="s">'2025-08-06 12:27:47; 2025-08-06 12:27:47; 2025-08-15 11:53:30; 2025-08-15 11:53:30; 2025-08-15 11:54:41; 2025-08-26 12:25:48; 2025-08-26 12:25:48; 2025-08-26 12:27:23'</span>
    <span class="p">],</span>
    <span class="s">'end_time'</span><span class="p">:</span> <span class="p">[</span>
        <span class="s">'2025-08-06 11:45:35; 2025-08-06 11:45:35; 2025-08-15 11:12:25; 2025-08-15 11:12:25; 2025-08-15 11:13:36; 2025-08-26 11:16:39; 2025-08-26 11:16:39; 2025-08-26 11:18:16'</span><span class="p">,</span>
        <span class="s">'2025-08-06 11:56:00; 2025-08-06 11:56:00; 2025-08-15 11:24:30; 2025-08-15 11:24:30; 2025-08-15 11:25:41; 2025-08-26 11:22:35; 2025-08-26 11:22:35; 2025-08-26 11:24:10'</span><span class="p">,</span>
        <span class="s">'2025-08-26 11:28:51; 2025-08-26 11:28:51; 2025-08-26 11:30:35'</span><span class="p">,</span>
        <span class="s">'2025-08-06 12:17:00; 2025-08-06 12:17:00; 2025-08-15 12:15:38; 2025-08-15 12:15:38; 2025-08-15 12:16:49; 2025-08-26 11:53:07; 2025-08-26 11:54:40; 2025-08-26 11:54:40'</span><span class="p">,</span>
        <span class="s">'2025-08-06 12:25:46; 2025-08-06 12:25:46; 2025-08-15 12:07:45; 2025-08-15 12:07:45; 2025-08-15 12:08:56; 2025-08-26 12:08:23; 2025-08-26 12:08:23; 2025-08-26 12:09:31'</span><span class="p">,</span>
        <span class="s">'2025-08-06 12:31:50; 2025-08-06 12:31:50; 2025-08-15 11:57:59; 2025-08-15 11:57:59; 2025-08-15 11:59:10; 2025-08-26 12:29:48; 2025-08-26 12:29:48; 2025-08-26 12:31:23'</span>
    <span class="p">],</span>
    <span class="s">'variable'</span><span class="p">:</span> <span class="p">[</span>
        <span class="s">'CH4; CO2; CH4; CO2; N2O; CH4; CO2; N2O'</span><span class="p">,</span>
        <span class="s">'CH4; CO2; CH4; CO2; N2O; CH4; CO2; N2O'</span><span class="p">,</span>
        <span class="s">'CH4; CO2; N2O'</span><span class="p">,</span>
        <span class="s">'CH4; CO2; CH4; CO2; N2O; N2O; CH4; CO2'</span><span class="p">,</span>
        <span class="s">'CH4; CO2; CH4; CO2; N2O; CH4; CO2; N2O'</span><span class="p">,</span>
        <span class="s">'CH4; CO2; CH4; CO2; N2O; CH4; CO2; N2O'</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Convert dictionary to DataFrame
</span><span class="n">metadata_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">measurement_info</span><span class="p">)</span>
</code></pre></div></div> <p>Let’s verify our metadata:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">"Measurement Metadata Summary:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Total plots: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">metadata_df</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Forest plots: </span><span class="si">{</span><span class="p">(</span><span class="n">metadata_df</span><span class="p">[</span><span class="s">'land_use'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'forest'</span><span class="p">).</span><span class="nb">sum</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Grassland plots: </span><span class="si">{</span><span class="p">(</span><span class="n">metadata_df</span><span class="p">[</span><span class="s">'land_use'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'grassland'</span><span class="p">).</span><span class="nb">sum</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># Count total measurements across all plots
</span><span class="n">total_measurements</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">'variable'</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">metadata_df</span><span class="p">.</span><span class="n">iterrows</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Total measurements: </span><span class="si">{</span><span class="n">total_measurements</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">metadata_df</span>
</code></pre></div></div> <h3 id="how-to-parse-semicolon-separated-values"> <a href="#how-to-parse-semicolon-separated-values" class="anchor-heading" aria-labelledby="how-to-parse-semicolon-separated-values"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How to Parse Semicolon-Separated Values </h3> <p>Now we need to learn how to <strong>split</strong> these combined strings back into individual values. Python provides the <code class="language-plaintext highlighter-rouge">split()</code> method for this.</p> <blockquote> <p><strong>Info: The <code class="language-plaintext highlighter-rouge">split()</code> Method</strong></p> <p>The <code class="language-plaintext highlighter-rouge">split()</code> method breaks a string into a list of substrings based on a delimiter (separator).</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Basic usage
</span><span class="n">text</span> <span class="o">=</span> <span class="s">"apple; banana; cherry"</span>
<span class="n">fruits</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'; '</span><span class="p">)</span>  <span class="c1"># Split by '; '
</span><span class="k">print</span><span class="p">(</span><span class="n">fruits</span><span class="p">)</span>  <span class="c1"># ['apple', 'banana', 'cherry']
</span>
<span class="c1"># Access individual items
</span><span class="k">print</span><span class="p">(</span><span class="n">fruits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># 'apple'
</span><span class="k">print</span><span class="p">(</span><span class="n">fruits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># 'banana'
</span></code></pre></div> </div> <p><strong>Common delimiters:</strong></p> <ul> <li><code class="language-plaintext highlighter-rouge">'; '</code> — semicolon with space (our format)</li> <li><code class="language-plaintext highlighter-rouge">','</code> — comma</li> <li><code class="language-plaintext highlighter-rouge">' '</code> — space</li> <li><code class="language-plaintext highlighter-rouge">'\t'</code> — tab</li> <li><code class="language-plaintext highlighter-rouge">'\n'</code> — newline</li> </ul> <p><strong>Resources:</strong> <a href="https://docs.python.org/3/library/stdtypes.html#str.split">Python split() documentation</a></p> </blockquote> <p>Let’s practice parsing one plot’s data:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Get data for Plot 1-1
</span><span class="n">plot_data</span> <span class="o">=</span> <span class="n">metadata_df</span><span class="p">[</span><span class="n">metadata_df</span><span class="p">[</span><span class="s">'plot_id'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'1-1'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Plot: </span><span class="si">{</span><span class="n">plot_data</span><span class="p">[</span><span class="s">'plot_id'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Land use: </span><span class="si">{</span><span class="n">plot_data</span><span class="p">[</span><span class="s">'land_use'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># The raw string looks like this:
</span><span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Raw variable string: </span><span class="si">{</span><span class="n">plot_data</span><span class="p">[</span><span class="s">'variable'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># Split it into a list
</span><span class="n">variables</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="s">'variable'</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'; '</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">After split(): </span><span class="si">{</span><span class="n">variables</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Number of measurements: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div> <p>Output:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Plot: 1-1
Land use: forest

Raw variable string: CH4; CO2; CH4; CO2; N2O; CH4; CO2; N2O

After split(): ['CH4', 'CO2', 'CH4', 'CO2', 'N2O', 'CH4', 'CO2', 'N2O']
Number of measurements: 8
</code></pre></div></div> <h3 id="iterating-through-parallel-lists-with-zip"> <a href="#iterating-through-parallel-lists-with-zip" class="anchor-heading" aria-labelledby="iterating-through-parallel-lists-with-zip"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Iterating Through Parallel Lists with <code class="language-plaintext highlighter-rouge">zip()</code> </h3> <p>We now have three lists that need to be processed together:</p> <ul> <li><code class="language-plaintext highlighter-rouge">start_times</code> — when each measurement started</li> <li><code class="language-plaintext highlighter-rouge">end_times</code> — when each measurement ended</li> <li><code class="language-plaintext highlighter-rouge">variables</code> — which gas was measured</li> </ul> <p>These lists are <strong>parallel</strong>: the 1st item in each list belongs together, the 2nd items belong together, etc. How do we loop through them simultaneously?</p> <blockquote> <p><strong>Info: The <code class="language-plaintext highlighter-rouge">zip()</code> Function</strong></p> <p><code class="language-plaintext highlighter-rouge">zip()</code> takes multiple lists and combines them element-by-element, like a zipper bringing two sides together:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">'Alice'</span><span class="p">,</span> <span class="s">'Bob'</span><span class="p">,</span> <span class="s">'Charlie'</span><span class="p">]</span>
<span class="n">ages</span> <span class="o">=</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">35</span><span class="p">]</span>
<span class="n">cities</span> <span class="o">=</span> <span class="p">[</span><span class="s">'NYC'</span><span class="p">,</span> <span class="s">'LA'</span><span class="p">,</span> <span class="s">'Chicago'</span><span class="p">]</span>

<span class="c1"># Without zip - awkward index-based loop
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s"> is </span><span class="si">{</span><span class="n">ages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s"> from </span><span class="si">{</span><span class="n">cities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># With zip - clean and readable
</span><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">city</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">ages</span><span class="p">,</span> <span class="n">cities</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s"> is </span><span class="si">{</span><span class="n">age</span><span class="si">}</span><span class="s"> from </span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div> </div> <p>Output:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Alice is 25 from NYC
Bob is 30 from LA
Charlie is 35 from Chicago
</code></pre></div> </div> <p><strong>Why use <code class="language-plaintext highlighter-rouge">zip()</code>?</strong></p> <ul> <li>Cleaner, more readable code</li> <li>No need to manage index variables</li> <li>Less prone to off-by-one errors</li> <li>Pythonic way to handle parallel iteration</li> </ul> <p><strong>Resources:</strong> <a href="https://docs.python.org/3/library/functions.html#zip">Python zip() documentation</a></p> </blockquote> <p>Let’s use <code class="language-plaintext highlighter-rouge">zip()</code> to display all measurements for Plot 1-1:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Parse all three columns
</span><span class="n">start_times</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="s">'start_time'</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'; '</span><span class="p">)</span>
<span class="n">end_times</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="s">'end_time'</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'; '</span><span class="p">)</span>
<span class="n">variables</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="s">'variable'</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'; '</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Plot </span><span class="si">{</span><span class="n">plot_data</span><span class="p">[</span><span class="s">'plot_id'</span><span class="p">]</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">plot_data</span><span class="p">[</span><span class="s">'land_use'</span><span class="p">]</span><span class="si">}</span><span class="s">):"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Total measurements: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># Use zip() to iterate through all three lists together
</span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">start_times</span><span class="p">,</span> <span class="n">end_times</span><span class="p">,</span> <span class="n">variables</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">. </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s"> → </span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div> <blockquote> <p><strong>Note:</strong> We also use <code class="language-plaintext highlighter-rouge">enumerate(..., 1)</code> to get a counter starting from 1. This is another useful Python pattern for numbered loops.</p> </blockquote> <div style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 5px;"> <div class="notice--primary"> <h3 id="exercise-parse-and-display-another-plot"> <a href="#exercise-parse-and-display-another-plot" class="anchor-heading" aria-labelledby="exercise-parse-and-display-another-plot"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exercise: Parse and Display Another Plot </h3> <p>Now it’s your turn! Write code to parse and display measurements for Plot <code class="language-plaintext highlighter-rouge">2-1</code> (a grassland plot).</p> <p><strong>Your code should:</strong></p> <ol> <li>Extract the row for plot_id == ‘2-1’</li> <li>Split the start_time, end_time, and variable strings</li> <li>Use <code class="language-plaintext highlighter-rouge">zip()</code> to print each measurement with its number</li> </ol> <p><strong>Bonus questions to answer:</strong></p> <ul> <li>How many measurements does Plot 2-1 have?</li> <li>Which unique gases were measured? (Hint: use <code class="language-plaintext highlighter-rouge">set()</code>)</li> <li>On which dates were measurements taken?</li> </ul> <details> <summary>Click here for the solution!</summary> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Get data for Plot 2-1
</span><span class="n">plot_2_1</span> <span class="o">=</span> <span class="n">metadata_df</span><span class="p">[</span><span class="n">metadata_df</span><span class="p">[</span><span class="s">'plot_id'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'2-1'</span><span class="p">].</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Parse the semicolon-separated values
</span><span class="n">start_times</span> <span class="o">=</span> <span class="n">plot_2_1</span><span class="p">[</span><span class="s">'start_time'</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'; '</span><span class="p">)</span>
<span class="n">end_times</span> <span class="o">=</span> <span class="n">plot_2_1</span><span class="p">[</span><span class="s">'end_time'</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'; '</span><span class="p">)</span>
<span class="n">variables</span> <span class="o">=</span> <span class="n">plot_2_1</span><span class="p">[</span><span class="s">'variable'</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'; '</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Plot: </span><span class="si">{</span><span class="n">plot_2_1</span><span class="p">[</span><span class="s">'plot_id'</span><span class="p">]</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">plot_2_1</span><span class="p">[</span><span class="s">'land_use'</span><span class="p">]</span><span class="si">}</span><span class="s">)"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Number of measurements: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># Find unique gases using set()
</span><span class="n">unique_gases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Gases measured: </span><span class="si">{</span><span class="n">unique_gases</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># Find unique dates (extract date part from timestamps)
</span><span class="n">unique_dates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">start_times</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Measurement dates: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">unique_dates</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">All measurements:"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">start_times</span><span class="p">,</span> <span class="n">end_times</span><span class="p">,</span> <span class="n">variables</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">. </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s"> → </span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div> </div> <p><strong>Answers:</strong></p> <ul> <li>Plot 2-1 has <strong>8 measurements</strong></li> <li>Gases: <strong>{‘CH4’, ‘CO2’, ‘N2O’}</strong></li> <li>Dates: <strong>[‘2025-08-06’, ‘2025-08-15’, ‘2025-08-26’]</strong></li> </ul> </details> </div> </div> <h3 id="42-setting-up-configuration-and-constants"> <a href="#42-setting-up-configuration-and-constants" class="anchor-heading" aria-labelledby="42-setting-up-configuration-and-constants"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4.2 Setting Up Configuration and Constants </h3> <h3 id="why-use-a-configuration-dictionary"> <a href="#why-use-a-configuration-dictionary" class="anchor-heading" aria-labelledby="why-use-a-configuration-dictionary"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Why Use a Configuration Dictionary? </h3> <p>Different gases have different properties:</p> <ul> <li><strong>N₂O</strong> concentrations are in <strong>ppb</strong> (parts per billion)</li> <li><strong>CO₂</strong> and <strong>CH₄</strong> concentrations are in <strong>ppm</strong> (parts per million)</li> <li>Each gas is stored in a different column of our DataFrame</li> </ul> <p>We <em>could</em> write separate code for each gas:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Bad approach - lots of repetition!
</span><span class="k">if</span> <span class="n">variable</span> <span class="o">==</span> <span class="s">'N2O'</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df_n2o</span>
    <span class="n">column</span> <span class="o">=</span> <span class="s">'N2O_ppb'</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="s">'ppb'</span>
<span class="k">elif</span> <span class="n">variable</span> <span class="o">==</span> <span class="s">'CO2'</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df_co2</span>
    <span class="n">column</span> <span class="o">=</span> <span class="s">'CO2_ppm'</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="s">'ppm'</span>
<span class="k">elif</span> <span class="n">variable</span> <span class="o">==</span> <span class="s">'CH4'</span><span class="p">:</span>
    <span class="c1"># ... and so on
</span></code></pre></div></div> <p>But this is repetitive and hard to maintain. What if we add a new gas? We’d have to update multiple places.</p> <p><strong>Better approach:</strong> Store all gas-specific settings in a <strong>configuration dictionary</strong>. Then our code can look up any gas’s settings dynamically.</p> <blockquote> <p><strong>Info: Nested Dictionaries</strong></p> <p>A dictionary can contain other dictionaries as values, creating a nested structure:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Simple dictionary
</span><span class="n">person</span> <span class="o">=</span> <span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'Alice'</span><span class="p">,</span> <span class="s">'age'</span><span class="p">:</span> <span class="mi">30</span><span class="p">}</span>

<span class="c1"># Nested dictionary
</span><span class="n">people</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'alice'</span><span class="p">:</span> <span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'Alice'</span><span class="p">,</span> <span class="s">'age'</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s">'city'</span><span class="p">:</span> <span class="s">'NYC'</span><span class="p">},</span>
    <span class="s">'bob'</span><span class="p">:</span> <span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'Bob'</span><span class="p">,</span> <span class="s">'age'</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s">'city'</span><span class="p">:</span> <span class="s">'LA'</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Accessing nested values
</span><span class="k">print</span><span class="p">(</span><span class="n">people</span><span class="p">[</span><span class="s">'alice'</span><span class="p">][</span><span class="s">'city'</span><span class="p">])</span>  <span class="c1"># 'NYC'
</span><span class="k">print</span><span class="p">(</span><span class="n">people</span><span class="p">[</span><span class="s">'bob'</span><span class="p">][</span><span class="s">'age'</span><span class="p">])</span>     <span class="c1"># 25
</span></code></pre></div> </div> <p>This is perfect for storing configuration where each “category” (gas type) has multiple properties.</p> </blockquote> <h3 id="creating-the-gas-configuration"> <a href="#creating-the-gas-configuration" class="anchor-heading" aria-labelledby="creating-the-gas-configuration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Creating the Gas Configuration </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- Gas Configuration Dictionary ---
# Maps each gas name to its specific settings
</span>
<span class="n">GAS_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'N2O'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'dataframe'</span><span class="p">:</span> <span class="n">df_merged</span><span class="p">[[</span><span class="s">'N2O_ppb'</span><span class="p">,</span> <span class="s">'Ta_C'</span><span class="p">]].</span><span class="n">dropna</span><span class="p">(),</span>
        <span class="s">'column'</span><span class="p">:</span> <span class="s">'N2O_ppb'</span><span class="p">,</span>
        <span class="s">'slope_unit'</span><span class="p">:</span> <span class="s">'ppb'</span><span class="p">,</span>
        <span class="s">'display_name'</span><span class="p">:</span> <span class="s">'N₂O'</span>
    <span class="p">},</span>
    <span class="s">'CO2'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'dataframe'</span><span class="p">:</span> <span class="n">df_merged</span><span class="p">[[</span><span class="s">'CO2_ppm'</span><span class="p">,</span> <span class="s">'Ta_C'</span><span class="p">]].</span><span class="n">dropna</span><span class="p">(),</span>
        <span class="s">'column'</span><span class="p">:</span> <span class="s">'CO2_ppm'</span><span class="p">,</span>
        <span class="s">'slope_unit'</span><span class="p">:</span> <span class="s">'ppm'</span><span class="p">,</span>
        <span class="s">'display_name'</span><span class="p">:</span> <span class="s">'CO₂'</span>
    <span class="p">},</span>
    <span class="s">'CH4'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'dataframe'</span><span class="p">:</span> <span class="n">df_merged</span><span class="p">[[</span><span class="s">'CH4_ppm'</span><span class="p">,</span> <span class="s">'Ta_C'</span><span class="p">]].</span><span class="n">dropna</span><span class="p">(),</span>
        <span class="s">'column'</span><span class="p">:</span> <span class="s">'CH4_ppm'</span><span class="p">,</span>
        <span class="s">'slope_unit'</span><span class="p">:</span> <span class="s">'ppm'</span><span class="p">,</span>
        <span class="s">'display_name'</span><span class="p">:</span> <span class="s">'CH₄'</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>Now we can access any gas’s settings with a simple lookup:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example: Get settings for CO2
</span><span class="n">gas_name</span> <span class="o">=</span> <span class="s">'CO2'</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">GAS_CONFIG</span><span class="p">[</span><span class="n">gas_name</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Settings for </span><span class="si">{</span><span class="n">gas_name</span><span class="si">}</span><span class="s">:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Column name: </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s">'column'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Slope unit: </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s">'slope_unit'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Display name: </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s">'display_name'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Data points available: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">'dataframe'</span><span class="p">])</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div> <p><strong>Benefits of this approach:</strong></p> <ul> <li><strong>DRY (Don’t Repeat Yourself):</strong> One loop handles all gases</li> <li><strong>Extensible:</strong> Adding a new gas = adding one dictionary entry</li> <li><strong>Maintainable:</strong> All settings are in one place</li> </ul> <h3 id="setting-up-chamber-constants"> <a href="#setting-up-chamber-constants" class="anchor-heading" aria-labelledby="setting-up-chamber-constants"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting Up Chamber Constants </h3> <p>Our flux calculation also needs physical constants about our measurement chamber. Let’s define these clearly:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- Chamber Physical Constants ---
# Measure these for YOUR specific equipment!
</span>
<span class="n">CHAMBER_VOLUME_L</span> <span class="o">=</span> <span class="mf">41.4567</span>    <span class="c1"># Internal volume in liters
</span><span class="n">COLLAR_AREA_M2</span> <span class="o">=</span> <span class="mf">0.123</span>        <span class="c1"># Ground area covered in square meters
</span><span class="n">PRESSURE_ATM</span> <span class="o">=</span> <span class="mf">1.0</span>            <span class="c1"># Atmospheric pressure (assume standard)
</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Chamber Configuration:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Volume: </span><span class="si">{</span><span class="n">CHAMBER_VOLUME_L</span><span class="si">}</span><span class="s"> L"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Collar Area: </span><span class="si">{</span><span class="n">COLLAR_AREA_M2</span><span class="si">}</span><span class="s"> m²"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Pressure: </span><span class="si">{</span><span class="n">PRESSURE_ATM</span><span class="si">}</span><span class="s"> atm"</span><span class="p">)</span>
</code></pre></div></div> <h3 id="setting-up-quality-control-thresholds"> <a href="#setting-up-quality-control-thresholds" class="anchor-heading" aria-labelledby="setting-up-quality-control-thresholds"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting Up Quality Control Thresholds </h3> <p>Not every measurement will produce a valid flux. Sometimes the chamber leaks, or the soil flux is too small to detect, or there’s instrument noise. We need <strong>quality control (QC) thresholds</strong> to identify good vs. bad measurements.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- Quality Control Thresholds ---
</span><span class="n">R_SQUARED_THRESHOLD</span> <span class="o">=</span> <span class="mf">0.70</span>    <span class="c1"># Minimum R² (coefficient of determination)
</span><span class="n">P_VALUE_THRESHOLD</span> <span class="o">=</span> <span class="mf">0.05</span>      <span class="c1"># Maximum p-value for statistical significance
</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Quality Control Thresholds:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Minimum R²: </span><span class="si">{</span><span class="n">R_SQUARED_THRESHOLD</span><span class="si">}</span><span class="s"> (regression must explain ≥70% of variance)"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Maximum p-value: </span><span class="si">{</span><span class="n">P_VALUE_THRESHOLD</span><span class="si">}</span><span class="s"> (slope must be statistically significant)"</span><span class="p">)</span>
</code></pre></div></div> <p><strong>What do these thresholds mean?</strong></p> <ul> <li><strong>R² ≥ 0.70:</strong> The linear fit must explain at least 70% of the variation in concentration</li> <li><strong>p-value ≤ 0.05:</strong> The slope must be statistically significant (not due to random chance)</li> </ul> <div style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 5px;"> <div class="notice--primary"> <h3 id="exercise-explore-the-configuration"> <a href="#exercise-explore-the-configuration" class="anchor-heading" aria-labelledby="exercise-explore-the-configuration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exercise: Explore the Configuration </h3> <p>Write code to:</p> <ol> <li>Loop through all gases in <code class="language-plaintext highlighter-rouge">GAS_CONFIG</code> and print their settings</li> <li>Find which gas has the most data points available</li> <li>Verify that we have data for all three measurement dates</li> </ol> <p><strong>Hint:</strong> Use <code class="language-plaintext highlighter-rouge">for gas_name, config in GAS_CONFIG.items():</code> to iterate through dictionary items.</p> <details> <summary>Click here for the solution!</summary> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">"="</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"GAS CONFIGURATION SUMMARY"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"="</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>

<span class="n">max_points</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">gas_with_most_data</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">for</span> <span class="n">gas_name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">GAS_CONFIG</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">n_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">'dataframe'</span><span class="p">])</span>
    
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s">'display_name'</span><span class="p">]</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">gas_name</span><span class="si">}</span><span class="s">):"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Column: </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s">'column'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Unit: </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s">'slope_unit'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Data points: </span><span class="si">{</span><span class="n">n_points</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    
    <span class="c1"># Check date range
</span>    <span class="n">df</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">'dataframe'</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Date range: </span><span class="si">{</span><span class="n">df</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nb">min</span><span class="p">()</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">df</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nb">max</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    
    <span class="c1"># Track which has most data
</span>    <span class="k">if</span> <span class="n">n_points</span> <span class="o">&gt;</span> <span class="n">max_points</span><span class="p">:</span>
        <span class="n">max_points</span> <span class="o">=</span> <span class="n">n_points</span>
        <span class="n">gas_with_most_data</span> <span class="o">=</span> <span class="n">gas_name</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">→ </span><span class="si">{</span><span class="n">gas_with_most_data</span><span class="si">}</span><span class="s"> has the most data points: </span><span class="si">{</span><span class="n">max_points</span><span class="si">:</span><span class="p">,</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div> </div> </details> </div> </div> <h3 id="43-building-the-automation-pipeline"> <a href="#43-building-the-automation-pipeline" class="anchor-heading" aria-labelledby="43-building-the-automation-pipeline"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4.3 Building the Automation Pipeline </h3> <p>Now we’re ready to build the main automation loop. This is the most complex part of the tutorial, so we’ll break it into clear steps and explain each one thoroughly.</p> <h3 id="overview-what-will-our-pipeline-do"> <a href="#overview-what-will-our-pipeline-do" class="anchor-heading" aria-labelledby="overview-what-will-our-pipeline-do"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Overview: What Will Our Pipeline Do? </h3> <p>Here’s the high-level workflow for processing <strong>each measurement</strong>:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>For each PLOT in metadata:
    │
    └── For each MEASUREMENT in that plot:
            │
            ├── 1️⃣ Extract data for the time window
            │
            ├── 2️⃣ Show plot for visual inspection
            │
            ├── 3️⃣ Let user refine the time window
            │
            ├── 4️⃣ Perform linear regression
            │
            ├── 5️⃣ Check quality (R², p-value)
            │       │
            │       ├── ✓ Passed → Calculate flux
            │       └── ✗ Failed → Mark as invalid
            │
            └── 6️⃣ Store results
</code></pre></div></div> <p>This is a <strong>nested loop</strong> structure:</p> <ul> <li><strong>Outer loop:</strong> Goes through each plot (6 plots)</li> <li><strong>Inner loop:</strong> Goes through each measurement within that plot (varies per plot)</li> </ul> <h3 id="step-1-create-storage-for-results"> <a href="#step-1-create-storage-for-results" class="anchor-heading" aria-labelledby="step-1-create-storage-for-results"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1: Create Storage for Results </h3> <p>Before we start processing, we need a place to store all our calculated fluxes. We’ll use a <strong>list of dictionaries</strong> that can later be converted to a DataFrame.</p> <p><strong>Why a list of dictionaries?</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Each measurement's results will be a dictionary
</span><span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'plot_id'</span><span class="p">:</span> <span class="s">'1-1'</span><span class="p">,</span>
    <span class="s">'variable'</span><span class="p">:</span> <span class="s">'CO2'</span><span class="p">,</span>
    <span class="s">'flux'</span><span class="p">:</span> <span class="mf">1.234</span><span class="p">,</span>
    <span class="c1"># ... more fields
</span><span class="p">}</span>

<span class="c1"># We append each result to a list
</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="c1"># At the end, convert to DataFrame
</span><span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div></div> <p>This pattern is very common in Python data processing!</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="c1"># --- Initialize Results Storage ---
</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Will hold one dictionary per measurement
</span></code></pre></div></div> <h3 id="step-2-create-a-helper-function-for-temperature"> <a href="#step-2-create-a-helper-function-for-temperature" class="anchor-heading" aria-labelledby="step-2-create-a-helper-function-for-temperature"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2: Create a Helper Function for Temperature </h3> <p>During flux calculation, we need the average temperature during each measurement. Let’s create a reusable function for this:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_mean_temperature</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">,</span> <span class="n">temp_df</span><span class="p">,</span> <span class="n">temp_column</span><span class="o">=</span><span class="s">'Ta_C'</span><span class="p">):</span>
    <span class="s">"""
    Calculate mean temperature during a measurement window.
    
    Parameters:
        start_time: Start of measurement (datetime)
        end_time: End of measurement (datetime)
        temp_df: DataFrame with temperature data (DatetimeIndex)
        temp_column: Name of temperature column
    
    Returns:
        float: Mean temperature in °C, or NaN if no data found
    """</span>
    <span class="c1"># Create a boolean mask for the time window
</span>    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_df</span><span class="p">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">temp_df</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">end_time</span><span class="p">)</span>
    
    <span class="c1"># Extract temperature values in that window
</span>    <span class="n">temp_values</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="n">temp_column</span><span class="p">]</span>
    
    <span class="c1"># Handle case where no data is found
</span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  ⚠ Warning: No temperature data found"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span>
    
    <span class="k">return</span> <span class="n">temp_values</span><span class="p">.</span><span class="n">mean</span><span class="p">()</span>
</code></pre></div></div> <h3 id="step-3-count-total-measurements"> <a href="#step-3-count-total-measurements" class="anchor-heading" aria-labelledby="step-3-count-total-measurements"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 3: Count Total Measurements </h3> <p>For progress tracking, let’s count how many measurements we’ll process:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Count total measurements across all plots
</span><span class="n">total_measurements</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">metadata_df</span><span class="p">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">n_measurements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">'variable'</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">))</span>
    <span class="n">total_measurements</span> <span class="o">+=</span> <span class="n">n_measurements</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Total measurements to process: </span><span class="si">{</span><span class="n">total_measurements</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div> <p>Or more concisely using a <strong>generator expression</strong>:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">total_measurements</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">'variable'</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">))</span> 
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">metadata_df</span><span class="p">.</span><span class="n">iterrows</span><span class="p">()</span>
<span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Total measurements to process: </span><span class="si">{</span><span class="n">total_measurements</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div> <h3 id="step-4-understanding-the-nested-loop-structure"> <a href="#step-4-understanding-the-nested-loop-structure" class="anchor-heading" aria-labelledby="step-4-understanding-the-nested-loop-structure"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 4: Understanding the Nested Loop Structure </h3> <p>Before writing the full loop, let’s understand its structure with a simplified version that just prints what it would do:</p> <blockquote> <p><strong>Info: Nested Loops</strong></p> <p>A nested loop is a loop inside another loop. The inner loop runs completely for each iteration of the outer loop.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Example: Print a multiplication table
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>        <span class="c1"># Outer loop: i = 1, 2, 3
</span>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>    <span class="c1"># Inner loop: j = 1, 2, 3
</span>        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s"> × </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s"> = </span><span class="si">{</span><span class="n">i</span><span class="o">*</span><span class="n">j</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"---"</span><span class="p">)</span>  <span class="c1"># Runs after inner loop completes
</span></code></pre></div> </div> <p>Output:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 × 1 = 1
1 × 2 = 2
1 × 3 = 3
---
2 × 1 = 2
2 × 2 = 4
...
</code></pre></div> </div> <p>In our case:</p> <ul> <li><strong>Outer loop:</strong> Each plot</li> <li><strong>Inner loop:</strong> Each measurement within that plot</li> </ul> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- Preview the loop structure (no calculations) ---
</span><span class="k">print</span><span class="p">(</span><span class="s">"="</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"LOOP STRUCTURE PREVIEW"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"="</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

<span class="n">measurement_counter</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># OUTER LOOP: Each plot
</span><span class="k">for</span> <span class="n">plot_idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">metadata_df</span><span class="p">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">plot_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">'plot_id'</span><span class="p">]</span>
    <span class="n">land_use</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">'land_use'</span><span class="p">]</span>
    
    <span class="c1"># Parse the semicolon-separated values
</span>    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s">'variable'</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">)]</span>
    
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Plot </span><span class="si">{</span><span class="n">plot_id</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">land_use</span><span class="si">}</span><span class="s">): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span><span class="si">}</span><span class="s"> measurements"</span><span class="p">)</span>
    
    <span class="c1"># INNER LOOP: Each measurement for this plot
</span>    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="n">measurement_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  [</span><span class="si">{</span><span class="n">measurement_counter</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">→ Total: </span><span class="si">{</span><span class="n">measurement_counter</span><span class="si">}</span><span class="s"> measurements"</span><span class="p">)</span>
</code></pre></div></div> <div style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 5px;"> <div class="notice--primary"> <h3 id="exercise-understand-the-loop-structure"> <a href="#exercise-understand-the-loop-structure" class="anchor-heading" aria-labelledby="exercise-understand-the-loop-structure"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exercise: Understand the Loop Structure </h3> <p>Before running the full automation, let’s make sure you understand the nested loop structure.</p> <p><strong>Task:</strong> Modify the preview loop above to also count:</p> <ol> <li>How many measurements per gas type (N2O, CO2, CH4)</li> <li>How many measurements per land use (forest, grassland)</li> </ol> <p><strong>Hint:</strong> Create dictionaries like <code class="language-plaintext highlighter-rouge">gas_counts = {'N2O': 0, 'CO2': 0, 'CH4': 0}</code> and increment them inside the loop.</p> <details> <summary>Click here for the solution!</summary> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Initialize counters
</span><span class="n">gas_counts</span> <span class="o">=</span> <span class="p">{</span><span class="s">'N2O'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">'CO2'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">'CH4'</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
<span class="n">landuse_counts</span> <span class="o">=</span> <span class="p">{</span><span class="s">'forest'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">'grassland'</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

<span class="c1"># Loop through all measurements
</span><span class="k">for</span> <span class="n">plot_idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">metadata_df</span><span class="p">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">land_use</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">'land_use'</span><span class="p">]</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s">'variable'</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">)]</span>
    
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="c1"># Count by gas
</span>        <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">gas_counts</span><span class="p">:</span>
            <span class="n">gas_counts</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Count by land use
</span>        <span class="n">landuse_counts</span><span class="p">[</span><span class="n">land_use</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Measurements by Gas Type:"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">gas</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">gas_counts</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  </span><span class="si">{</span><span class="n">gas</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Measurements by Land Use:"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">lu</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">landuse_counts</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  </span><span class="si">{</span><span class="n">lu</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Total: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">gas_counts</span><span class="p">.</span><span class="n">values</span><span class="p">())</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div> </div> <p><strong>Expected Output:</strong></p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Measurements by Gas Type:
  N2O: 11
  CO2: 16
  CH4: 16

Measurements by Land Use:
  forest: 19
  grassland: 24

Total: 43
</code></pre></div> </div> </details> </div> </div> <h3 id="step-5-the-outer-loop---iterating-through-plots"> <a href="#step-5-the-outer-loop---iterating-through-plots" class="anchor-heading" aria-labelledby="step-5-the-outer-loop---iterating-through-plots"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 5: The Outer Loop - Iterating Through Plots </h3> <p>Now let’s start building the real loop. The outer loop uses <code class="language-plaintext highlighter-rouge">iterrows()</code> to go through each row (plot) in our metadata DataFrame:</p> <blockquote> <p><strong>Info: DataFrame <code class="language-plaintext highlighter-rouge">iterrows()</code></strong></p> <p><code class="language-plaintext highlighter-rouge">iterrows()</code> lets you loop through a DataFrame row by row:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="c1"># index = row number (or index label)
</span>    <span class="c1"># row = a Series containing that row's data
</span>    <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">'column_name'</span><span class="p">])</span>
</code></pre></div> </div> <p>Each <code class="language-plaintext highlighter-rouge">row</code> acts like a dictionary—access columns with <code class="language-plaintext highlighter-rouge">row['column_name']</code>.</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- Initialize ---
</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">measurement_counter</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">print</span><span class="p">(</span><span class="s">"="</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"STARTING AUTOMATED FLUX CALCULATION"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Processing </span><span class="si">{</span><span class="n">total_measurements</span><span class="si">}</span><span class="s"> measurements across </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">metadata_df</span><span class="p">)</span><span class="si">}</span><span class="s"> plots"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"="</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>

<span class="c1"># --- OUTER LOOP: Each Plot ---
</span><span class="k">for</span> <span class="n">plot_idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">metadata_df</span><span class="p">.</span><span class="n">iterrows</span><span class="p">():</span>
    
    <span class="c1"># Extract plot information
</span>    <span class="n">plot_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">'plot_id'</span><span class="p">]</span>
    <span class="n">land_use</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">'land_use'</span><span class="p">]</span>
    
    <span class="c1"># Parse semicolon-separated values into lists
</span>    <span class="n">start_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s">'start_time'</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">)]</span>
    <span class="n">end_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s">'end_time'</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">)]</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s">'variable'</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">)]</span>
    
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="si">{</span><span class="s">'='</span><span class="o">*</span><span class="mi">70</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"PLOT: </span><span class="si">{</span><span class="n">plot_id</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">land_use</span><span class="si">}</span><span class="s">)"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Measurements to process: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"="</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    
    <span class="c1"># Inner loop will go here...
</span></code></pre></div></div> <h3 id="step-6-the-inner-loop---processing-each-measurement"> <a href="#step-6-the-inner-loop---processing-each-measurement" class="anchor-heading" aria-labelledby="step-6-the-inner-loop---processing-each-measurement"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 6: The Inner Loop - Processing Each Measurement </h3> <p>Inside the outer loop, we iterate through each measurement using <code class="language-plaintext highlighter-rouge">zip()</code>:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># --- INNER LOOP: Each Measurement for This Plot ---
</span>    <span class="k">for</span> <span class="n">start_str</span><span class="p">,</span> <span class="n">end_str</span><span class="p">,</span> <span class="n">variable</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">start_times</span><span class="p">,</span> <span class="n">end_times</span><span class="p">,</span> <span class="n">variables</span><span class="p">):</span>
        
        <span class="n">measurement_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Convert string timestamps to datetime objects
</span>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">start_str</span><span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">end_str</span><span class="p">)</span>
        <span class="n">measurement_date</span> <span class="o">=</span> <span class="n">start_time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d'</span><span class="p">)</span>
        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">[</span><span class="si">{</span><span class="n">measurement_counter</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">total_measurements</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s"> | </span><span class="si">{</span><span class="n">measurement_date</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"-"</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        
        <span class="c1"># Processing steps continue here...
</span></code></pre></div></div> <h3 id="step-7-look-up-gas-configuration"> <a href="#step-7-look-up-gas-configuration" class="anchor-heading" aria-labelledby="step-7-look-up-gas-configuration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 7: Look Up Gas Configuration </h3> <p>For each measurement, we need to get the correct settings from our configuration dictionary:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1"># --- Get Gas Configuration ---
</span>        <span class="c1"># Check if this gas is in our configuration
</span>        <span class="k">if</span> <span class="n">variable</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">GAS_CONFIG</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  ✗ ERROR: Unknown gas '</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s">'. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>  <span class="c1"># Skip to next measurement
</span>        
        <span class="c1"># Look up settings for this gas
</span>        <span class="n">config</span> <span class="o">=</span> <span class="n">GAS_CONFIG</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span>
        <span class="n">df_gas</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">'dataframe'</span><span class="p">]</span>      <span class="c1"># The DataFrame containing this gas's data
</span>        <span class="n">column_name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">'column'</span><span class="p">]</span>    <span class="c1"># Column name (e.g., 'CO2_ppm')
</span>        <span class="n">slope_unit</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">'slope_unit'</span><span class="p">]</span> <span class="c1"># Unit (e.g., 'ppm')
</span>        <span class="n">display_name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">'display_name'</span><span class="p">]</span>  <span class="c1"># Pretty name (e.g., 'CO₂')
</span></code></pre></div></div> <h3 id="step-8-extract-data-for-the-time-window"> <a href="#step-8-extract-data-for-the-time-window" class="anchor-heading" aria-labelledby="step-8-extract-data-for-the-time-window"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 8: Extract Data for the Time Window </h3> <p>Now we filter the gas data to only include rows within our measurement time window:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1"># --- Extract Data for Time Window ---
</span>        <span class="c1"># Create a boolean mask for rows between start and end time
</span>        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_gas</span><span class="p">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_gas</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">end_time</span><span class="p">)</span>
        <span class="n">measurement_data</span> <span class="o">=</span> <span class="n">df_gas</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">].</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Check if we have enough data points
</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">measurement_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  ⚠ WARNING: Only </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">measurement_data</span><span class="p">)</span><span class="si">}</span><span class="s"> data points. Skipping."</span><span class="p">)</span>
            
            <span class="c1"># Still record this measurement, but mark it as failed
</span>            <span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s">'plot_id'</span><span class="p">:</span> <span class="n">plot_id</span><span class="p">,</span>
                <span class="s">'land_use'</span><span class="p">:</span> <span class="n">land_use</span><span class="p">,</span>
                <span class="s">'variable'</span><span class="p">:</span> <span class="n">variable</span><span class="p">,</span>
                <span class="s">'measurement_date'</span><span class="p">:</span> <span class="n">measurement_date</span><span class="p">,</span>
                <span class="s">'qc_pass'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                <span class="s">'flux_umol_m2_s'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span><span class="p">,</span>
                <span class="s">'note'</span><span class="p">:</span> <span class="s">'Insufficient data'</span>
            <span class="p">})</span>
            <span class="k">continue</span>  <span class="c1"># Skip to next measurement
</span>        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Data points in window: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">measurement_data</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div> <h3 id="step-9-visual-inspection"> <a href="#step-9-visual-inspection" class="anchor-heading" aria-labelledby="step-9-visual-inspection"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 9: Visual Inspection </h3> <p>We display the data so the user can inspect it before regression:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1"># --- Visual Inspection ---
</span>        <span class="c1"># Plot the data to let the user see the pattern
</span>        <span class="n">plot_time_series</span><span class="p">(</span>
            <span class="n">measurement_data</span><span class="p">,</span> 
            <span class="n">y_column</span><span class="o">=</span><span class="n">column_name</span><span class="p">,</span> 
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">display_name</span><span class="si">}</span><span class="s"> - Plot </span><span class="si">{</span><span class="n">plot_id</span><span class="si">}</span><span class="s"> - </span><span class="si">{</span><span class="n">measurement_date</span><span class="si">}</span><span class="s">'</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s">'markers'</span>
        <span class="p">)</span>
</code></pre></div></div> <h3 id="step-10-interactive-time-window-refinement"> <a href="#step-10-interactive-time-window-refinement" class="anchor-heading" aria-labelledby="step-10-interactive-time-window-refinement"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 10: Interactive Time Window Refinement </h3> <p>We may need to adjust the time window to exclude baseline or drop phases:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1"># --- Refine Time Window (Interactive) ---
</span>        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">  Current window: </span><span class="si">{</span><span class="n">start_time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%H</span><span class="si">:</span><span class="o">%</span><span class="n">M</span><span class="si">:</span><span class="o">%</span><span class="n">S</span><span class="s">')</span><span class="si">}</span><span class="s"> → </span><span class="si">{</span><span class="n">end_time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%H</span><span class="si">:</span><span class="o">%</span><span class="n">M</span><span class="si">:</span><span class="o">%</span><span class="n">S</span><span class="s">')</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"  Look at the plot and identify the LINEAR accumulation phase."</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"  Enter new times to refine, or press Enter to keep current:"</span><span class="p">)</span>
        
        <span class="n">start_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s">"    New start time (HH:MM:SS) [</span><span class="si">{</span><span class="n">start_time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%H</span><span class="si">:</span><span class="o">%</span><span class="n">M</span><span class="si">:</span><span class="o">%</span><span class="n">S</span><span class="s">')</span><span class="si">}</span><span class="s">]: "</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">end_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s">"    New end time (HH:MM:SS) [</span><span class="si">{</span><span class="n">end_time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%H</span><span class="si">:</span><span class="o">%</span><span class="n">M</span><span class="si">:</span><span class="o">%</span><span class="n">S</span><span class="s">')</span><span class="si">}</span><span class="s">]: "</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="c1"># Parse the input (keep original if empty)
</span>        <span class="k">if</span> <span class="n">start_input</span><span class="p">:</span>
            <span class="n">refined_start</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">measurement_date</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">start_input</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">refined_start</span> <span class="o">=</span> <span class="n">start_time</span>
            
        <span class="k">if</span> <span class="n">end_input</span><span class="p">:</span>
            <span class="n">refined_end</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">measurement_date</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">end_input</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">refined_end</span> <span class="o">=</span> <span class="n">end_time</span>
        
        <span class="c1"># Re-extract data with refined window
</span>        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_gas</span><span class="p">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">refined_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_gas</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">refined_end</span><span class="p">)</span>
        <span class="n">regression_data</span> <span class="o">=</span> <span class="n">df_gas</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">].</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Check again if we have enough data
</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">regression_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  ⚠ Refined window has only </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">regression_data</span><span class="p">)</span><span class="si">}</span><span class="s"> points. Skipping."</span><span class="p">)</span>
            <span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s">'plot_id'</span><span class="p">:</span> <span class="n">plot_id</span><span class="p">,</span>
                <span class="s">'land_use'</span><span class="p">:</span> <span class="n">land_use</span><span class="p">,</span>
                <span class="s">'variable'</span><span class="p">:</span> <span class="n">variable</span><span class="p">,</span>
                <span class="s">'measurement_date'</span><span class="p">:</span> <span class="n">measurement_date</span><span class="p">,</span>
                <span class="s">'qc_pass'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                <span class="s">'flux_umol_m2_s'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span><span class="p">,</span>
                <span class="s">'note'</span><span class="p">:</span> <span class="s">'Insufficient data after refinement'</span>
            <span class="p">})</span>
            <span class="k">continue</span>
</code></pre></div></div> <h3 id="step-11-perform-linear-regression"> <a href="#step-11-perform-linear-regression" class="anchor-heading" aria-labelledby="step-11-perform-linear-regression"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 11: Perform Linear Regression </h3> <p>Now we fit a line to get the slope (rate of concentration change):</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1"># --- Linear Regression ---
</span>        <span class="c1"># First, convert timestamps to "elapsed seconds" for regression
</span>        <span class="n">regression_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">regression_data</span><span class="p">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">regression_data</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nb">min</span><span class="p">()</span>
        <span class="p">).</span><span class="n">total_seconds</span><span class="p">()</span>
        
        <span class="c1"># Perform linear regression using scipy
</span>        <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">std_err</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">linregress</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">regression_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="n">regression_data</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span>
        <span class="p">)</span>
        
        <span class="c1"># Calculate R-squared
</span>        <span class="n">r_squared</span> <span class="o">=</span> <span class="n">r_value</span> <span class="o">**</span> <span class="mi">2</span>
        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">  Regression Results:"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"    Slope: </span><span class="si">{</span><span class="n">slope</span><span class="si">:</span><span class="p">.</span><span class="mi">6</span><span class="n">f</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">slope_unit</span><span class="si">}</span><span class="s">/s"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"    R²: </span><span class="si">{</span><span class="n">r_squared</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"    p-value: </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div> <h3 id="step-12-visualize-the-regression-fit"> <a href="#step-12-visualize-the-regression-fit" class="anchor-heading" aria-labelledby="step-12-visualize-the-regression-fit"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 12: Visualize the Regression Fit </h3> <p>We show the data with the fitted line overlaid:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1"># --- Visualize Regression Fit ---
</span>        <span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="n">go</span>
        
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="p">.</span><span class="n">Figure</span><span class="p">()</span>
        
        <span class="c1"># Add data points
</span>        <span class="n">fig</span><span class="p">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="p">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">regression_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="n">regression_data</span><span class="p">[</span><span class="n">column_name</span><span class="p">],</span>
            <span class="n">mode</span><span class="o">=</span><span class="s">'markers'</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s">'Measured Data'</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="p">))</span>
        
        <span class="c1"># Add fitted line
</span>        <span class="n">fig</span><span class="p">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="p">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">regression_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="n">intercept</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">regression_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">],</span>
            <span class="n">mode</span><span class="o">=</span><span class="s">'lines'</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s">'Linear Fit (R²=</span><span class="si">{</span><span class="n">r_squared</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">)'</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">'red'</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">))</span>
        
        <span class="n">fig</span><span class="p">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">display_name</span><span class="si">}</span><span class="s"> Regression - Plot </span><span class="si">{</span><span class="n">plot_id</span><span class="si">}</span><span class="s">'</span><span class="p">,</span>
            <span class="n">xaxis_title</span><span class="o">=</span><span class="s">'Elapsed Time (seconds)'</span><span class="p">,</span>
            <span class="n">yaxis_title</span><span class="o">=</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">display_name</span><span class="si">}</span><span class="s"> Concentration (</span><span class="si">{</span><span class="n">slope_unit</span><span class="si">}</span><span class="s">)'</span><span class="p">,</span>
            <span class="n">template</span><span class="o">=</span><span class="s">'plotly_white'</span>
        <span class="p">)</span>
        
        <span class="n">fig</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div> <h3 id="step-13-quality-control"> <a href="#step-13-quality-control" class="anchor-heading" aria-labelledby="step-13-quality-control"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 13: Quality Control </h3> <p>We check if the regression meets our thresholds:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1"># --- Quality Control ---
</span>        <span class="k">if</span> <span class="n">r_squared</span> <span class="o">&lt;</span> <span class="n">R_SQUARED_THRESHOLD</span> <span class="ow">or</span> <span class="n">p_value</span> <span class="o">&gt;</span> <span class="n">P_VALUE_THRESHOLD</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  ✗ QC FAILED: R²=</span><span class="si">{</span><span class="n">r_squared</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s"> or p=</span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s"> outside thresholds"</span><span class="p">)</span>
            <span class="n">qc_pass</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span>
            <span class="n">note</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'QC failed: R²=</span><span class="si">{</span><span class="n">r_squared</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">, p=</span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  ✓ QC PASSED"</span><span class="p">)</span>
            <span class="n">qc_pass</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">note</span> <span class="o">=</span> <span class="s">''</span>
            
            <span class="c1"># Proceed to flux calculation...
</span></code></pre></div></div> <h3 id="step-14-calculate-flux-if-qc-passed"> <a href="#step-14-calculate-flux-if-qc-passed" class="anchor-heading" aria-labelledby="step-14-calculate-flux-if-qc-passed"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 14: Calculate Flux (if QC passed) </h3> <p>If quality control passed, we calculate the flux:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="c1"># --- Calculate Flux ---
</span>            <span class="c1"># Get mean temperature during measurement
</span>            <span class="n">avg_temp_c</span> <span class="o">=</span> <span class="n">regression_data</span><span class="p">[</span><span class="s">'Ta_C'</span><span class="p">].</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">avg_temp_k</span> <span class="o">=</span> <span class="n">avg_temp_c</span> <span class="o">+</span> <span class="mf">273.15</span>  <span class="c1"># Convert to Kelvin
</span>            
            <span class="c1"># Calculate flux using our function from Section 3
</span>            <span class="n">flux</span> <span class="o">=</span> <span class="n">calculate_flux</span><span class="p">(</span>
                <span class="n">slope</span><span class="o">=</span><span class="n">slope</span><span class="p">,</span>
                <span class="n">temp_k</span><span class="o">=</span><span class="n">avg_temp_k</span><span class="p">,</span>
                <span class="n">pressure_atm</span><span class="o">=</span><span class="n">PRESSURE_ATM</span><span class="p">,</span>
                <span class="n">volume_L</span><span class="o">=</span><span class="n">CHAMBER_VOLUME_L</span><span class="p">,</span>
                <span class="n">area_m2</span><span class="o">=</span><span class="n">COLLAR_AREA_M2</span><span class="p">,</span>
                <span class="n">slope_unit</span><span class="o">=</span><span class="n">slope_unit</span>
            <span class="p">)</span>
            
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">  Flux Calculation:"</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"    Temperature: </span><span class="si">{</span><span class="n">avg_temp_c</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">°C = </span><span class="si">{</span><span class="n">avg_temp_k</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> K"</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"    </span><span class="si">{</span><span class="n">display_name</span><span class="si">}</span><span class="s"> Flux: </span><span class="si">{</span><span class="n">flux</span><span class="si">:</span><span class="p">.</span><span class="mi">6</span><span class="n">f</span><span class="si">}</span><span class="s"> µmol m⁻² s⁻¹"</span><span class="p">)</span>
</code></pre></div></div> <h3 id="step-15-store-results"> <a href="#step-15-store-results" class="anchor-heading" aria-labelledby="step-15-store-results"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 15: Store Results </h3> <p>Finally, we save all the information for this measurement:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1"># --- Store Results ---
</span>        <span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s">'plot_id'</span><span class="p">:</span> <span class="n">plot_id</span><span class="p">,</span>
            <span class="s">'land_use'</span><span class="p">:</span> <span class="n">land_use</span><span class="p">,</span>
            <span class="s">'variable'</span><span class="p">:</span> <span class="n">variable</span><span class="p">,</span>
            <span class="s">'measurement_date'</span><span class="p">:</span> <span class="n">measurement_date</span><span class="p">,</span>
            <span class="s">'start_time'</span><span class="p">:</span> <span class="n">refined_start</span><span class="p">,</span>
            <span class="s">'end_time'</span><span class="p">:</span> <span class="n">refined_end</span><span class="p">,</span>
            <span class="s">'slope'</span><span class="p">:</span> <span class="n">slope</span><span class="p">,</span>
            <span class="s">'slope_unit'</span><span class="p">:</span> <span class="n">slope_unit</span><span class="p">,</span>
            <span class="s">'r_squared'</span><span class="p">:</span> <span class="n">r_squared</span><span class="p">,</span>
            <span class="s">'p_value'</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
            <span class="s">'qc_pass'</span><span class="p">:</span> <span class="n">qc_pass</span><span class="p">,</span>
            <span class="s">'flux_umol_m2_s'</span><span class="p">:</span> <span class="n">flux</span><span class="p">,</span>
            <span class="s">'note'</span><span class="p">:</span> <span class="n">note</span>
        <span class="p">})</span>
</code></pre></div></div> <h3 id="44-the-complete-processing-script"> <a href="#44-the-complete-processing-script" class="anchor-heading" aria-labelledby="44-the-complete-processing-script"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4.4 The Complete Processing Script </h3> <p>Now that we understand each piece, here’s the complete script. All the steps above are combined into one runnable block:</p> <div style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 5px;"> <div class="notice--primary"> <h3 id="exercise-run-the-complete-pipeline"> <a href="#exercise-run-the-complete-pipeline" class="anchor-heading" aria-labelledby="exercise-run-the-complete-pipeline"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exercise: Run the Complete Pipeline </h3> <p>Run the complete code below. Process all measurements to get familiar with the pipline and get the result.</p> <p><strong>Tips for visual inspection:</strong></p> <ul> <li>Look for the <strong>linear accumulation phase</strong> (steady increase)</li> <li>Exclude the <strong>baseline</strong> (flat part before chamber closes)</li> <li>Exclude the <strong>drop</strong> (sudden decrease when chamber opens)</li> <li>If the data looks good, just press Enter to keep the original times</li> </ul> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="n">go</span>

<span class="c1"># ============================================================
# AUTOMATED FLUX CALCULATION - COMPLETE SCRIPT
# ============================================================
</span>
<span class="c1"># --- Initialize ---
</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">measurement_counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">total_measurements</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">'variable'</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">metadata_df</span><span class="p">.</span><span class="n">iterrows</span><span class="p">())</span>

<span class="k">print</span><span class="p">(</span><span class="s">"="</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"AUTOMATED FLUX CALCULATION"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Processing </span><span class="si">{</span><span class="n">total_measurements</span><span class="si">}</span><span class="s"> measurements across </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">metadata_df</span><span class="p">)</span><span class="si">}</span><span class="s"> plots"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"="</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>

<span class="c1"># --- OUTER LOOP: Each Plot ---
</span><span class="k">for</span> <span class="n">plot_idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">metadata_df</span><span class="p">.</span><span class="n">iterrows</span><span class="p">():</span>
    
    <span class="n">plot_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">'plot_id'</span><span class="p">]</span>
    <span class="n">land_use</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">'land_use'</span><span class="p">]</span>
    
    <span class="c1"># Parse semicolon-separated values
</span>    <span class="n">start_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s">'start_time'</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">)]</span>
    <span class="n">end_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s">'end_time'</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">)]</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s">'variable'</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">)]</span>
    
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="si">{</span><span class="s">'='</span><span class="o">*</span><span class="mi">70</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"PLOT: </span><span class="si">{</span><span class="n">plot_id</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">land_use</span><span class="si">}</span><span class="s">) - </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span><span class="si">}</span><span class="s"> measurements"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"="</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    
    <span class="c1"># --- INNER LOOP: Each Measurement ---
</span>    <span class="k">for</span> <span class="n">start_str</span><span class="p">,</span> <span class="n">end_str</span><span class="p">,</span> <span class="n">variable</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">start_times</span><span class="p">,</span> <span class="n">end_times</span><span class="p">,</span> <span class="n">variables</span><span class="p">):</span>
        
        <span class="n">measurement_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">start_str</span><span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">end_str</span><span class="p">)</span>
        <span class="n">measurement_date</span> <span class="o">=</span> <span class="n">start_time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%Y-%m-%d'</span><span class="p">)</span>
        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">[</span><span class="si">{</span><span class="n">measurement_counter</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">total_measurements</span><span class="si">}</span><span class="s">] </span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s"> | </span><span class="si">{</span><span class="n">measurement_date</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"-"</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        
        <span class="c1"># --- Get gas configuration ---
</span>        <span class="k">if</span> <span class="n">variable</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">GAS_CONFIG</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  ✗ Unknown gas '</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s">'. Skipping."</span><span class="p">)</span>
            <span class="k">continue</span>
        
        <span class="n">config</span> <span class="o">=</span> <span class="n">GAS_CONFIG</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span>
        <span class="n">df_gas</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">'dataframe'</span><span class="p">]</span>
        <span class="n">column_name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">'column'</span><span class="p">]</span>
        <span class="n">slope_unit</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">'slope_unit'</span><span class="p">]</span>
        <span class="n">display_name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">'display_name'</span><span class="p">]</span>
        
        <span class="c1"># --- Extract data ---
</span>        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_gas</span><span class="p">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_gas</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">end_time</span><span class="p">)</span>
        <span class="n">measurement_data</span> <span class="o">=</span> <span class="n">df_gas</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">].</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">measurement_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  ⚠ Only </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">measurement_data</span><span class="p">)</span><span class="si">}</span><span class="s"> points. Skipping."</span><span class="p">)</span>
            <span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s">'plot_id'</span><span class="p">:</span> <span class="n">plot_id</span><span class="p">,</span> <span class="s">'land_use'</span><span class="p">:</span> <span class="n">land_use</span><span class="p">,</span> <span class="s">'variable'</span><span class="p">:</span> <span class="n">variable</span><span class="p">,</span>
                <span class="s">'measurement_date'</span><span class="p">:</span> <span class="n">measurement_date</span><span class="p">,</span> <span class="s">'slope'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span><span class="p">,</span>
                <span class="s">'slope_unit'</span><span class="p">:</span> <span class="n">slope_unit</span><span class="p">,</span> <span class="s">'r_squared'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span><span class="p">,</span> <span class="s">'p_value'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span><span class="p">,</span>
                <span class="s">'qc_pass'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">'flux_umol_m2_s'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span><span class="p">,</span> <span class="s">'note'</span><span class="p">:</span> <span class="s">'Insufficient data'</span>
            <span class="p">})</span>
            <span class="k">continue</span>
        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Data points: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">measurement_data</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="c1"># --- Visual inspection ---
</span>        <span class="n">plot_time_series</span><span class="p">(</span><span class="n">measurement_data</span><span class="p">,</span> <span class="n">y_column</span><span class="o">=</span><span class="n">column_name</span><span class="p">,</span> 
                        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">display_name</span><span class="si">}</span><span class="s"> - Plot </span><span class="si">{</span><span class="n">plot_id</span><span class="si">}</span><span class="s"> - </span><span class="si">{</span><span class="n">measurement_date</span><span class="si">}</span><span class="s">'</span><span class="p">,</span>
                        <span class="n">mode</span><span class="o">=</span><span class="s">'markers'</span><span class="p">)</span>
        
        <span class="c1"># --- Refine time window ---
</span>        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">  Window: </span><span class="si">{</span><span class="n">start_time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%H</span><span class="si">:</span><span class="o">%</span><span class="n">M</span><span class="si">:</span><span class="o">%</span><span class="n">S</span><span class="s">')</span><span class="si">}</span><span class="s"> → </span><span class="si">{</span><span class="n">end_time</span><span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">'%H</span><span class="si">:</span><span class="o">%</span><span class="n">M</span><span class="si">:</span><span class="o">%</span><span class="n">S</span><span class="s">')</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">start_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s">"    New start (HH:MM:SS) or Enter to keep: "</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">end_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s">"    New end (HH:MM:SS) or Enter to keep: "</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="n">refined_start</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">measurement_date</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">start_input</span><span class="si">}</span><span class="s">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">start_input</span> <span class="k">else</span> <span class="n">start_time</span>
        <span class="n">refined_end</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">measurement_date</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">end_input</span><span class="si">}</span><span class="s">"</span><span class="p">)</span> <span class="k">if</span> <span class="n">end_input</span> <span class="k">else</span> <span class="n">end_time</span>
        
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_gas</span><span class="p">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">refined_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_gas</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">refined_end</span><span class="p">)</span>
        <span class="n">regression_data</span> <span class="o">=</span> <span class="n">df_gas</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">].</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">regression_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  ⚠ Refined window too small. Skipping."</span><span class="p">)</span>
            <span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s">'plot_id'</span><span class="p">:</span> <span class="n">plot_id</span><span class="p">,</span> <span class="s">'land_use'</span><span class="p">:</span> <span class="n">land_use</span><span class="p">,</span> <span class="s">'variable'</span><span class="p">:</span> <span class="n">variable</span><span class="p">,</span>
                <span class="s">'measurement_date'</span><span class="p">:</span> <span class="n">measurement_date</span><span class="p">,</span> <span class="s">'slope'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span><span class="p">,</span>
                <span class="s">'slope_unit'</span><span class="p">:</span> <span class="n">slope_unit</span><span class="p">,</span> <span class="s">'r_squared'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span><span class="p">,</span> <span class="s">'p_value'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span><span class="p">,</span>
                <span class="s">'qc_pass'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">'flux_umol_m2_s'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span><span class="p">,</span> <span class="s">'note'</span><span class="p">:</span> <span class="s">'Insufficient data after refinement'</span>
            <span class="p">})</span>
            <span class="k">continue</span>
        
        <span class="c1"># --- Linear regression ---
</span>        <span class="n">regression_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">regression_data</span><span class="p">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">regression_data</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nb">min</span><span class="p">()</span>
        <span class="p">).</span><span class="n">total_seconds</span><span class="p">()</span>
        
        <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">std_err</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">linregress</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">regression_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="n">regression_data</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">r_squared</span> <span class="o">=</span> <span class="n">r_value</span> <span class="o">**</span> <span class="mi">2</span>
        
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">  Slope: </span><span class="si">{</span><span class="n">slope</span><span class="si">:</span><span class="p">.</span><span class="mi">6</span><span class="n">f</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">slope_unit</span><span class="si">}</span><span class="s">/s | R²: </span><span class="si">{</span><span class="n">r_squared</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> | p: </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">e</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        
        <span class="c1"># --- Visualize fit ---
</span>        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="p">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="n">fig</span><span class="p">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="p">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">regression_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">],</span> 
                                  <span class="n">y</span><span class="o">=</span><span class="n">regression_data</span><span class="p">[</span><span class="n">column_name</span><span class="p">],</span>
                                  <span class="n">mode</span><span class="o">=</span><span class="s">'markers'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'Data'</span><span class="p">))</span>
        <span class="n">fig</span><span class="p">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="p">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">regression_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">],</span>
                                  <span class="n">y</span><span class="o">=</span><span class="n">intercept</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">regression_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">],</span>
                                  <span class="n">mode</span><span class="o">=</span><span class="s">'lines'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s">'Fit (R²=</span><span class="si">{</span><span class="n">r_squared</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">)'</span><span class="p">,</span>
                                  <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">'red'</span><span class="p">)))</span>
        <span class="n">fig</span><span class="p">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">display_name</span><span class="si">}</span><span class="s"> Regression - Plot </span><span class="si">{</span><span class="n">plot_id</span><span class="si">}</span><span class="s">'</span><span class="p">,</span>
                         <span class="n">xaxis_title</span><span class="o">=</span><span class="s">'Elapsed Time (s)'</span><span class="p">,</span>
                         <span class="n">yaxis_title</span><span class="o">=</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">display_name</span><span class="si">}</span><span class="s"> (</span><span class="si">{</span><span class="n">slope_unit</span><span class="si">}</span><span class="s">)'</span><span class="p">,</span>
                         <span class="n">template</span><span class="o">=</span><span class="s">'plotly_white'</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
        
        <span class="c1"># --- Quality control ---
</span>        <span class="k">if</span> <span class="n">r_squared</span> <span class="o">&lt;</span> <span class="n">R_SQUARED_THRESHOLD</span> <span class="ow">or</span> <span class="n">p_value</span> <span class="o">&gt;</span> <span class="n">P_VALUE_THRESHOLD</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  ✗ QC FAILED"</span><span class="p">)</span>
            <span class="n">qc_pass</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">note</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span><span class="p">,</span> <span class="sa">f</span><span class="s">'QC failed: R²=</span><span class="si">{</span><span class="n">r_squared</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s">'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  ✓ QC PASSED"</span><span class="p">)</span>
            <span class="n">qc_pass</span><span class="p">,</span> <span class="n">note</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="s">''</span>
            
            <span class="n">avg_temp_c</span> <span class="o">=</span> <span class="n">regression_data</span><span class="p">[</span><span class="s">'Ta_C'</span><span class="p">].</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">avg_temp_k</span> <span class="o">=</span> <span class="n">avg_temp_c</span> <span class="o">+</span> <span class="mf">273.15</span>
            
            <span class="n">flux</span> <span class="o">=</span> <span class="n">calculate_flux</span><span class="p">(</span>
                <span class="n">slope</span><span class="o">=</span><span class="n">slope</span><span class="p">,</span> <span class="n">temp_k</span><span class="o">=</span><span class="n">avg_temp_k</span><span class="p">,</span> <span class="n">pressure_atm</span><span class="o">=</span><span class="n">PRESSURE_ATM</span><span class="p">,</span>
                <span class="n">volume_L</span><span class="o">=</span><span class="n">CHAMBER_VOLUME_L</span><span class="p">,</span> <span class="n">area_m2</span><span class="o">=</span><span class="n">COLLAR_AREA_M2</span><span class="p">,</span>
                <span class="n">slope_unit</span><span class="o">=</span><span class="n">slope_unit</span>
            <span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  </span><span class="si">{</span><span class="n">display_name</span><span class="si">}</span><span class="s"> Flux: </span><span class="si">{</span><span class="n">flux</span><span class="si">:</span><span class="p">.</span><span class="mi">6</span><span class="n">f</span><span class="si">}</span><span class="s"> µmol m⁻² s⁻¹"</span><span class="p">)</span>
        
        <span class="c1"># --- Store results ---
</span>        <span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s">'plot_id'</span><span class="p">:</span> <span class="n">plot_id</span><span class="p">,</span> <span class="s">'land_use'</span><span class="p">:</span> <span class="n">land_use</span><span class="p">,</span> <span class="s">'variable'</span><span class="p">:</span> <span class="n">variable</span><span class="p">,</span>
            <span class="s">'measurement_date'</span><span class="p">:</span> <span class="n">measurement_date</span><span class="p">,</span> <span class="s">'slope'</span><span class="p">:</span> <span class="n">slope</span><span class="p">,</span>
            <span class="s">'slope_unit'</span><span class="p">:</span> <span class="n">slope_unit</span><span class="p">,</span> <span class="s">'r_squared'</span><span class="p">:</span> <span class="n">r_squared</span><span class="p">,</span> <span class="s">'p_value'</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
            <span class="s">'qc_pass'</span><span class="p">:</span> <span class="n">qc_pass</span><span class="p">,</span> <span class="s">'flux_umol_m2_s'</span><span class="p">:</span> <span class="n">flux</span><span class="p">,</span> <span class="s">'note'</span><span class="p">:</span> <span class="n">note</span>
        <span class="p">})</span>

<span class="c1"># --- Convert to DataFrame ---
</span><span class="n">flux_results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span> <span class="o">+</span> <span class="s">"="</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"PROCESSING COMPLETE"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"="</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Total processed: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">flux_results_df</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"QC passed: </span><span class="si">{</span><span class="n">flux_results_df</span><span class="p">[</span><span class="s">'qc_pass'</span><span class="p">].</span><span class="nb">sum</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"QC failed: </span><span class="si">{</span><span class="p">(</span><span class="o">~</span><span class="n">flux_results_df</span><span class="p">[</span><span class="s">'qc_pass'</span><span class="p">]).</span><span class="nb">sum</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div> </div> </div> <h3 id="45-analyzing-the-results"> <a href="#45-analyzing-the-results" class="anchor-heading" aria-labelledby="45-analyzing-the-results"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4.5 Analyzing the Results </h3> <p>After processing all measurements, we have a complete DataFrame of results. Let’s analyze it!</p> <h3 id="viewing-the-results"> <a href="#viewing-the-results" class="anchor-heading" aria-labelledby="viewing-the-results"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Viewing the Results </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Display key columns
</span><span class="n">display_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'plot_id'</span><span class="p">,</span> <span class="s">'land_use'</span><span class="p">,</span> <span class="s">'variable'</span><span class="p">,</span> <span class="s">'measurement_date'</span><span class="p">,</span> 
                <span class="s">'r_squared'</span><span class="p">,</span> <span class="s">'qc_pass'</span><span class="p">,</span> <span class="s">'flux_umol_m2_s'</span><span class="p">]</span>

<span class="c1"># Sort by variable, then plot, then date
</span><span class="n">flux_results_df</span><span class="p">[</span><span class="n">display_cols</span><span class="p">].</span><span class="n">sort_values</span><span class="p">([</span><span class="s">'variable'</span><span class="p">,</span> <span class="s">'plot_id'</span><span class="p">,</span> <span class="s">'measurement_date'</span><span class="p">])</span>
</code></pre></div></div> <h3 id="summary-statistics-by-gas-type"> <a href="#summary-statistics-by-gas-type" class="anchor-heading" aria-labelledby="summary-statistics-by-gas-type"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Summary Statistics by Gas Type </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">"="</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"FLUX SUMMARY BY GAS TYPE"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"="</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

<span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">flux_results_df</span><span class="p">[</span><span class="s">'variable'</span><span class="p">].</span><span class="n">unique</span><span class="p">():</span>
    <span class="c1"># Filter to QC-passed measurements of this gas
</span>    <span class="n">df_var</span> <span class="o">=</span> <span class="n">flux_results_df</span><span class="p">[</span>
        <span class="p">(</span><span class="n">flux_results_df</span><span class="p">[</span><span class="s">'variable'</span><span class="p">]</span> <span class="o">==</span> <span class="n">variable</span><span class="p">)</span> <span class="o">&amp;</span> 
        <span class="p">(</span><span class="n">flux_results_df</span><span class="p">[</span><span class="s">'qc_pass'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>
    <span class="p">]</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_var</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">display_name</span> <span class="o">=</span> <span class="n">GAS_CONFIG</span><span class="p">[</span><span class="n">variable</span><span class="p">][</span><span class="s">'display_name'</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="si">{</span><span class="n">display_name</span><span class="si">}</span><span class="s">:"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Valid measurements: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_var</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Mean flux:  </span><span class="si">{</span><span class="n">df_var</span><span class="p">[</span><span class="s">'flux_umol_m2_s'</span><span class="p">].</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="p">.</span><span class="mi">6</span><span class="n">f</span><span class="si">}</span><span class="s"> µmol m⁻² s⁻¹"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Std dev:    </span><span class="si">{</span><span class="n">df_var</span><span class="p">[</span><span class="s">'flux_umol_m2_s'</span><span class="p">].</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="p">.</span><span class="mi">6</span><span class="n">f</span><span class="si">}</span><span class="s"> µmol m⁻² s⁻¹"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Min:        </span><span class="si">{</span><span class="n">df_var</span><span class="p">[</span><span class="s">'flux_umol_m2_s'</span><span class="p">].</span><span class="nb">min</span><span class="p">()</span><span class="si">:</span><span class="p">.</span><span class="mi">6</span><span class="n">f</span><span class="si">}</span><span class="s"> µmol m⁻² s⁻¹"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Max:        </span><span class="si">{</span><span class="n">df_var</span><span class="p">[</span><span class="s">'flux_umol_m2_s'</span><span class="p">].</span><span class="nb">max</span><span class="p">()</span><span class="si">:</span><span class="p">.</span><span class="mi">6</span><span class="n">f</span><span class="si">}</span><span class="s"> µmol m⁻² s⁻¹"</span><span class="p">)</span>
</code></pre></div></div> <div style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 5px;"> <div class="notice--primary"> <h3 id="exercise-investigate-your-results"> <a href="#exercise-investigate-your-results" class="anchor-heading" aria-labelledby="exercise-investigate-your-results"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exercise: Investigate Your Results </h3> <p>Using the <code class="language-plaintext highlighter-rouge">flux_results_df</code> DataFrame, answer these questions:</p> <ol> <li>What percentage of measurements passed QC?</li> <li>Which plot had the highest CO₂ flux? On which date?</li> <li>What was the average R² for measurements that passed QC?</li> <li>Are there any patterns in which measurements failed QC?</li> </ol> <details> <summary>Click here for the solution!</summary> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1. QC pass rate
</span><span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">flux_results_df</span><span class="p">)</span>
<span class="n">passed</span> <span class="o">=</span> <span class="n">flux_results_df</span><span class="p">[</span><span class="s">'qc_pass'</span><span class="p">].</span><span class="nb">sum</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"QC Pass Rate: </span><span class="si">{</span><span class="n">passed</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s"> = </span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="n">passed</span><span class="o">/</span><span class="n">total</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">%"</span><span class="p">)</span>

<span class="c1"># 2. Highest CO2 flux
</span><span class="n">co2_valid</span> <span class="o">=</span> <span class="n">flux_results_df</span><span class="p">[</span>
    <span class="p">(</span><span class="n">flux_results_df</span><span class="p">[</span><span class="s">'variable'</span><span class="p">]</span> <span class="o">==</span> <span class="s">'CO2'</span><span class="p">)</span> <span class="o">&amp;</span> 
    <span class="p">(</span><span class="n">flux_results_df</span><span class="p">[</span><span class="s">'qc_pass'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>
<span class="p">]</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">co2_valid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">max_idx</span> <span class="o">=</span> <span class="n">co2_valid</span><span class="p">[</span><span class="s">'flux_umol_m2_s'</span><span class="p">].</span><span class="n">idxmax</span><span class="p">()</span>
    <span class="n">max_row</span> <span class="o">=</span> <span class="n">co2_valid</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">max_idx</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Highest CO₂ flux:"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Plot: </span><span class="si">{</span><span class="n">max_row</span><span class="p">[</span><span class="s">'plot_id'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Date: </span><span class="si">{</span><span class="n">max_row</span><span class="p">[</span><span class="s">'measurement_date'</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Flux: </span><span class="si">{</span><span class="n">max_row</span><span class="p">[</span><span class="s">'flux_umol_m2_s'</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> µmol m⁻² s⁻¹"</span><span class="p">)</span>

<span class="c1"># 3. Average R² for passed measurements
</span><span class="n">passed_df</span> <span class="o">=</span> <span class="n">flux_results_df</span><span class="p">[</span><span class="n">flux_results_df</span><span class="p">[</span><span class="s">'qc_pass'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Average R² (passed): </span><span class="si">{</span><span class="n">passed_df</span><span class="p">[</span><span class="s">'r_squared'</span><span class="p">].</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># 4. Analyze failures
</span><span class="n">failed_df</span> <span class="o">=</span> <span class="n">flux_results_df</span><span class="p">[</span><span class="n">flux_results_df</span><span class="p">[</span><span class="s">'qc_pass'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">QC Failures:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  By variable: </span><span class="si">{</span><span class="n">failed_df</span><span class="p">[</span><span class="s">'variable'</span><span class="p">].</span><span class="n">value_counts</span><span class="p">().</span><span class="n">to_dict</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  By land use: </span><span class="si">{</span><span class="n">failed_df</span><span class="p">[</span><span class="s">'land_use'</span><span class="p">].</span><span class="n">value_counts</span><span class="p">().</span><span class="n">to_dict</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Reasons: </span><span class="si">{</span><span class="n">failed_df</span><span class="p">[</span><span class="s">'note'</span><span class="p">].</span><span class="n">value_counts</span><span class="p">().</span><span class="n">to_dict</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div> </div> </details> </div> </div> <h3 id="46-comparing-fluxes-across-land-use-types"> <a href="#46-comparing-fluxes-across-land-use-types" class="anchor-heading" aria-labelledby="46-comparing-fluxes-across-land-use-types"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4.6 Comparing Fluxes Across Land Use Types </h3> <p>The key scientific question: <strong>Do forest and grassland ecosystems have different gas fluxes?</strong></p> <h3 id="creating-box-plot-comparisons"> <a href="#creating-box-plot-comparisons" class="anchor-heading" aria-labelledby="creating-box-plot-comparisons"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Creating Box Plot Comparisons </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1"># Filter to QC-passed only
</span><span class="n">df_valid</span> <span class="o">=</span> <span class="n">flux_results_df</span><span class="p">[</span><span class="n">flux_results_df</span><span class="p">[</span><span class="s">'qc_pass'</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">].</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Get unique variables
</span><span class="n">variables</span> <span class="o">=</span> <span class="n">df_valid</span><span class="p">[</span><span class="s">'variable'</span><span class="p">].</span><span class="n">unique</span><span class="p">()</span>
<span class="n">n_vars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span>

<span class="c1"># Create subplots - one for each gas
</span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_vars</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">n_vars</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Handle case of single variable
</span><span class="k">if</span> <span class="n">n_vars</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">variable</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">variables</span><span class="p">):</span>
    <span class="n">df_var</span> <span class="o">=</span> <span class="n">df_valid</span><span class="p">[</span><span class="n">df_valid</span><span class="p">[</span><span class="s">'variable'</span><span class="p">]</span> <span class="o">==</span> <span class="n">variable</span><span class="p">]</span>
    <span class="n">display_name</span> <span class="o">=</span> <span class="n">GAS_CONFIG</span><span class="p">[</span><span class="n">variable</span><span class="p">][</span><span class="s">'display_name'</span><span class="p">]</span>
    
    <span class="c1"># Box plot showing distribution
</span>    <span class="n">sns</span><span class="p">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_var</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">'land_use'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'flux_umol_m2_s'</span><span class="p">,</span> 
                <span class="n">palette</span><span class="o">=</span><span class="s">'viridis'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    
    <span class="c1"># Overlay individual data points
</span>    <span class="n">sns</span><span class="p">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_var</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">'land_use'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'flux_umol_m2_s'</span><span class="p">,</span>
                  <span class="n">color</span><span class="o">=</span><span class="s">'black'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="p">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">display_name</span><span class="si">}</span><span class="s"> Flux by Land Use'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">'Land Use'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">'Flux (µmol m⁻² s⁻¹)'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s">'y'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">'--'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div> <h3 id="47-exporting-results"> <a href="#47-exporting-results" class="anchor-heading" aria-labelledby="47-exporting-results"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4.7 Exporting Results </h3> <p>Finally, save your results for future use or reporting:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Export full results
</span><span class="n">flux_results_df</span><span class="p">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">'flux_results.csv'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Saved: flux_results.csv"</span><span class="p">)</span>

<span class="c1"># Export summary by gas and land use
</span><span class="n">summary</span> <span class="o">=</span> <span class="n">df_valid</span><span class="p">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'variable'</span><span class="p">,</span> <span class="s">'land_use'</span><span class="p">]).</span><span class="n">agg</span><span class="p">({</span>
    <span class="s">'flux_umol_m2_s'</span><span class="p">:</span> <span class="p">[</span><span class="s">'count'</span><span class="p">,</span> <span class="s">'mean'</span><span class="p">,</span> <span class="s">'std'</span><span class="p">,</span> <span class="s">'min'</span><span class="p">,</span> <span class="s">'max'</span><span class="p">]</span>
<span class="p">}).</span><span class="nb">round</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="n">summary</span><span class="p">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">'n'</span><span class="p">,</span> <span class="s">'mean'</span><span class="p">,</span> <span class="s">'std'</span><span class="p">,</span> <span class="s">'min'</span><span class="p">,</span> <span class="s">'max'</span><span class="p">]</span>
<span class="n">summary</span><span class="p">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s">'flux_summary.csv'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Saved: flux_summary.csv"</span><span class="p">)</span>

<span class="n">summary</span>
</code></pre></div></div> </main> <hr> <footer> <div class="d-md-none"> <div class="mt-4 fs-2"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </div> </div> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
