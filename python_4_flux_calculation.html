<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/New_BAI_DataAnalysis/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/New_BAI_DataAnalysis/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li:not(:nth-child(5)) > a, .site-nav > ul.nav-list:first-child > li > ul > li a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(5) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(5) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(5) > ul.nav-list { display: block; } </style> <script src="/New_BAI_DataAnalysis/assets/js/vendor/lunr.min.js"></script> <script src="/New_BAI_DataAnalysis/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>FLUX CALCULATION | Data Analysis for Ecologist</title> <meta name="generator" content="Jekyll v3.10.0" /> <meta property="og:title" content="FLUX CALCULATION" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="A tutorial for starters learning how to use python to munipulate climate data!" /> <meta property="og:description" content="A tutorial for starters learning how to use python to munipulate climate data!" /> <link rel="canonical" href="https://ericluoyuu.github.io/New_BAI_DataAnalysis/python_4_flux_calculation.html" /> <meta property="og:url" content="https://ericluoyuu.github.io/New_BAI_DataAnalysis/python_4_flux_calculation.html" /> <meta property="og:site_name" content="Data Analysis for Ecologist" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="FLUX CALCULATION" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"A tutorial for starters learning how to use python to munipulate climate data!","headline":"FLUX CALCULATION","url":"https://ericluoyuu.github.io/New_BAI_DataAnalysis/python_4_flux_calculation.html"}</script> <!-- End Jekyll SEO tag --> </head> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']], displayMath: [ ['$$', '$$'] ], processEscapes: true, processEnvironments: true } }); </script> <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"> </script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"> </script> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/New_BAI_DataAnalysis/" class="site-title lh-tight"> Data Analysis for Ecologist </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/New_BAI_DataAnalysis/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/New_BAI_DataAnalysis/python_0_installation.html" class="nav-list-link">0. INSTALLATION</a></li><li class="nav-list-item"><a href="/New_BAI_DataAnalysis/python_1_basics.html" class="nav-list-link">1. BASICS OF PYTHON</a></li><li class="nav-list-item"><a href="/New_BAI_DataAnalysis/python_2_data_visualization.html" class="nav-list-link">2. DATA HANDLING AND VISUALIZATION</a></li><li class="nav-list-item"><a href="/New_BAI_DataAnalysis/python_4_flux_calculation.html" class="nav-list-link">3. FLUX CALCULATION</a></li><li class="nav-list-item"><a href="/New_BAI_DataAnalysis/python_3_interpolation_gapfilling.html" class="nav-list-link">3. INTERPOLATION AND GAP FILLING</a></li><li class="nav-list-item"><a href="/New_BAI_DataAnalysis/python_4_extreme_detection.html" class="nav-list-link">4. EXTREME VALUE DETECTION</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Data Analysis for Ecologist" aria-label="Search Data Analysis for Ecologist" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div class="main-content-wrap"> <div id="main-content" class="main-content"> <main> <h1 id="fluxes-calculation"> <a href="#fluxes-calculation" class="anchor-heading" aria-labelledby="fluxes-calculation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <strong>Fluxes Calculation</strong> </h1> <p>In this tutorial, we’re going to analyze the data you collected on your field trip to the Lüner forest! Your instruments measured raw gas concentrations, but as ecologists, we need to turn that into gas fluxes. Why? Because fluxes represent a rate—the speed at which gases are being exchanged. With CO₂ fluxes, we can estimate crucial metrics like ecosystem respiration (RECO) and net ecosystem exchange (NEE). With fluxes of a potent greenhouse gas like Nitrous Oxide (N₂O), we can understand a key part of the nitrogen cycle. This guide will walk you through the entire process: from cleaning the raw concentration data, to calculating meaningful fluxes, and finally to comparing the results between different land cover types.</p> <blockquote> <p><strong>Notice:</strong></p> <p>In all following sections I will insert some code snippets. You are very much encouraged to copy and paste them with the button on the top right and run them in your IDE (e.g. Spyder, vscode).</p> </blockquote> <h3 id="table-of-contents"> <a href="#table-of-contents" class="anchor-heading" aria-labelledby="table-of-contents"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of Contents </h3> <ol> <li><a href="#1-Loading-and-Exploring-Raw-Data">Read in and Merge Data Files</a></li> <li><a href="#2-Loading-and-Exploring-Raw-Data">Loading and Exploring Raw Data</a></li> <li><a href="#3-Filtering-and-Cleaning">Filtering and Cleaning</a></li> <li><a href="#4-Understanding-the-Data-Pattern">Understanding the Data Pattern</a></li> <li><a href="#5-Calculating-Flux-for-a-Single-Plot">Calculating Flux for a Single Plot</a></li> <li><a href="#6-Automating-Calculations-for-all-plots">Automating Calculations for all plots</a></li> <li><a href="#7-Comparing-Results">Comparing Results</a></li> </ol> <h2 id="1read-in-and-merge-data-files"> <a href="#1read-in-and-merge-data-files" class="anchor-heading" aria-labelledby="1read-in-and-merge-data-files"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1.Read in and Merge Data Files </h2> <p>Different from the simple CSV files we might have worked with before, the raw data from the gas analyzer is more complex. When you open the file, you’ll see it contains two parts: A metadata header: This block at the top contains useful information about the measurement (like timezone, device model, etc.), but we don’t need it for our flux calculations. The data block: This is the core data we need, with columns for date, time, and gas concentrations. Our first challenge is to programmatically read only the data block and ignore the metadata.</p> <p><img src="/New_BAI_DataAnalysis/assets/images/python/5/Metadata.png" alt="Metadata" /></p> <p>To do this, we’ll need the pandas library for creating our DataFrame and the io library, we need to import them.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">io</span>
</code></pre></div></div> <p>Our strategy will be to read the file line-by-line, find the start of the data, and then pass only those lines to pandas.</p> <h3 id="11-reading-and-parsing-the-file"> <a href="#11-reading-and-parsing-the-file" class="anchor-heading" aria-labelledby="11-reading-and-parsing-the-file"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1.1 Reading and Parsing the File </h3> <p>First, we read the entire file into a single string, and then split that string into a list of individual lines. This gives us the flexibility to find our data “landmarks.”</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># Read in raw data as a string
</span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"./BAI_StudyProject_LuentenerWald/raw_data/TG20-01072-2025-08-15T110000.data.txt"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">file_content</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>

<span class="c1"># Split the string into a list of lines. 
# '\n' is the special character for a newline.
</span><span class="n">lines</span> <span class="o">=</span> <span class="n">file_content</span><span class="p">.</span><span class="n">strip</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
</code></pre></div></div> <p>Next, we need to find the exact line that contains our column headers. Looking at the file, we know this line always starts with the word DATAH. We can write a short command to find the index of that line.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This code searches through our list 'lines' and gets the index of the first line that starts with 'DATAH'
</span><span class="n">header_index</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'DATAH'</span><span class="p">))</span>

<span class="c1"># The actual data starts 2 lines after the header line (to skip the "DATAU" units line)
</span><span class="n">data_start_index</span> <span class="o">=</span> <span class="n">header_index</span> <span class="o">+</span> <span class="mi">2</span>

<span class="c1"># Now we can grab the headers themselves from that line. The values are separated by tabs ('\t').
</span><span class="n">headers</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">header_index</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\t</span><span class="s">'</span><span class="p">)</span>
</code></pre></div></div> <h3 id="12-using-iostringio-to-read-our-cleaned-data"> <a href="#12-using-iostringio-to-read-our-cleaned-data" class="anchor-heading" aria-labelledby="12-using-iostringio-to-read-our-cleaned-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1.2 Using io.StringIO to Read Our Cleaned Data </h3> <p>The pd.read_csv() function is built to read from a file. We don’t have a clean file; we have a list of Python strings (lines) that we’ve already processed. So, how do we make pandas read from our list? We use io.StringIO to trick pandas. It takes our cleaned-up data lines and presents them to pandas as if they were a file stored in the computer’s memory.</p> <blockquote> <p><strong>Info</strong>: The Python io module helps us manage data streams. io.StringIO specifically allows us to treat a regular text string as a &gt;file. This is incredibly useful when you need to pass text data to a function that expects a file, just like we’re doing &gt;with pd.read_csv().</p> </blockquote> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Join our data lines back into a single string, separated by newlines
</span><span class="n">data_string</span> <span class="o">=</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">data_start_index</span><span class="p">:])</span>
<span class="c1"># Read the data string into a DataFrame
</span><span class="n">df_raw</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">io</span><span class="p">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">data_string</span><span class="p">),</span>  <span class="c1"># Treat our string as a file
</span>    <span class="n">sep</span><span class="o">=</span><span class="s">'</span><span class="se">\t</span><span class="s">'</span><span class="p">,</span>                  <span class="c1"># Tell pandas the data is separated by tabs
</span>    <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>               <span class="c1"># We are providing the headers ourselves, so there isn't one in the data
</span>    <span class="n">names</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>             <span class="c1"># Use the 'headers' list we extracted earlier
</span>    <span class="n">na_values</span><span class="o">=</span><span class="s">'nan'</span>            <span class="c1"># Recognize 'nan' strings as missing values
</span><span class="p">)</span>
</code></pre></div></div> <h3 id="13-data-formatting"> <a href="#13-data-formatting" class="anchor-heading" aria-labelledby="13-data-formatting"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1.3 Data Formatting </h3> <p>The last step is to tidy up the DataFrame. We will: Remove the useless DATAH column. Combine the separate DATE and TIME columns into a single Timestamp object. This is crucial for time-series analysis. Set this new Timestamp as the DataFrame’s index, which makes plotting and selecting data by time much easier.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Drop the first column which is just the 'DATAH' label
</span><span class="k">if</span> <span class="s">'DATAH'</span> <span class="ow">in</span> <span class="n">df_raw</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">df_raw</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'DATAH'</span><span class="p">])</span>

<span class="c1"># Combine 'DATE' and 'TIME' into a proper Timestamp and set it as the index
</span><span class="k">if</span> <span class="s">'DATE'</span> <span class="ow">in</span> <span class="n">df_raw</span><span class="p">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s">'TIME'</span> <span class="ow">in</span> <span class="n">df_raw</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">df_raw</span><span class="p">[</span><span class="s">'Timestamp'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_raw</span><span class="p">[</span><span class="s">'DATE'</span><span class="p">]</span> <span class="o">+</span> <span class="s">' '</span> <span class="o">+</span> <span class="n">df_raw</span><span class="p">[</span><span class="s">'TIME'</span><span class="p">])</span>
    <span class="n">df_raw</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'DATE'</span><span class="p">,</span> <span class="s">'TIME'</span><span class="p">])</span>
    <span class="n">df_raw</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'Timestamp'</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Data loaded and formatted successfully!"</span><span class="p">)</span>
<span class="n">df_raw</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div> <p>Great! Now, we have successfully read in and formatted our raw data. However, think about our field campaigns. We went out several times and generate a new data file for each trip. If we wanted to analyze all of them, we would have to copy and paste our loading code multiple times. To avoid repetition and make our code cleaner and more reliable, it’s a best practice to wrap a reusable process into a function. Let’s turn our loading and cleaning steps into a function called load_raw_data.</p> <div style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 5px;"> <div class="notice--primary"> <h3 id="exercise"> <a href="#exercise" class="anchor-heading" aria-labelledby="exercise"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exercise </h3> <p>Try to write this function yourself based on the code snippets we created for data loading! Tip: The function will need to accept one argument: the filepath of the file you want to open.</p> <details> <summary>Solution!</summary> <p>Note: how it’s the exact same logic as before, just defined within a def block.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">load_raw_data</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="s">"""
Loads raw data from a text file, remove metadata, and returns a DataFrame.

Parameters:
- filepath (str): The path to the input data file.

Returns:
- pd.DataFrame: A cleaned DataFrame with a DatetimeIndex.
"""</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">file_content</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">lines</span> <span class="o">=</span> <span class="n">file_content</span><span class="p">.</span><span class="n">strip</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">header_index</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'DATAH'</span><span class="p">))</span>
<span class="n">data_start_index</span> <span class="o">=</span> <span class="n">header_index</span> <span class="o">+</span> <span class="mi">2</span>
<span class="n">headers</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">header_index</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\t</span><span class="s">'</span><span class="p">)</span>

<span class="n">df_raw</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">io</span><span class="p">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">data_start_index</span><span class="p">:])),</span>
    <span class="n">sep</span><span class="o">=</span><span class="s">'</span><span class="se">\t</span><span class="s">'</span><span class="p">,</span>
    <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">names</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
    <span class="n">na_values</span><span class="o">=</span><span class="s">'nan'</span>
<span class="p">)</span>

<span class="k">if</span> <span class="s">'DATAH'</span> <span class="ow">in</span> <span class="n">df_raw</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">df_raw</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'DATAH'</span><span class="p">])</span>

<span class="k">if</span> <span class="s">'DATE'</span> <span class="ow">in</span> <span class="n">df_raw</span><span class="p">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s">'TIME'</span> <span class="ow">in</span> <span class="n">df_raw</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">df_raw</span><span class="p">[</span><span class="s">'Timestamp'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_raw</span><span class="p">[</span><span class="s">'DATE'</span><span class="p">]</span> <span class="o">+</span> <span class="s">' '</span> <span class="o">+</span> <span class="n">df_raw</span><span class="p">[</span><span class="s">'TIME'</span><span class="p">])</span>
    <span class="n">df_raw</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'DATE'</span><span class="p">,</span> <span class="s">'TIME'</span><span class="p">])</span>
    <span class="n">df_raw</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'Timestamp'</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Raw data loaded and cleaned successfully."</span><span class="p">)</span>
<span class="k">return</span> <span class="n">df_raw</span>
</code></pre></div> </div> </details> </div> </div> <p>Now that we have our powerful load_raw_data function, we can easily handle data from multiple field trips. Instead of copying code, we can simply call our function in a loop. First, we create a list of all the file paths we want to load. Then, we can loop through this list, call our function for each path, and store the resulting DataFrames in a new list.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># First, let's list all the files we want to load.
# Make sure the file paths are complete and correct.
</span><span class="n">base_path</span> <span class="o">=</span> <span class="s">"./BAI_StudyProject_LuentenerWald/raw_data/"</span>
<span class="n">file_names</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'TG20-01072-2025-08-15T110000.data.txt'</span><span class="p">,</span> 
    <span class="s">'TG20-01072-2025-08-16T110000.data.txt'</span> <span class="c1"># A hypothetical second file
</span><span class="p">]</span>

<span class="c1"># Create the full file paths
</span><span class="n">full_file_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_path</span> <span class="o">+</span> <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">file_names</span><span class="p">]</span>

<span class="c1"># Create an empty list to hold the loaded DataFrames
</span><span class="n">raw_data_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Loop through each path, load the data, and append it to our list
</span><span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">full_file_paths</span><span class="p">:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">load_raw_data</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">raw_data_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Successfully loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_data_list</span><span class="p">)</span><span class="si">}</span><span class="s"> data files."</span><span class="p">)</span>
</code></pre></div></div> <p>The loop above is clear and correct. However, a more concise way to write this in Python is with a list comprehension. It achieves the exact same result in a single, readable line:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">raw_data_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">load_raw_data</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">full_file_paths</span><span class="p">]</span>
</code></pre></div></div> <p>For our flux calculations to be accurate, we need more than just gas concentrations. The Ideal Gas Law, which is the basis of the calculation, requires the ambient air temperature and air pressure at the time of each measurement. We will use the same workflow as before: load each file and then combine them.</p> <div style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 5px;"> <div class="notice--primary"> <h3 id="exercise"> <a href="#exercise" class="anchor-heading" aria-labelledby="exercise"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exercise </h3> <p>You have two Excel files containing air temperature and two files for air pressure. Create lists of the file paths for the temperature and pressure data. Load each Excel file into a pandas DataFrame. Try using a list comprehension as we learned before!</p> <details> <summary>Click here for the solution!</summary> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># We assume the base path is the same as before
</span><span class="n">base_path</span> <span class="o">=</span> <span class="s">"./BAI_StudyProject_LuentenerWald/raw_data/"</span>

<span class="c1"># --- Load Air Temperature Data ---
</span><span class="n">file_names_Ta</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'air_temperature_2025-08-15.xlsx'</span><span class="p">,</span> 
    <span class="s">'air_temperature_2025-08-16.xlsx'</span> 
<span class="p">]</span>
<span class="n">full_file_paths_Ta</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_path</span> <span class="o">+</span> <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">file_names_Ta</span><span class="p">]</span>
<span class="n">ta_data_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="p">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">full_file_paths_Ta</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Successfully loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ta_data_list</span><span class="p">)</span><span class="si">}</span><span class="s"> air temperature files."</span><span class="p">)</span>

<span class="c1"># --- Load Air Pressure Data ---
</span><span class="n">file_names_Pa</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'air_pressure_2025-08-15.xlsx'</span><span class="p">,</span> 
    <span class="s">'air_pressure_2025-08-16.xlsx'</span> 
<span class="p">]</span>
<span class="n">full_file_paths_Pa</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_path</span> <span class="o">+</span> <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">file_names_Pa</span><span class="p">]</span>
<span class="n">pa_data_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="p">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">full_file_paths_Pa</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Successfully loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pa_data_list</span><span class="p">)</span><span class="si">}</span><span class="s"> air pressure files."</span><span class="p">)</span>
</code></pre></div> </div> </details> </div> </div> <h3 id="14-concatenating-and-merging-all-data"> <a href="#14-concatenating-and-merging-all-data" class="anchor-heading" aria-labelledby="14-concatenating-and-merging-all-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1.4 Concatenating and Merging All Data </h3> <p>Now that we have all our data loaded, we need to combine it into one master DataFrame for analysis. This involves two steps: Concatenate: Stacking the files of the same type together (e.g., all gas files into one, all temperature files into one). Merge: Joining the different datasets (gas, temperature, and pressure) together based on their common timestamp.</p> <p><strong>Concatenating the Datasets</strong></p> <p>First, let’s use pd.concat() to combine the lists of DataFrames we created. After combining, we must format the Timestamp column and set it as the index, just as we did before.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- Concatenate and Clean Gas Data ---
</span><span class="n">df_gas</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span><span class="n">raw_data_list</span><span class="p">)</span> <span class="c1"># Assumes raw_data_list is from the previous step
</span>
<span class="c1"># --- Concatenate and Clean Temperature Data ---
</span><span class="n">df_Ta</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span><span class="n">ta_data_list</span><span class="p">)</span>
<span class="n">df_Ta</span><span class="p">[</span><span class="s">'Timestamp'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_Ta</span><span class="p">[</span><span class="s">'Timestamp'</span><span class="p">])</span>
<span class="n">df_Ta</span> <span class="o">=</span> <span class="n">df_Ta</span><span class="p">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'Timestamp'</span><span class="p">)</span>

<span class="c1"># --- Concatenate and Clean Pressure Data ---
</span><span class="n">df_Pa</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span><span class="n">pa_data_list</span><span class="p">)</span>
<span class="n">df_Pa</span><span class="p">[</span><span class="s">'Timestamp'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_Pa</span><span class="p">[</span><span class="s">'Timestamp'</span><span class="p">])</span>
<span class="n">df_Pa</span> <span class="o">=</span> <span class="n">df_Pa</span><span class="p">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'Timestamp'</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"--- Gas DataFrame Info ---"</span><span class="p">)</span>
<span class="n">df_gas</span><span class="p">.</span><span class="n">info</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">--- Temperature DataFrame Info ---"</span><span class="p">)</span>
<span class="n">df_Ta</span><span class="p">.</span><span class="n">info</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">--- Pressure DataFrame Info ---"</span><span class="p">)</span>
<span class="n">df_Pa</span><span class="p">.</span><span class="n">info</span><span class="p">()</span>
</code></pre></div></div> <p><strong>Merging Gas and Auxiliary Data</strong></p> <p>Finally, we need to combine our df_gas, df_Ta, and df_Pa DataFrames. We want to add the temperature and pressure columns to the gas data, matching them by the nearest timestamp. The gas analyzer records data every second, while the weather station might only record every minute. A simple merge would leave many empty rows. The perfect tool for this is pd.merge_asof(). It performs a “nearest-neighbor” merge, which is ideal for combining time-series data with different frequencies.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># First, merge the two auxiliary datasets together
</span><span class="n">df_aux</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">merge_asof</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">df_Ta</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">df_Pa</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s">'Timestamp'</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s">'nearest'</span><span class="p">)</span>

<span class="c1"># Now, merge the gas data with the combined auxiliary data.
# We use direction='backward' to find the most recent weather data for each gas measurement.
</span><span class="n">df_raw</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">merge_asof</span><span class="p">(</span>
    <span class="n">left</span><span class="o">=</span><span class="n">df_gas</span><span class="p">,</span> 
    <span class="n">right</span><span class="o">=</span><span class="n">df_aux</span><span class="p">,</span> 
    <span class="n">on</span><span class="o">=</span><span class="s">'Timestamp'</span><span class="p">,</span> 
    <span class="n">direction</span><span class="o">=</span><span class="s">'backward'</span>
<span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">--- Final Merged DataFrame ---"</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">df_raw</span><span class="p">.</span><span class="n">head</span><span class="p">())</span>
<span class="n">df_raw</span><span class="p">.</span><span class="n">info</span><span class="p">()</span>
</code></pre></div></div> <p>Brilliant! You now have a single, clean DataFrame called df_final that contains everything you need: the high-frequency gas concentrations and the corresponding temperature and pressure for each measurement point. We are now fully prepared to move on to the flux calculation.</p> <h2 id="2-visualizing-and-cleaning-the-data"> <a href="#2-visualizing-and-cleaning-the-data" class="anchor-heading" aria-labelledby="2-visualizing-and-cleaning-the-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. Visualizing and Cleaning the Data </h2> <p>Now that we have a single, merged DataFrame, our next step is to inspect the data quality. Raw sensor data from the field is almost never perfect. Visualizing it is the best way to diagnose issues like noise, drift, or outliers before we attempt any calculations. For this, we’ll use plotly, a powerful library for creating interactive plots.</p> <h3 id="21-creating-a-reusable-plotting-function-with-plotly"> <a href="#21-creating-a-reusable-plotting-function-with-plotly" class="anchor-heading" aria-labelledby="21-creating-a-reusable-plotting-function-with-plotly"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2.1 Creating a Reusable Plotting Function with Plotly </h3> <p>Just as we did with data loading, we’ll be plotting our time-series data multiple times. To make this efficient and keep our plots looking consistent, let’s create a dedicated function. This function will take a DataFrame and some plot details as input and generate an interactive plot.</p> <div style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 5px;"> <div class="notice--primary"> <h3 id="exercise"> <a href="#exercise" class="anchor-heading" aria-labelledby="exercise"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exercise </h3> <p>The plooting function is partly providing in the following, now finish the function!</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">def</span> <span class="nf">plot_time_series</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">y_column</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'lines'</span><span class="p">):</span>
    <span class="s">"""
    Generates an interactive time-series plot using Plotly.

    Parameters:
    - df (pd.DataFrame): DataFrame with a DatetimeIndex.
    - y_column (str): The name of the column to plot on the y-axis.
    - title (str): The title for the plot.
    - mode (str): Plotly mode ('lines', 'markers', or 'lines+markers').
    """</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="p">.</span><span class="n">Figure</span><span class="p">()</span>

    <span class="n">fig</span><span class="p">.</span><span class="n">add_trace</span><span class="p">(...)</span>

    <span class="c1"># Update layout for a clean look
</span>    <span class="n">fig</span><span class="p">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="p">...</span>
    <span class="p">)</span>
    
    <span class="n">fig</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div> <details> <summary>Here is the solution!</summary> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="n">go</span>
<span class="kn">import</span> <span class="nn">plotly.io</span> <span class="k">as</span> <span class="n">pio</span>

<span class="c1"># This setting forces Plotly to open plots in your default web browser,
# which can be more stable in some environments.
</span><span class="n">pio</span><span class="p">.</span><span class="n">renderers</span><span class="p">.</span><span class="n">default</span> <span class="o">=</span> <span class="s">"browser"</span>

<span class="k">def</span> <span class="nf">plot_time_series</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">y_column</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'lines'</span><span class="p">):</span>
    <span class="s">"""
    Generates an interactive time-series plot using Plotly.
    This function will automatically try to set a 'Timestamp' column as the 
    index if the existing index is not a datetime type.

    Parameters:
    - df (pd.DataFrame): DataFrame to plot.
    - y_column (str): The name of the column to plot on the y-axis.
    - title (str): The title for the plot.
    - mode (str): Plotly mode ('lines', 'markers', or 'lines+markers').
    """</span>
    <span class="c1"># --- Input Validation and Auto-Correction ---
</span>    
    <span class="c1"># It's good practice to work on a copy inside a function to avoid 
</span>    <span class="c1"># changing the user's original DataFrame unexpectedly.
</span>    <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">types</span><span class="p">.</span><span class="n">is_datetime64_any_dtype</span><span class="p">(</span><span class="n">df_plot</span><span class="p">.</span><span class="n">index</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Note: The DataFrame index is not a DatetimeIndex."</span><span class="p">)</span>
        <span class="c1"># Attempt to fix the issue by finding a 'Timestamp' column
</span>        <span class="k">if</span> <span class="s">'Timestamp'</span> <span class="ow">in</span> <span class="n">df_plot</span><span class="p">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"--&gt; Found a 'Timestamp' column. Attempting to set it as the index."</span><span class="p">)</span>
            <span class="n">df_plot</span><span class="p">[</span><span class="s">'Timestamp'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_plot</span><span class="p">[</span><span class="s">'Timestamp'</span><span class="p">])</span>
            <span class="c1"># CRITICAL: You must re-assign the variable to save the change.
</span>            <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df_plot</span><span class="p">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'Timestamp'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If we can't fix it automatically, then we raise an error.
</span>            <span class="k">raise</span> <span class="nb">TypeError</span><span class="p">(</span>
                <span class="s">"The DataFrame index is not a DatetimeIndex and a 'Timestamp' column was not found. "</span>
                <span class="s">"Please set a DatetimeIndex before plotting."</span>
            <span class="p">)</span>
            
    <span class="c1"># --- Plotting ---
</span>    <span class="c1"># By this point, df_plot is guaranteed to have a valid DatetimeIndex.
</span>    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="p">.</span><span class="n">Figure</span><span class="p">()</span>

    <span class="n">fig</span><span class="p">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="p">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">df_plot</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> 
        <span class="n">y</span><span class="o">=</span><span class="n">df_plot</span><span class="p">[</span><span class="n">y_column</span><span class="p">],</span> 
        <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> 
        <span class="n">name</span><span class="o">=</span><span class="n">y_column</span>
    <span class="p">))</span>

    <span class="c1"># Update layout for a clean, professional look
</span>    <span class="n">fig</span><span class="p">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> 
        <span class="n">xaxis_title</span><span class="o">=</span><span class="s">'Time'</span><span class="p">,</span> 
        <span class="n">yaxis_title</span><span class="o">=</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">y_column</span><span class="si">}</span><span class="s"> Concentration (ppb)'</span><span class="p">,</span> 
        <span class="n">template</span><span class="o">=</span><span class="s">'plotly_white'</span><span class="p">,</span> 
        <span class="n">title_font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">24</span><span class="p">),</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">tickfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span> <span class="n">title_font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)),</span> 
        <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">tickfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">),</span> <span class="n">title_font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">))</span>
    <span class="p">)</span>
    
    <span class="n">fig</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>

</code></pre></div> </div> </details> </div> </div> <h3 id="22-visualizing-the-raw-gas-data"> <a href="#22-visualizing-the-raw-gas-data" class="anchor-heading" aria-labelledby="22-visualizing-the-raw-gas-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2.2 Visualizing the Raw Gas Data </h3> <p>Now, let’s use our new function to look at the raw N₂O data from our combined file. You can zoom and pan on the plot to inspect the noisy areas.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># Call our function to plot the raw 'N2O' column
</span><span class="n">plot_time_series</span><span class="p">(</span><span class="n">df_final</span><span class="p">,</span> <span class="n">y_column</span><span class="o">=</span><span class="s">'N2O'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">'Raw N2O Concentration Over Time'</span><span class="p">)</span>

</code></pre></div></div> <p><img src="/New_BAI_DataAnalysis/assets/images/python/5/raw_data_plot.png" alt="raw data plotting" /></p> <p>As you can see from the plot, the raw data is very noisy. There are several negative values and some extremely large spikes. These are physically impossible and are likely due to sensor errors or electrical interference. We cannot calculate meaningful fluxes from this data without cleaning it first.</p> <h3 id="23-filtering-with-a-quantile-filter"> <a href="#23-filtering-with-a-quantile-filter" class="anchor-heading" aria-labelledby="23-filtering-with-a-quantile-filter"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2.3 Filtering with a Quantile Filter </h3> <p>To remove these outliers, we’ll use a simple but effective quantile filter. This method is robust because the extreme values we want to remove have very little influence on the calculation of percentiles. We will calculate the 10th and 90th percentiles of the N₂O concentration and discard any data points that fall outside this range.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Calculate the 10th and 90th percentiles
</span><span class="n">p_10</span> <span class="o">=</span> <span class="n">df_final</span><span class="p">.</span><span class="n">N2O</span><span class="p">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.10</span><span class="p">)</span>
<span class="n">p_90</span> <span class="o">=</span> <span class="n">df_final</span><span class="p">.</span><span class="n">N2O</span><span class="p">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.90</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Filtering data to keep N2O concentrations between </span><span class="si">{</span><span class="n">p_10</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> and </span><span class="si">{</span><span class="n">p_90</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> ppb."</span><span class="p">)</span>

<span class="c1"># Apply the filter to create a new, clean DataFrame
# .copy() is used here to avoid a SettingWithCopyWarning from pandas
</span><span class="n">df_filtered</span> <span class="o">=</span> <span class="n">df_final</span><span class="p">[(</span><span class="n">df_final</span><span class="p">.</span><span class="n">N2O</span> <span class="o">&gt;=</span> <span class="n">p_10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_final</span><span class="p">.</span><span class="n">N2O</span> <span class="o">&lt;=</span> <span class="n">p_90</span><span class="p">)].</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Visualize the filtered data using our function again, this time using 'markers'
</span><span class="n">plot_time_series</span><span class="p">(</span><span class="n">df_filtered</span><span class="p">,</span> <span class="n">y_column</span><span class="o">=</span><span class="s">'N2O'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">'Filtered N2O Concentration Over Time'</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'markers'</span><span class="p">)</span>
</code></pre></div></div> <p><img src="/New_BAI_DataAnalysis/assets/images/python/5/filtered_N2O.png" alt="Filtered N2O" /></p> <p>This looks much better! The noise is gone, and a clear, meaningful pattern has emerged.</p> <h3 id="24-understanding-the-data-pattern"> <a href="#24-understanding-the-data-pattern" class="anchor-heading" aria-labelledby="24-understanding-the-data-pattern"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2.4 Understanding the Data Pattern </h3> <p>The filtered data shows a repeating pattern which is the signature of the static chamber method: Baseline (Ambient Air): The long, relatively flat periods show the baseline N₂O concentration in the ambient air. Concentration Increase (Chamber Closed): The sections where the concentration rises steadily and linearly are the actual measurements. This occurs when the chamber is placed over the soil, trapping the gases being emitted. The rate of this increase is what we will use to calculate the flux. Sudden Drop (Chamber Opened): The sharp vertical drops occur when a measurement is finished, and the chamber is lifted from the ground, exposing the sensor to ambient air again. Leveling Off: If a chamber is left on the ground for too long, the gas concentration inside can build up, altering the pressure gradient between the soil and the chamber air. This can cause the rate of increase to slow down and “level off.” For this reason, it’s crucial to use only the initial, linear part of the increase for our flux calculation.</p> <h2 id="3-calculating-flux-for-a-single-measurement"> <a href="#3-calculating-flux-for-a-single-measurement" class="anchor-heading" aria-labelledby="3-calculating-flux-for-a-single-measurement"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. Calculating Flux for a Single Measurement </h2> <p>After loading and filtering our raw data and getting an overview of the patterns, it’s time to calculate the fluxes. Excited? In this section, we will focus on the data for a single measurement period to understand the process in detail. We’ll break it down into a few key steps:</p> <ol> <li> Review the flux calculation formula to see what components we need. </li> <li> Define the metadata (chamber dimensions, etc.) for our specific plot. </li> <li> Isolate the data for a specific time window and visualize it. </li> <li> Perform a linear regression on the concentration data to get the rate of change. </li> <li> Combine all the pieces to calculate the final flux. </li> </ol> <h3 id="31-the-flux-calculation-formula"> <a href="#31-the-flux-calculation-formula" class="anchor-heading" aria-labelledby="31-the-flux-calculation-formula"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.1 The Flux Calculation Formula </h3> <p>First, let’s have a look on the fomula of flux calculation.</p> <p>​ \(\text{Flux Rate (molar)} = \frac{\frac{\Delta C}{t} \cdot V \cdot p}{R \cdot (T_{c} + 273.15) \cdot A}\) ​</p> <p>Where:</p> <p>ΔC/t: The rate of change of the gas concentration in ppm/s (this will be the slope from our regression).</p> <p>V: The total volume of the chamber headspace (m³).</p> <p>p: The air pressure in Pascals (Pa) during measurement.</p> <p>R: The ideal gas constant (8.314 J K⁻¹ mol⁻¹).</p> <p>T_c: The air temperature in Celsius (°C).</p> <p>A: The surface area covered by the chamber (m²).</p> <p>To understand this fomula, we need to figure out the meaning of ‘flux’. In the context of climate change, greenhouse gas flux specifically refers to the exchange of greenhouse gases (GHGs) like carbon dioxide (CO₂), methane (CH₄), and nitrous oxide (N₂O) between different parts of the Earth system (https://climate.sustainability-directory.com/term/greenhouse-gas-fluxes/#:~:text=In%20the%20context%20of%20climate,parts%20of%20the%20Earth%20system). Under the context of this analysis, ‘flux’ means gases exchange between soil and our measurement chamber. You might ask, “Doesn’t the rate of concentration change, ΔC/t (in ppb/s), already represent this flux?” Actually, ΔC/t is the raw evidence of a flux, but it is not a standardized, comparable measurement. It only describes what’s happening inside our specific chamber, under the specific conditions of that one measurement. We are not able to compare flux by simply comparing change rate of gas concentration. Under different temperature and pressure, gas molar density vary, the amount of gas molecular can be different even the gas volume is the same. Therefore, we need to utilize Gas Law (PV = nRT) to calculate the amount of molecular. Besides, a chamber covering a large area of soil will naturally capture more gas than one covering a small area. To make the measurement independent of our chamber’s specifications, we must divide by the soil Area (A) it covers. By applying the full formula, We convert our raw observation (ΔC/t) into a robust, standardized unit: micromoles per square meter per second (µmol m⁻² s⁻¹).</p> <p>To better understand the above fomula, it can be arranged into the following:</p> \[\text{Flux Rate (molar)} = ( \frac{\Delta C}{t} \right) \cdot ( \frac{p \cdot V} {R \cdot (T_C + 273.15)} \right) \cdot ( \frac{1}{A} \right)\] <p>Now, it is clear that the fomula only contains three components: <strong>Flux</strong> = <strong>slope</strong> * <strong>gas_mole</strong> * <strong>A⁻¹</strong></p> <p>Okay, lets create a function of flux calculation based on the fomula for later use.</p> <div style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 5px;"> <div class="notice--primary"> <h3 id="exercise"> <a href="#exercise" class="anchor-heading" aria-labelledby="exercise"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exercise </h3> <p>The function <code class="language-plaintext highlighter-rouge">calculate_flux</code> is provided below but is not complete. It is your task to finish the function based on the formula.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Define key physical constants
</span><span class="n">R</span> <span class="o">=</span> <span class="mf">8.314</span>  <span class="c1"># Ideal gas constant (J K⁻¹ mol⁻¹)
</span>
<span class="k">def</span> <span class="nf">calculate_flux</span><span class="p">(</span><span class="n">slope_ppb_s</span><span class="p">,</span> <span class="n">temp_k</span><span class="p">,</span> <span class="n">pressure_pa</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">area</span><span class="p">):</span>
    <span class="s">"""
    Calculates N2O flux.

    Parameters:
    - slope_ppb_s (float): Rate of change in ppb/s.
    - temperature (float): Temperature, assumed to be in Celsius or Kelvin.
    - pressure (float): Pressure, assumed to be in Pascals (Pa) or hectopascals (hPa).
    - volume (float): Chamber volume, assumed to be in cubic meters (m³) or Liters (L).
    - area (float): Chamber area, assumed to be in square meters (m²) or square cm (cm²).
    """</span>
    <span class="c1"># Convert slope from ppb/s to ppm/s for the formula
</span>    <span class="n">ppm_per_second</span> <span class="o">=</span> <span class="p">...</span>
    
    <span class="c1"># Calculate molar density of air (n/V = P/RT) in mol/m³
</span>    <span class="n">gas_model</span> <span class="o">=</span> <span class="p">...</span>
    
    <span class="c1"># Calculate the flux in µmol m⁻² s⁻¹
</span>    <span class="c1"># The 1e6 converts from mol to µmol
</span>    <span class="n">flux</span> <span class="o">=</span> <span class="p">...</span>
    <span class="k">return</span> <span class="n">flux</span>
</code></pre></div></div> <details> <summary>Solution!</summary> <p>Here is the completed function:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># Define key physical constants
</span><span class="n">R</span> <span class="o">=</span> <span class="mf">8.314</span>  <span class="c1"># Ideal gas constant (J K⁻¹ mol⁻¹)
</span>
<span class="k">def</span> <span class="nf">calculate_flux</span><span class="p">(</span><span class="n">slope_ppb_s</span><span class="p">,</span> <span class="n">temp_k</span><span class="p">,</span> <span class="n">pressure_pa</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">area</span><span class="p">):</span>
    <span class="s">"""
    Calculates N2O flux.

    Parameters:
    - slope_ppb_s (float): Rate of change in ppb/s.
    - temperature (float): Temperature, assumed to be in Celsius or Kelvin.
    - pressure (float): Pressure, assumed to be in Pascals (Pa) or hectopascals (hPa).
    - volume (float): Chamber volume, assumed to be in cubic meters (m³) or Liters (L).
    - area (float): Chamber area, assumed to be in square meters (m²) or square cm (cm²).
    """</span>
    <span class="c1"># Convert slope from ppb/s to ppm/s for the formula
</span>    <span class="n">ppm_per_second</span> <span class="o">=</span> <span class="n">slope_ppb_s</span> <span class="o">/</span> <span class="mf">1000.0</span>
    
    <span class="c1"># Calculate molar density of air (n/V = P/RT) in mol/m³
</span>    <span class="n">gas_mole</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressure_pa</span> <span class="o">*</span> <span class="n">volume</span><span class="p">)</span><span class="o">/</span> <span class="p">(</span><span class="n">R</span> <span class="o">*</span> <span class="n">temp_k</span><span class="p">)</span>
    
    <span class="c1"># Calculate the flux in µmol m⁻² s⁻¹
</span>    <span class="c1"># The 1e6 converts from mol to µmol
</span>    <span class="n">flux</span> <span class="o">=</span> <span class="n">ppm_per_second</span> <span class="o">*</span> <span class="n">gas_mole</span> <span class="o">/</span> <span class="n">area</span> <span class="o">*</span> <span class="mf">1e6</span>
    <span class="k">return</span> <span class="n">flux</span>

</code></pre></div> </div> </details> </div> </div> <h3 id="32-isolating-and-visualizing-the-measurement-data"> <a href="#32-isolating-and-visualizing-the-measurement-data" class="anchor-heading" aria-labelledby="32-isolating-and-visualizing-the-measurement-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.2 Isolating and Visualizing the Measurement Data </h3> <p>Let’s use an example time period of measurement: 2025-08-15 12:04:00 to 2025-08-15 12:10:00. We’ll slice our df_filtered DataFrame to get only the data within this window and then plot it to get a closer look.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Define the start and end times for our measurement window
</span><span class="n">start_time</span> <span class="o">=</span> <span class="s">'2025-08-15 12:04:00'</span>
<span class="n">end_time</span> <span class="o">=</span> <span class="s">'2025-08-15 12:09:30'</span>

<span class="c1"># Select the data for this specific time window
</span><span class="n">measurement_data</span> <span class="o">=</span> <span class="n">df_filtered</span><span class="p">[(</span><span class="n">df_filtered</span><span class="p">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_filtered</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">end_time</span><span class="p">)]</span>

<span class="c1"># Use our plotting function to visualize this specific period
</span><span class="n">plot_time_series</span><span class="p">(</span>
    <span class="n">measurement_data</span><span class="p">,</span> 
    <span class="n">y_column</span><span class="o">=</span><span class="s">'N2O'</span><span class="p">,</span> 
    <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s">'N2O Concentration for Plot </span><span class="si">{</span><span class="n">plot_metadata</span><span class="p">[</span><span class="s">"plot_id"</span><span class="p">]</span><span class="si">}</span><span class="s">'</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s">'markers'</span>
<span class="p">)</span>
</code></pre></div></div> <p>As you can see from the plot, the data in our 5-minute window 2025-08-15 12:04:00 - 2025-08-15 12:09:30 contains more than just the measurement itself.</p> <p>We can identify three distinct phases:</p> <p>Pre-measurement Baseline: A flat period at the beginning. This is when the sensor was measuring ambient air before the chamber was placed on the collar. The Measurement (Linear Increase): This is the part we want. The chamber is sealed, and N₂O from the soil is accumulating, causing a steady, linear increase in concentration. Post-measurement Drop: The sharp, sudden drop at the end. This occurred when the chamber was lifted, and the sensor was exposed to ambient air again.</p> <p>Our flux calculation relies on the slope (ΔC/t) from a linear regression. If we include the flat baseline or the sharp drop in our regression, the line of best fit will not represent the true rate of accumulation, leading to a highly inaccurate flux calculation.</p> <p>Therefore, To get an accurate flux, visual inspection is necessary to include only the linear increase phase. Zoom in on the interactive Plotly graph. We can see that the clean, linear increase happens approximately between 12:05:30 and 12:09:00.</p> <div style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 5px;"> <div class="notice--primary"> <h3 id="exercise"> <a href="#exercise" class="anchor-heading" aria-labelledby="exercise"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exercise </h3> <p>Try to slice the dataframe based on your refined time window, and plot it to see our refined result.</p> <details> <summary>Solution!</summary> <p>Here is the completed function:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Define the refined, visually inspected time window
</span><span class="n">start_mea</span> <span class="o">=</span> <span class="s">'2025-08-15 12:05:30'</span>
<span class="n">end_mea</span> <span class="o">=</span> <span class="s">'2025-08-15 12:09:00'</span>

<span class="c1"># Create a new DataFrame with data only from this refined window
# We use .copy() to create a completely new object for the regression
</span><span class="n">measurement_data</span> <span class="o">=</span> <span class="n">df_filtered</span><span class="p">[</span><span class="n">df_filtered</span><span class="p">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">start_mea</span> <span class="o">&amp;</span> <span class="n">df_filtered</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">end_mea</span><span class="p">].</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Visualize the refined data to confirm our selection
</span><span class="n">plot_time_series</span><span class="p">(</span>
    <span class="n">regression_data</span><span class="p">,</span> 
    <span class="n">y_column</span><span class="o">=</span><span class="s">'N2O'</span><span class="p">,</span> 
    <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s">'Refined Regression Window for Plot </span><span class="si">{</span><span class="n">plot_metadata</span><span class="p">[</span><span class="s">"plot_id"</span><span class="p">]</span><span class="si">}</span><span class="s">'</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s">'markers'</span>
<span class="p">)</span>
</code></pre></div> </div> </details> </div> </div> <p>Great! This plot shows the clear, linear increase in N₂O concentration after the chamber was placed on the collar. This is the exact data we need for our regression.</p> <h3 id="33-linear-regression-to-derive-the-rate-of-gas-concentration-change"> <a href="#33-linear-regression-to-derive-the-rate-of-gas-concentration-change" class="anchor-heading" aria-labelledby="33-linear-regression-to-derive-the-rate-of-gas-concentration-change"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.3 Linear Regression to derive the rate of gas concentration change </h3> <p>Now, as we talked before, we will fit a linear line to these data points. The slope of that line is the dC/dt (rate of change) that we need for our flux formula. As we expect the unit of our regression slope to be ppb/s our x-axis needs to be seconds elapsed (it means the seconds passed compared to the start of the measurement) instead of a timestamp. So, our first step is to create a new column, elapsed_seconds.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="n">measurement_data</span> <span class="o">=</span> <span class="n">measurement_data</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1"># Create an 'elapsed_seconds' column for the regression
# First, we get the start time of the measurement
</span><span class="n">start_timestamp</span> <span class="o">=</span> <span class="n">measurement_data</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nb">min</span><span class="p">()</span>
<span class="c1"># Then we get the time difference for each time point and the start of measurement, and use function total_seconds convert this time difference into seconds
</span><span class="n">measurement_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">measurement_data</span><span class="p">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">start_timestamp</span><span class="p">).</span><span class="n">total_seconds</span><span class="p">()</span>
</code></pre></div></div> <p>Then, we are going to actually fit the regression using scipy library. R2 represents the strength of the relationship that we detected. In here, we are going to use r2 = 0.7 as a threshold. If R2 of a regression is lower than 0.7, the change of gas concentration as time is not significant enough to be recognize as a flux (no flux is detected from the data), otherwise a gas flux can be deceted from the data.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Perform the linear regression using SciPy
</span><span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">std_err</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">linregress</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">measurement_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">],</span>
    <span class="n">y</span><span class="o">=</span><span class="n">measurement_data</span><span class="p">[</span><span class="s">'N2O'</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># The R-squared value tells us how well the line fits the data (a value &gt; 0.7 is good!)
</span><span class="n">r_squared</span> <span class="o">=</span> <span class="n">r_value</span><span class="o">**</span><span class="mi">2</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"--- Regression Results ---"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Slope (dC/dt): </span><span class="si">{</span><span class="n">slope</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> ppb/s"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"R-squared: </span><span class="si">{</span><span class="n">r_squared</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div> <h3 id="34-visualizing-the-fit-and-final-calculation"> <a href="#34-visualizing-the-fit-and-final-calculation" class="anchor-heading" aria-labelledby="34-visualizing-the-fit-and-final-calculation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.4 Visualizing the Fit and Final Calculation </h3> <p>It’s always good practice to visualize the regression line against the data to confirm the fit is good.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- Visualize the regression line ---
</span><span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="p">.</span><span class="n">Figure</span><span class="p">()</span>

<span class="c1"># Add the raw data points
</span><span class="n">fig</span><span class="p">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="p">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">measurement_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">measurement_data</span><span class="p">[</span><span class="s">'N2O'</span><span class="p">],</span> 
                         <span class="n">mode</span><span class="o">=</span><span class="s">'markers'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'Raw Data'</span><span class="p">))</span>

<span class="c1"># Add the fitted regression line
</span><span class="n">fig</span><span class="p">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="p">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">measurement_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">],</span> 
                         <span class="n">y</span><span class="o">=</span><span class="n">intercept</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">measurement_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">],</span>
                         <span class="n">mode</span><span class="o">=</span><span class="s">'lines'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'Fitted Line'</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">'red'</span><span class="p">)))</span>

<span class="n">fig</span><span class="p">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s">'Linear Regression for Plot </span><span class="si">{</span><span class="n">plot_metadata</span><span class="p">[</span><span class="s">"plot_id"</span><span class="p">]</span><span class="si">}</span><span class="s"> (R²=</span><span class="si">{</span><span class="n">r_squared</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">)'</span><span class="p">,</span>
                  <span class="n">xaxis_title</span><span class="o">=</span><span class="s">'Elapsed Time (s)'</span><span class="p">,</span> <span class="n">yaxis_title</span><span class="o">=</span><span class="s">'N2O Concentration (ppb)'</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s">'plotly_white'</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div> <p>Good! If the regression is well fitted into our data, we are able to calculate the flux now! Before we call the calculate_flux function, there are still some steps to go. First, we need to get the average chamber air temperature and air pressure during the measurement and convert them into desired unit respectively (K for air temperature and Pa for air pressure). The unit conversion is very important, as when we wrote the calculate_flux function, we assumed units of our inputs. The mismatch of units will introduce systematic errors and leading to inaccuracy.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># try to get the average air temperature and air temperature value, don't forget the unit conversion.
</span><span class="n">avg_temp_c</span> <span class="o">=</span> 
<span class="n">avg_pressure_pa</span> <span class="o">=</span> 
</code></pre></div></div> <details> <summary>Solution!</summary> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Get the average temperature and pressure during the measurement
</span><span class="n">avg_temp_c</span> <span class="o">=</span> <span class="n">measurement_data</span><span class="p">[</span><span class="s">'T_air'</span><span class="p">].</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="mf">273.15</span> <span class="c1"># convert from °C to K
</span><span class="n">avg_pressure_pa</span> <span class="o">=</span> <span class="n">measurement_data</span><span class="p">[</span><span class="s">'P_air'</span><span class="p">].</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span> <span class="c1"># Assuming pressure is in hPa, convert to Pa
</span></code></pre></div> </div> </details> <p>Then, we still need the total volume of the chamber headspace (m³) and the surface area covered by the chamber (m²). As they are independent of time and the same for all plots, we can simply define them as constants.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- Finally, Calculate the Flux! ---
</span><span class="n">VOLUME</span> <span class="o">=</span> <span class="mf">0.126</span> <span class="c1"># 
</span><span class="n">AREA</span> <span class="o">=</span> <span class="mf">0.13</span> <span class="c1"># the radias of the collar ring is 0.2m, so the area is 0.2*0.2*PI
</span></code></pre></div></div> <p>Finally, call our calculate_flux function and we can get the result!</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Now try to call the function using all the inputs we have and print out to check the result.
</span><span class="n">flux_N2O</span> <span class="o">=</span> <span class="p">...</span>

<span class="k">print</span><span class="p">(...)</span>
</code></pre></div></div> <details> <summary>Solution!</summary> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Now we have all the pieces! Let's call our function.
</span><span class="n">flux_N2O</span> <span class="o">=</span> <span class="n">calculate_flux</span><span class="p">(</span>
    <span class="n">slope_ppb_s</span><span class="o">=</span><span class="n">slope</span><span class="p">,</span>
    <span class="n">temp_k</span><span class="o">=</span><span class="n">avg_temp_k</span><span class="p">,</span>
    <span class="n">pressure_pa</span><span class="o">=</span><span class="n">avg_pressure_pa</span><span class="p">,</span>
    <span class="n">volume</span><span class="o">=</span><span class="n">VOLUME</span><span class="p">,</span>
    <span class="n">area</span><span class="o">=</span><span class="n">AREA</span>

<span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">--- Final Flux Calculation ---"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Average Temperature: </span><span class="si">{</span><span class="n">avg_temp_c</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> °C"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Average Pressure: </span><span class="si">{</span><span class="n">avg_pressure_pa</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> Pa"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Calculated N₂O Flux: </span><span class="si">{</span><span class="n">flux_N2O</span><span class="si">:</span><span class="p">.</span><span class="mi">5</span><span class="n">f</span><span class="si">}</span><span class="s"> µmol m⁻² s⁻¹"</span><span class="p">)</span>
</code></pre></div> </div> </details> <p>Brilliant! Now you successfuly turn the raw gas concentration data into gas fulx!</p> <div style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 5px;"> <div class="notice--primary"> <h3 id="challenge"> <a href="#challenge" class="anchor-heading" aria-labelledby="challenge"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Challenge </h3> <p>Our current calculate_flux function works well, but it has a hidden weakness. It assumes the units of the inputs are correct. For example, it blindly assumes the temp_k argument is already in Kelvin. What if a user accidentally passes in a temperature in Celsius? The function would run without an error but produce a wildly incorrect result. Code that relies on such hidden assumptions is sometimes called “hard-coded.” A much better practice is to write more flexible code that can handle different situations or at least warn the user when something is wrong.</p> <p><strong>Task</strong>: upgrade the calculate_flux function to be more robust. It should:</p> <ol> <li>Add Unit Checks: Check the input values to make a reasonable guess about their units.</li> <li>Perform Automatic Unit Conversion: If it detects a value in a common but incorrect unit (like Celsius for temperature), it should automatically convert it to the required unit (Kelvin).</li> <li>Raise Errors: If a value is completely outside a plausible range, it should stop and raise an error with a helpful message.</li> </ol> <p><strong>Tip</strong>: You can determine units by checking the physical range of a variable. For example, for a terrestrial field measurement, if a temperature value is between -50 and 50, it’s almost certainly Celsius. If it’s between 223 and 323, it’s likely already in Kelvin.</p> <details> <summary>Solution!</summary> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># Define key physical constants
</span><span class="n">R</span> <span class="o">=</span> <span class="mf">8.314</span>  <span class="c1"># Ideal gas constant (J K⁻¹ mol⁻¹)
</span>
<span class="k">def</span> <span class="nf">calculate_flux</span><span class="p">(</span><span class="n">slope_ppb_s</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">pressure</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">area</span><span class="p">):</span>
    <span class="s">"""
    Calculates N2O flux with extensive unit checks and auto-conversion for all inputs.

    Parameters:
    - slope_ppb_s (float): Rate of change in ppb/s.
    - temperature (float): Temperature, assumed to be in Celsius or Kelvin.
    - pressure (float): Pressure, assumed to be in Pascals (Pa) or hectopascals (hPa).
    - volume (float): Chamber volume, assumed to be in cubic meters (m³) or Liters (L).
    - area (float): Chamber area, assumed to be in square meters (m²) or square cm (cm²).
    """</span>
    <span class="c1"># --- 1. Input Validation and Unit Conversion ---
</span>    
    <span class="c1"># Check Temperature (Celsius vs. Kelvin)
</span>    <span class="k">if</span> <span class="o">-</span><span class="mi">50</span> <span class="o">&lt;=</span> <span class="n">temperature</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Note: Temperature (</span><span class="si">{</span><span class="n">temperature</span><span class="si">}</span><span class="s">) detected as Celsius. Converting to Kelvin."</span><span class="p">)</span>
        <span class="n">temp_k</span> <span class="o">=</span> <span class="n">temperature</span> <span class="o">+</span> <span class="mf">273.15</span>
    <span class="k">elif</span> <span class="mi">223</span> <span class="o">&lt;=</span> <span class="n">temperature</span> <span class="o">&lt;=</span> <span class="mi">323</span><span class="p">:</span>
        <span class="n">temp_k</span> <span class="o">=</span> <span class="n">temperature</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"Temperature value (</span><span class="si">{</span><span class="n">temperature</span><span class="si">}</span><span class="s">) is outside a plausible range."</span><span class="p">)</span>

    <span class="c1"># Check Pressure (Pascals vs. hPa)
</span>    <span class="k">if</span> <span class="mi">800</span> <span class="o">&lt;=</span> <span class="n">pressure</span> <span class="o">&lt;=</span> <span class="mi">1100</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Note: Pressure (</span><span class="si">{</span><span class="n">pressure</span><span class="si">}</span><span class="s">) detected as hPa/mbar. Converting to Pascals."</span><span class="p">)</span>
        <span class="n">pressure_pa</span> <span class="o">=</span> <span class="n">pressure</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="k">elif</span> <span class="mi">80000</span> <span class="o">&lt;=</span> <span class="n">pressure</span> <span class="o">&lt;=</span> <span class="mi">110000</span><span class="p">:</span>
        <span class="n">pressure_pa</span> <span class="o">=</span> <span class="n">pressure</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"Pressure value (</span><span class="si">{</span><span class="n">pressure</span><span class="si">}</span><span class="s">) is outside a plausible range."</span><span class="p">)</span>
        
    <span class="c1"># Check Volume (m³ vs. Liters)
</span>    <span class="k">if</span> <span class="mi">10000</span> <span class="o">&lt;=</span> <span class="n">volume</span> <span class="o">&lt;=</span> <span class="mi">2000000</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Note: Volume (</span><span class="si">{</span><span class="n">volume</span><span class="si">}</span><span class="s">) detected as cm³. Converting to m³."</span><span class="p">)</span>
        <span class="n">volume_m3</span> <span class="o">=</span> <span class="n">volume</span> <span class="o">/</span> <span class="mf">1e6</span>
    <span class="k">elif</span> <span class="mi">10</span> <span class="o">&lt;=</span> <span class="n">volume</span> <span class="o">&lt;=</span> <span class="mi">2000</span><span class="p">:</span> <span class="c1"># Plausible range for Liters
</span>        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Note: Volume (</span><span class="si">{</span><span class="n">volume</span><span class="si">}</span><span class="s">) detected as Liters. Converting to m³."</span><span class="p">)</span>
        <span class="n">volume_m3</span> <span class="o">=</span> <span class="n">volume</span> <span class="o">/</span> <span class="mf">1000.0</span>
    <span class="k">elif</span> <span class="mf">0.01</span> <span class="o">&lt;=</span> <span class="n">volume</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># Plausible range for m³
</span>        <span class="n">volume_m3</span> <span class="o">=</span> <span class="n">volume</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"Volume value (</span><span class="si">{</span><span class="n">volume</span><span class="si">}</span><span class="s">) is outside a plausible range for m³ or Liters."</span><span class="p">)</span>

    <span class="c1"># Check Area (m² vs. cm²)
</span>    <span class="k">if</span> <span class="mi">100</span> <span class="o">&lt;=</span> <span class="n">area</span> <span class="o">&lt;=</span> <span class="mi">20000</span><span class="p">:</span> <span class="c1"># Plausible range for cm²
</span>        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Note: Area (</span><span class="si">{</span><span class="n">area</span><span class="si">}</span><span class="s">) detected as cm². Converting to m²."</span><span class="p">)</span>
        <span class="n">area_m2</span> <span class="o">=</span> <span class="n">area</span> <span class="o">/</span> <span class="mf">10000.0</span>
    <span class="k">elif</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">area</span> <span class="o">&lt;=</span> <span class="mi">200</span><span class="p">:</span>  <span class="c1"># Plausible range for dm²
</span>        <span class="n">area_m2</span> <span class="o">=</span> <span class="n">area</span> <span class="o">/</span> <span class="mf">100.0</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Note: Area (</span><span class="si">{</span><span class="n">area</span><span class="si">}</span><span class="s">) detected as dm². Converting to m²."</span><span class="p">)</span>
    <span class="k">elif</span> <span class="mf">0.01</span> <span class="o">&lt;=</span> <span class="n">area</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># Plausible range for m²
</span>        <span class="n">area_m2</span> <span class="o">=</span> <span class="n">area</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"Area value (</span><span class="si">{</span><span class="n">area</span><span class="si">}</span><span class="s">) is outside a plausible range for m², dm² or cm²."</span><span class="p">)</span>

    <span class="c1"># --- 2. Core Calculation ---
</span>    <span class="n">v_over_a</span> <span class="o">=</span> <span class="n">volume_m3</span> <span class="o">/</span> <span class="n">area_m2</span>
    <span class="n">ppm_per_second</span> <span class="o">=</span> <span class="n">slope_ppb_s</span> <span class="o">/</span> <span class="mf">1000.0</span>
    <span class="n">molar_density</span> <span class="o">=</span> <span class="n">pressure_pa</span> <span class="o">/</span> <span class="p">(</span><span class="n">R</span> <span class="o">*</span> <span class="n">temp_k</span><span class="p">)</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">ppm_per_second</span> <span class="o">*</span> <span class="n">molar_density</span> <span class="o">*</span> <span class="n">v_over_a</span> <span class="o">*</span> <span class="mf">1e6</span>
    
    <span class="k">return</span> <span class="n">flux</span>
</code></pre></div> </div> <p><strong>Info</strong>: Python (<a href="https://www.geeksforgeeks.org/python/python-raise-keyword/">raise keywords</a>) is used to raise exceptions or errors. The raise keyword raises an error and stops the control flow of the program. It is used to bring up the current exception in an exception handler (an exception handler indicates the error type) so that it can be handled further up the call stack.</p> <p>The basic way to raise an exception is</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">raise</span> <span class="nb">Exception</span> <span class="p">(</span><span class="s">'...'</span><span class="p">)</span> <span class="c1"># In here, Exception is an exception handler (it is actually a function), which indicate a general exception. It takes a string used to reminder                            # users what errors happen in here and the potential reasons. 
</span></code></pre></div> </div> <p>In the ‘solution’, we used the handler ValueError to indicate the input value is outside a plausible range, and pass a string showing to users to further explain the error.</p> </details> </div> </div> <h2 id="4-automating-gas-flux-calculation"> <a href="#4-automating-gas-flux-calculation" class="anchor-heading" aria-labelledby="4-automating-gas-flux-calculation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4. Automating gas flux calculation </h2> <h3 id="41-store-and-structure-measurement-info"> <a href="#41-store-and-structure-measurement-info" class="anchor-heading" aria-labelledby="41-store-and-structure-measurement-info"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4.1 Store and structure measurement info </h3> <p>The first and crucial step of automation is to store the key information (metadata) for each measurement in a structured way that a program can loop through. For this, we will use a Python dictionary. The dictionary keys will be our data “columns” (e.g., ‘plot_id’, ‘land_use’), and the values will be lists containing the data for each plot. Now, there is an issue: we take multiple measurements at the same plot, perhaps on different days or at different times. How can we store this information efficiently? We can store the multiple start and end times for a single plot as a single string, with each timestamp separated by a semicolon (;). Of course, the order of the multiple starttime and endtime for a plot should match. By doing this, we can keep the metadata table concise and still tell our program to perform multiple calculations for that plot.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- Create Metadata ---
</span><span class="n">measurement_info</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'plot_id'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="s">'land_use'</span><span class="p">:</span> <span class="p">[</span><span class="s">'forest'</span><span class="p">,</span> <span class="s">'forest'</span><span class="p">],</span>
    <span class="s">'start_time'</span><span class="p">:</span> <span class="p">[</span><span class="s">'2025-08-15 12:06:00; 2025-08-15 12:14:00'</span><span class="p">,</span> <span class="s">'2025-08-15 12:13:00'</span><span class="p">],</span>
    <span class="s">'end_time'</span><span class="p">:</span> <span class="p">[</span><span class="s">'2025-08-15 12:09:00; 2025-08-15 12:17:00'</span><span class="p">,</span> <span class="s">'2025-08-15 12:18:30'</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">metadata_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">measurement_info</span><span class="p">)</span>
</code></pre></div></div> <h3 id="42-automation-calculation"> <a href="#42-automation-calculation" class="anchor-heading" aria-labelledby="42-automation-calculation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4.2 Automation Calculation </h3> <p>Now we can build a for loop that iterates through each row (Each row contains infomation for a single plot) of our metadata_df. In here, we are going to use <a href="https://www.geeksforgeeks.org/pandas/pandas-dataframe-iterrows/">‘iterrow()’</a> to iterate through metadata_df. ‘iterrow()’ is a method of data frame object, it generates an iterator object of the DataFrame, allowing us to iterate each row in the DataFrame. Each iteration produces an index object and a row object (a Pandas Series object). Inside the loop, we will split start_time and end_time string for each plot using ‘split()’ method and build a inner loop to iterate all measurements for the plot.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a empty list we can use to store all calculated fluxes.
</span><span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">metadata_df</span><span class="p">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">start_times</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">'start_time'</span><span class="p">].</span><span class="n">strip</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">)</span>  <span class="c1"># Handle potential multiple times
</span>    <span class="n">end_times</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">'end_time'</span><span class="p">].</span><span class="n">strip</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">';'</span><span class="p">)</span>  <span class="c1"># Handle potential multiple times
</span>
    <span class="k">for</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">start_times</span><span class="p">,</span> <span class="n">end_times</span><span class="p">):</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">start_time</span><span class="p">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">end_time</span><span class="p">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="n">measurement_date</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">start_time</span><span class="p">.</span><span class="n">year</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">start_time</span><span class="p">.</span><span class="n">month</span><span class="si">:</span><span class="mi">02</span><span class="n">d</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">start_time</span><span class="p">.</span><span class="n">day</span><span class="si">:</span><span class="mi">02</span><span class="n">d</span><span class="si">}</span><span class="s">'</span>
</code></pre></div></div> <p>Within the inner loop, we will perform the exact same steps we did manually in the last section. However, there is one key difference in the visual inspection step. In the manual section, we looked at the plot and then assigned our refined start and end times into variables. To keep the program continuing without needing to stop and edit the script each time, we will use the built-in input() function. This will pause the script, show us a plot, and allow us to enter our refined time window directly into the terminal before the program continues.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1">## step 1: Visual inspection ##
</span>        <span class="c1"># Select the data for this specific time window
</span>        <span class="n">measurement_data</span> <span class="o">=</span> <span class="n">df_filtered</span><span class="p">[(</span><span class="n">df_filtered</span><span class="p">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_filtered</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">end_time</span><span class="p">)]</span>
        <span class="c1"># Plot the raw data for visual inspection
</span>        <span class="n">plot_time_series</span><span class="p">(</span><span class="n">measurement_data</span><span class="p">,</span> <span class="n">y_column</span><span class="o">=</span><span class="s">'N2O'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s">'N2O Concentration Over Time}'</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'markers'</span><span class="p">)</span>
        <span class="c1"># Mannually selcect the start and end time for regression
</span>        <span class="n">start_mea</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"Enter the start time for regression (YYYY-MM-DD HH:MM:SS): "</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">end_mea</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">"Enter the end time for regression (YYYY-MM-DD HH:MM:SS): "</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># Use the original start and end time if no input is given
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">start_mea</span><span class="p">:</span>
            <span class="n">start_mea</span> <span class="o">=</span> <span class="n">start_time</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">end_mea</span><span class="p">:</span>
            <span class="n">end_mea</span> <span class="o">=</span> <span class="n">end_time</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">start_mea</span><span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">end_mea</span><span class="p">)</span>
        <span class="n">measurement_data</span> <span class="o">=</span> <span class="n">measurement_data</span><span class="p">[(</span><span class="n">measurement_data</span><span class="p">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">measurement_data</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">end_time</span><span class="p">)]</span>
        <span class="c1">## step 2: Linear regression ## 
</span>        <span class="c1"># Ensure there is enough data to perform a regression
</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">measurement_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Skipping plot </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s">'plot_id'</span><span class="p">]</span><span class="si">}</span><span class="s"> on </span><span class="si">{</span><span class="n">measurement_date</span><span class="si">}</span><span class="s"> due to insufficient data."</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Create an 'elapsed_seconds' column for the regression
</span>        <span class="n">measurement_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">measurement_data</span><span class="p">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">).</span><span class="n">total_seconds</span><span class="p">()</span>

        <span class="c1"># Perform linear regression: N2O concentration vs. time
</span>        <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">linregress</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">measurement_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="n">measurement_data</span><span class="p">[</span><span class="s">'N2O'</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># --- Quality Control (QC) ---
</span>        <span class="c1"># We only accept measurements with a good linear fit and a positive slope
</span>        <span class="n">r_squared</span> <span class="o">=</span> <span class="n">r_value</span><span class="o">**</span><span class="mi">2</span>
        <span class="c1"># plot the regression line
</span>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">layout</span><span class="o">=</span><span class="s">'constrained'</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">ax</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">measurement_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">],</span> <span class="n">measurement_data</span><span class="p">[</span><span class="s">'N2O'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">'N2O Concentration (ppb)'</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">measurement_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">],</span> <span class="n">intercept</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">measurement_data</span><span class="p">[</span><span class="s">'elapsed_seconds'</span><span class="p">],</span> <span class="s">'r'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Fitted line'</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">'Elapsed Time (s)'</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">'N2O Concentration (ppb)'</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s">'Linear Regression for Plot </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s">"plot_id"</span><span class="p">]</span><span class="si">}</span><span class="s"> (R²=</span><span class="si">{</span><span class="n">r_squared</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">)'</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">r_squared</span> <span class="o">&lt;</span> <span class="mf">0.70</span> <span class="ow">or</span> <span class="n">p_value</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="n">flux_umol_m2_s</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Set flux to 0 if QC fails
</span>            <span class="n">qc_pass</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qc_pass</span> <span class="o">=</span> <span class="bp">True</span>
            
            <span class="c1">## step 3: Flux Calculation Formula ##
</span>            <span class="c1"># This formula converts the rate of change in concentration (slope) to a flux rate.
</span>            <span class="c1"># It corrects for ambient pressure and temperature.
</span>            
            <span class="n">temp_k</span> <span class="o">=</span> <span class="n">measurement_data</span><span class="p">[</span><span class="s">'temperature'</span><span class="p">].</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="mf">273.15</span>  <span class="c1"># Convert °C to Kelvin
</span>            <span class="n">pressure_pa</span> <span class="o">=</span> <span class="n">measurement_data</span><span class="p">[</span><span class="s">'pressure'</span><span class="p">].</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># Convert hPa to Pascals
</span>
            <span class="n">flux_umol_m2_s</span> <span class="o">=</span> <span class="n">calculate_flux</span><span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">temp_k</span><span class="p">,</span> <span class="n">pressure_pa</span><span class="p">,</span> <span class="n">VOLUME</span><span class="p">,</span> <span class="n">AREA</span><span class="p">)</span>
</code></pre></div></div> <p>At the end of the iteration, we need to save the results of each calculation. Only the flux value is not enough, we also need to save its metadata (e.g., plot_id, ‘land_use’), which are essential for flux analysis and visualization we are going to do later.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1"># Store the results
</span>        <span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s">'plot_id'</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">'plot_id'</span><span class="p">],</span>
            <span class="s">'land_use'</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s">'land_use'</span><span class="p">],</span>
            <span class="s">'measurement_date'</span><span class="p">:</span> <span class="n">measurement_date</span><span class="p">,</span>
            <span class="s">'slope_ppb_s'</span><span class="p">:</span> <span class="n">slope</span><span class="p">,</span>
            <span class="s">'r_squared'</span><span class="p">:</span> <span class="n">r_squared</span><span class="p">,</span>
            <span class="s">'p_value'</span><span class="p">:</span> <span class="n">p_value</span><span class="p">,</span>
            <span class="s">'qc_pass'</span><span class="p">:</span> <span class="n">qc_pass</span><span class="p">,</span>
            <span class="s">'N2O_flux_umol_m2_s'</span><span class="p">:</span> <span class="n">flux_umol_m2_s</span>
        <span class="p">})</span>

<span class="c1"># Convert the results list to a final DataFrame
</span><span class="n">flux_results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Flux calculation complete:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">flux_results_df</span><span class="p">)</span>
</code></pre></div></div> <h3 id="43-flux-comparison"> <a href="#43-flux-comparison" class="anchor-heading" aria-labelledby="43-flux-comparison"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4.3 Flux comparison </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># --- Visualization ---
</span><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">sns</span><span class="p">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">flux_results_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">'land_use'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'N2O_flux_umol_m2_s'</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s">'viridis'</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">flux_results_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">'land_use'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'N2O_flux_umol_m2_s'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'black'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">jitter</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">'N₂O Flux by Land Use Type'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Land Use'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'N₂O Flux (µmol m⁻² s⁻¹)'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s">'y'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s">'--'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div> </main> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
