<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/New_BAI_DataAnalysis/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/New_BAI_DataAnalysis/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li:not(:nth-child(5)) > a, .site-nav > ul.nav-list:first-child > li > ul > li a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(5) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(5) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(5) > ul.nav-list { display: block; } </style> <script src="/New_BAI_DataAnalysis/assets/js/vendor/lunr.min.js"></script> <script src="/New_BAI_DataAnalysis/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>REGRESSION | Data Analysis for Ecologist</title> <meta name="generator" content="Jekyll v3.10.0" /> <meta property="og:title" content="REGRESSION" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="A tutorial for starters learning how to use python to munipulate climate data!" /> <meta property="og:description" content="A tutorial for starters learning how to use python to munipulate climate data!" /> <link rel="canonical" href="https://ericluoyuu.github.io/New_BAI_DataAnalysis/python_3_regression.html" /> <meta property="og:url" content="https://ericluoyuu.github.io/New_BAI_DataAnalysis/python_3_regression.html" /> <meta property="og:site_name" content="Data Analysis for Ecologist" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="REGRESSION" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"A tutorial for starters learning how to use python to munipulate climate data!","headline":"REGRESSION","url":"https://ericluoyuu.github.io/New_BAI_DataAnalysis/python_3_regression.html"}</script> <!-- End Jekyll SEO tag --> </head> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']], displayMath: [ ['$$', '$$'] ], processEscapes: true, processEnvironments: true } }); </script> <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"> </script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"> </script> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/New_BAI_DataAnalysis/" class="site-title lh-tight"> Data Analysis for Ecologist </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/New_BAI_DataAnalysis/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/New_BAI_DataAnalysis/python_0_installation.html" class="nav-list-link">0. INSTALLATION</a></li><li class="nav-list-item"><a href="/New_BAI_DataAnalysis/python_1_basics.html" class="nav-list-link">1. BASICS OF PYTHON</a></li><li class="nav-list-item"><a href="/New_BAI_DataAnalysis/python_2_data_visualization.html" class="nav-list-link">2. DATA HANDLING AND VISUALIZATION</a></li><li class="nav-list-item"><a href="/New_BAI_DataAnalysis/python_3_regression.html" class="nav-list-link">3. REGRESSION</a></li><li class="nav-list-item"><a href="/New_BAI_DataAnalysis/python_4_flux_calculation.html" class="nav-list-link">4. FLUX CALCULATION</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Data Analysis for Ecologist" aria-label="Search Data Analysis for Ecologist" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div class="main-content-wrap"> <div id="main-content" class="main-content"> <main> <h1 id="regression"> <a href="#regression" class="anchor-heading" aria-labelledby="regression"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <strong>Regression</strong> </h1> <p>This tutorial provides a comprehensive introduction to regression analysis, one of the most fundamental and widely used techniques in statistics and machine learning. We will cover the theoretical foundations, practical implementations in Python, and real-world ecological applications.</p> <p><strong>Prerequisites:</strong> Basic knowledge of Python, pandas, and numpy.</p><hr /> <h1 id="chapter-1-foundations-of-regression"> <a href="#chapter-1-foundations-of-regression" class="anchor-heading" aria-labelledby="chapter-1-foundations-of-regression"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <strong>Chapter 1: Foundations of Regression</strong> </h1> <h2 id="11-what-is-regression"> <a href="#11-what-is-regression" class="anchor-heading" aria-labelledby="11-what-is-regression"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1.1 What is Regression? </h2> <p>Regression analysis is a statistical method used to model and analyze the relationships between variables. At its core, regression helps us understand how one or more <strong>independent variables</strong> (also called predictors, features, or explanatory variables) influence a <strong>dependent variable</strong> (also called the target, response, or outcome variable).</p> <p>The term “regression” was coined by Sir Francis Galton in the 19th century when he observed that children of tall parents tend to “regress” toward the average height of the population. Today, regression encompasses a broad family of techniques used across virtually every scientific discipline.</p> <h3 id="an-ecological-example"> <a href="#an-ecological-example" class="anchor-heading" aria-labelledby="an-ecological-example"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> An Ecological Example </h3> <p>Imagine you want to understand how temperature affects tree growth. You collect data from forest plots:</p> <div class="table-wrapper"><table> <thead> <tr> <th>Mean Annual Temperature (°C)</th> <th>Tree Ring Width (mm)</th> </tr> </thead> <tbody> <tr> <td>8</td> <td>1.2</td> </tr> <tr> <td>10</td> <td>1.8</td> </tr> <tr> <td>12</td> <td>2.4</td> </tr> <tr> <td>14</td> <td>2.9</td> </tr> <tr> <td>16</td> <td>3.2</td> </tr> </tbody> </table></div> <p>Regression analysis allows you to:</p> <ol> <li>Find the mathematical relationship between temperature and tree growth</li> <li>Predict growth rates at temperatures you haven’t measured</li> <li>Quantify how much each degree of warming contributes to growth</li> </ol> <h2 id="12-purposes-of-regression-analysis"> <a href="#12-purposes-of-regression-analysis" class="anchor-heading" aria-labelledby="12-purposes-of-regression-analysis"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1.2 Purposes of Regression Analysis </h2> <p>Regression serves several key purposes in ecological data analysis:</p> <h3 id="1-prediction"> <a href="#1-prediction" class="anchor-heading" aria-labelledby="1-prediction"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. Prediction </h3> <p>The most common use of regression is to predict unknown values of the target variable based on known values of the predictors. For example:</p> <ul> <li>Predicting forest biomass from satellite imagery indices</li> <li>Forecasting species distribution under climate change scenarios</li> <li>Estimating crop yield based on weather and soil conditions</li> </ul> <h3 id="2-exploring-relationships"> <a href="#2-exploring-relationships" class="anchor-heading" aria-labelledby="2-exploring-relationships"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. Exploring Relationships </h3> <p>Regression helps us understand how environmental variables are related to ecological responses:</p> <ul> <li>Does precipitation affect plant species richness? By how much?</li> <li>Is there a relationship between water temperature and fish abundance?</li> <li>How do different soil nutrients contribute to crop productivity?</li> </ul> <h3 id="3-inference-and-hypothesis-testing"> <a href="#3-inference-and-hypothesis-testing" class="anchor-heading" aria-labelledby="3-inference-and-hypothesis-testing"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. Inference and Hypothesis Testing </h3> <p>Regression allows us to test ecological hypotheses:</p> <ul> <li>Is the relationship between CO₂ concentration and photosynthesis rate statistically significant?</li> <li>Can we reject the null hypothesis that habitat fragmentation has no effect on biodiversity?</li> </ul> <h3 id="4-identifying-important-environmental-drivers"> <a href="#4-identifying-important-environmental-drivers" class="anchor-heading" aria-labelledby="4-identifying-important-environmental-drivers"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4. Identifying Important Environmental Drivers </h3> <p>When multiple factors could influence an ecological outcome, regression helps identify which ones matter most and which can be ignored.</p> <h3 id="5-conservation-and-management-decisions"> <a href="#5-conservation-and-management-decisions" class="anchor-heading" aria-labelledby="5-conservation-and-management-decisions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5. Conservation and Management Decisions </h3> <p>Understanding relationships enables better environmental management:</p> <ul> <li>What combination of restoration actions maximizes ecosystem recovery?</li> <li>How should conservation resources be allocated to protect endangered species?</li> </ul> <h2 id="13-key-concepts-in-regression"> <a href="#13-key-concepts-in-regression" class="anchor-heading" aria-labelledby="13-key-concepts-in-regression"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1.3 Key Concepts in Regression </h2> <h3 id="target-variable-dependent-variable"> <a href="#target-variable-dependent-variable" class="anchor-heading" aria-labelledby="target-variable-dependent-variable"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Target Variable (Dependent Variable) </h3> <p>The variable we want to predict or explain. Denoted as <strong>y</strong> or <strong>Y</strong>.</p> <ul> <li>Examples: species abundance, tree growth rate, carbon flux, water quality index, crop yield</li> </ul> <h3 id="independent-variables-predictorsfeatures"> <a href="#independent-variables-predictorsfeatures" class="anchor-heading" aria-labelledby="independent-variables-predictorsfeatures"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Independent Variables (Predictors/Features) </h3> <p>The variables used to predict or explain the target. Denoted as <strong>X</strong>, <strong>x₁</strong>, <strong>x₂</strong>, etc.</p> <ul> <li>Examples: temperature, precipitation, soil pH, elevation, canopy cover, nutrient concentration</li> </ul> <h3 id="model"> <a href="#model" class="anchor-heading" aria-labelledby="model"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Model </h3> <p>A mathematical equation that describes the relationship between the predictors and the target. The general form is:</p> <p><strong>y = f(X) + ε</strong></p> <p>Where:</p> <ul> <li><strong>y</strong> is the target variable</li> <li><strong>f(X)</strong> is the systematic component (the ecological pattern we’re trying to capture)</li> <li><strong>ε</strong> (epsilon) is the error term (random variation we cannot explain)</li> </ul> <h3 id="parameters-coefficients"> <a href="#parameters-coefficients" class="anchor-heading" aria-labelledby="parameters-coefficients"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Parameters (Coefficients) </h3> <p>The values in the model that define the relationship. In a linear model <strong>y = β₀ + β₁x</strong>:</p> <ul> <li><strong>β₀</strong> (beta-zero) is the <strong>intercept</strong> — the predicted value when x = 0</li> <li><strong>β₁</strong> (beta-one) is the <strong>slope</strong> — how much y changes for each unit increase in x</li> </ul> <h3 id="residuals-errors"> <a href="#residuals-errors" class="anchor-heading" aria-labelledby="residuals-errors"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Residuals (Errors) </h3> <p>The difference between the actual observed values and the values predicted by the model:</p> <p><strong>residual = y_observed - y_predicted</strong></p> <p>Good models have small residuals that are randomly distributed.</p> <h3 id="fitted-values-predictions"> <a href="#fitted-values-predictions" class="anchor-heading" aria-labelledby="fitted-values-predictions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Fitted Values (Predictions) </h3> <p>The values predicted by the model, often denoted as <strong>ŷ</strong> (y-hat).</p> <h2 id="14-how-regression-works"> <a href="#14-how-regression-works" class="anchor-heading" aria-labelledby="14-how-regression-works"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1.4 How Regression Works </h2> <p>The fundamental idea behind regression is to find the model parameters that best fit the observed data. Here’s the general process:</p> <h3 id="step-1-choose-a-model-form"> <a href="#step-1-choose-a-model-form" class="anchor-heading" aria-labelledby="step-1-choose-a-model-form"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1: Choose a Model Form </h3> <p>Decide on the mathematical form of the relationship:</p> <ul> <li>Simple: y = β₀ + β₁x (one predictor)</li> <li>Multiple predictors: y = β₀ + β₁x₁ + β₂x₂ + …</li> </ul> <h3 id="step-2-define-best-fit"> <a href="#step-2-define-best-fit" class="anchor-heading" aria-labelledby="step-2-define-best-fit"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2: Define “Best Fit” </h3> <p>Establish a criterion for what makes a good fit. The most common is <strong>Least Squares</strong>, which minimizes the sum of squared residuals:</p> <p><strong>SSE = Σ(yᵢ - ŷᵢ)²</strong></p> <p>We square the errors to:</p> <ul> <li>Prevent positive and negative errors from canceling out</li> <li>Penalize large errors more heavily than small ones</li> </ul> <h3 id="step-3-estimate-parameters"> <a href="#step-3-estimate-parameters" class="anchor-heading" aria-labelledby="step-3-estimate-parameters"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 3: Estimate Parameters </h3> <p>Use mathematical optimization to find the parameter values that minimize the chosen criterion.</p> <h3 id="step-4-evaluate-the-model"> <a href="#step-4-evaluate-the-model" class="anchor-heading" aria-labelledby="step-4-evaluate-the-model"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 4: Evaluate the Model </h3> <p>Assess how well the model fits the data and whether it meets the assumptions of the method being used.</p> <h2 id="15-evaluating-regression-models"> <a href="#15-evaluating-regression-models" class="anchor-heading" aria-labelledby="15-evaluating-regression-models"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1.5 Evaluating Regression Models </h2> <p>Several metrics help us understand model performance:</p> <h3 id="r-squared-r--coefficient-of-determination"> <a href="#r-squared-r--coefficient-of-determination" class="anchor-heading" aria-labelledby="r-squared-r--coefficient-of-determination"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> R-squared (R²) — Coefficient of Determination </h3> <p>Measures the proportion of variance in the target variable explained by the model:</p> <p><strong>R² = 1 - (SSE / SST)</strong></p> <p>Where:</p> <ul> <li>SSE = Sum of Squared Errors (residuals)</li> <li>SST = Total Sum of Squares (variance in y)</li> </ul> <p>R² ranges from 0 to 1:</p> <ul> <li>R² = 1: Perfect fit (model explains all variance)</li> <li>R² = 0: Model explains none of the variance</li> </ul> <p>In ecology, what constitutes a “good” R² depends heavily on the system. An R² of 0.4 might be excellent for predicting species distributions, while an R² of 0.9 might be expected for controlled growth experiments.</p> <h3 id="mean-squared-error-mse"> <a href="#mean-squared-error-mse" class="anchor-heading" aria-labelledby="mean-squared-error-mse"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Mean Squared Error (MSE) </h3> <p>Average of squared residuals:</p> <p><strong>MSE = (1/n) Σ(yᵢ - ŷᵢ)²</strong></p> <h3 id="root-mean-squared-error-rmse"> <a href="#root-mean-squared-error-rmse" class="anchor-heading" aria-labelledby="root-mean-squared-error-rmse"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Root Mean Squared Error (RMSE) </h3> <p>Square root of MSE, in the same units as the target:</p> <p><strong>RMSE = √MSE</strong></p> <p>RMSE is interpretable: “On average, predictions are off by approximately RMSE units.”</p> <h3 id="mean-absolute-error-mae"> <a href="#mean-absolute-error-mae" class="anchor-heading" aria-labelledby="mean-absolute-error-mae"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Mean Absolute Error (MAE) </h3> <p>Average of absolute residuals:</p> <div class="table-wrapper"><table> <tbody> <tr> <td>**MAE = (1/n) Σ</td> <td>yᵢ - ŷᵢ</td> <td>**</td> </tr> </tbody> </table></div> <p>Less sensitive to outliers than RMSE — useful in ecological data where extreme values are common.</p> <h2 id="16-types-of-regression-approaches"> <a href="#16-types-of-regression-approaches" class="anchor-heading" aria-labelledby="16-types-of-regression-approaches"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1.6 Types of Regression Approaches </h2> <p>In this tutorial, we will cover three main approaches:</p> <div class="table-wrapper"><table> <thead> <tr> <th>Approach</th> <th>Description</th> <th>Best For</th> </tr> </thead> <tbody> <tr> <td><strong>Simple Regression</strong></td> <td>One predictor variable</td> <td>Understanding single relationships</td> </tr> <tr> <td><strong>Multiple Regression</strong></td> <td>Multiple predictor variables</td> <td>Modeling complex ecological systems</td> </tr> <tr> <td><strong>Machine Learning</strong></td> <td>Algorithms that learn patterns</td> <td>Complex, non-linear relationships</td> </tr> </tbody> </table></div><hr /> <h1 id="chapter-2-simple-linear-regression"> <a href="#chapter-2-simple-linear-regression" class="anchor-heading" aria-labelledby="chapter-2-simple-linear-regression"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <strong>Chapter 2: Simple Linear Regression</strong> </h1> <p>Simple linear regression models the relationship between a single predictor and a target variable using a straight line.</p> <h2 id="21-the-model"> <a href="#21-the-model" class="anchor-heading" aria-labelledby="21-the-model"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2.1 The Model </h2> <p>The simple linear regression model takes the form:</p> <p><strong>y = β₀ + β₁x + ε</strong></p> <p>Where:</p> <ul> <li>y is the target variable (e.g., tree growth)</li> <li>x is the predictor variable (e.g., temperature)</li> <li>β₀ is the y-intercept</li> <li>β₁ is the slope</li> <li>ε is the error term</li> </ul> <h3 id="mathematical-foundation"> <a href="#mathematical-foundation" class="anchor-heading" aria-labelledby="mathematical-foundation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Mathematical Foundation </h3> <p>The goal is to find the values of β₀ and β₁ that minimize the Sum of Squared Errors (SSE):</p> <p><strong>SSE = Σ(yᵢ - β₀ - β₁xᵢ)²</strong></p> <p>Taking partial derivatives and setting them to zero yields:</p> <p><strong>β₁ = Σ(xᵢ - x̄)(yᵢ - ȳ) / Σ(xᵢ - x̄)²</strong></p> <p><strong>β₀ = ȳ - β₁x̄</strong></p> <h2 id="22-ecological-example-tree-growth-and-temperature"> <a href="#22-ecological-example-tree-growth-and-temperature" class="anchor-heading" aria-labelledby="22-ecological-example-tree-growth-and-temperature"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2.2 Ecological Example: Tree Growth and Temperature </h2> <p>Let’s examine how mean annual temperature affects tree ring width (a proxy for growth rate).</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="n">px</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="n">go</span>

<span class="c1"># Create ecological dataset: Tree growth vs temperature
</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Temperature gradient (°C) - typical temperate forest range
</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">])</span>

<span class="c1"># Tree ring width (mm) - increases with temperature up to an optimum
# Adding realistic ecological variation
</span><span class="n">ring_width</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="o">+</span> <span class="mf">0.15</span> <span class="o">*</span> <span class="n">temperature</span> <span class="o">+</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">temperature</span><span class="p">))</span>

<span class="c1"># Create DataFrame
</span><span class="n">tree_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s">'temperature_C'</span><span class="p">:</span> <span class="n">temperature</span><span class="p">,</span>
    <span class="s">'ring_width_mm'</span><span class="p">:</span> <span class="n">ring_width</span>
<span class="p">})</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Tree Growth Dataset:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">tree_data</span><span class="p">)</span>
</code></pre></div></div> <h3 id="manual-calculation-of-coefficients"> <a href="#manual-calculation-of-coefficients" class="anchor-heading" aria-labelledby="manual-calculation-of-coefficients"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Manual Calculation of Coefficients </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Calculate means
</span><span class="n">temp_mean</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>
<span class="n">growth_mean</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ring_width</span><span class="p">)</span>

<span class="c1"># Calculate slope (β₁)
</span><span class="n">numerator</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">((</span><span class="n">temperature</span> <span class="o">-</span> <span class="n">temp_mean</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ring_width</span> <span class="o">-</span> <span class="n">growth_mean</span><span class="p">))</span>
<span class="n">denominator</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">((</span><span class="n">temperature</span> <span class="o">-</span> <span class="n">temp_mean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">beta_1</span> <span class="o">=</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span>

<span class="c1"># Calculate intercept (β₀)
</span><span class="n">beta_0</span> <span class="o">=</span> <span class="n">growth_mean</span> <span class="o">-</span> <span class="n">beta_1</span> <span class="o">*</span> <span class="n">temp_mean</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Manual calculation:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Slope (β₁): </span><span class="si">{</span><span class="n">beta_1</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> mm/°C"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Intercept (β₀): </span><span class="si">{</span><span class="n">beta_0</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> mm"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Interpretation: For each 1°C increase in temperature,"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"tree ring width increases by </span><span class="si">{</span><span class="n">beta_1</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="s"> mm"</span><span class="p">)</span>

<span class="c1"># Predictions
</span><span class="n">growth_predicted</span> <span class="o">=</span> <span class="n">beta_0</span> <span class="o">+</span> <span class="n">beta_1</span> <span class="o">*</span> <span class="n">temperature</span>

<span class="c1"># Calculate R-squared
</span><span class="n">ss_res</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">((</span><span class="n">ring_width</span> <span class="o">-</span> <span class="n">growth_predicted</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ss_tot</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">((</span><span class="n">ring_width</span> <span class="o">-</span> <span class="n">growth_mean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">r_squared</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">ss_res</span> <span class="o">/</span> <span class="n">ss_tot</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">R-squared: </span><span class="si">{</span><span class="n">r_squared</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Temperature explains </span><span class="si">{</span><span class="n">r_squared</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">% of the variance in tree growth"</span><span class="p">)</span>
</code></pre></div></div> <h3 id="using-scikit-learn"> <a href="#using-scikit-learn" class="anchor-heading" aria-labelledby="using-scikit-learn"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using Scikit-learn </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>

<span class="c1"># Reshape for sklearn (requires 2D array)
</span><span class="n">X</span> <span class="o">=</span> <span class="n">temperature</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">ring_width</span>

<span class="c1"># Create and fit the model
</span><span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Scikit-learn results:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Slope: </span><span class="si">{</span><span class="n">model</span><span class="p">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> mm/°C"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Intercept: </span><span class="si">{</span><span class="n">model</span><span class="p">.</span><span class="n">intercept_</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> mm"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"R-squared: </span><span class="si">{</span><span class="n">model</span><span class="p">.</span><span class="n">score</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div> <h3 id="visualization"> <a href="#visualization" class="anchor-heading" aria-labelledby="visualization"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Visualization </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create visualization with regression line and residuals
</span><span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="p">.</span><span class="n">Figure</span><span class="p">()</span>

<span class="c1"># Add scatter plot of observed data
</span><span class="n">fig</span><span class="p">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="p">.</span><span class="n">Scatter</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ring_width</span><span class="p">,</span> 
    <span class="n">mode</span><span class="o">=</span><span class="s">'markers'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'Observed Growth'</span><span class="p">,</span>
    <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'forestgreen'</span><span class="p">)</span>
<span class="p">))</span>

<span class="c1"># Add regression line
</span><span class="n">fig</span><span class="p">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="p">.</span><span class="n">Scatter</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">growth_predicted</span><span class="p">,</span> 
    <span class="n">mode</span><span class="o">=</span><span class="s">'lines'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'Regression Line'</span><span class="p">,</span>
    <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">'darkgreen'</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="p">))</span>

<span class="c1"># Add residual lines
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temperature</span><span class="p">)):</span>
    <span class="n">fig</span><span class="p">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="p">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">temperature</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">temperature</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> 
        <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">ring_width</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">growth_predicted</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
        <span class="n">mode</span><span class="o">=</span><span class="s">'lines'</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">'gray'</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s">'dash'</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="bp">False</span>
    <span class="p">))</span>

<span class="n">fig</span><span class="p">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s">'Tree Ring Width vs Mean Annual Temperature'</span><span class="p">,</span>
    <span class="n">xaxis_title</span><span class="o">=</span><span class="s">'Mean Annual Temperature (°C)'</span><span class="p">,</span>
    <span class="n">yaxis_title</span><span class="o">=</span><span class="s">'Tree Ring Width (mm)'</span><span class="p">,</span>
    <span class="n">template</span><span class="o">=</span><span class="s">'simple_white'</span>
<span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div> <h2 id="23-interpreting-the-coefficients"> <a href="#23-interpreting-the-coefficients" class="anchor-heading" aria-labelledby="23-interpreting-the-coefficients"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2.3 Interpreting the Coefficients </h2> <ul> <li> <p><strong>Intercept (β₀)</strong>: The predicted tree ring width when temperature is 0°C. In this context, it may not have practical ecological meaning (trees don’t grow at 0°C), but it’s needed for the mathematical model.</p> </li> <li> <p><strong>Slope (β₁)</strong>: For each 1°C increase in temperature, tree ring width increases by approximately β₁ mm. This is the key ecological insight — it quantifies the temperature sensitivity of tree growth.</p> </li> </ul> <h2 id="24-making-predictions"> <a href="#24-making-predictions" class="anchor-heading" aria-labelledby="24-making-predictions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2.4 Making Predictions </h2> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Predict growth at new temperatures
</span><span class="n">new_temps</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">19</span><span class="p">]).</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">predicted_growth</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">new_temps</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Predictions for new temperatures:"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">temp</span><span class="p">,</span> <span class="n">growth</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">new_temps</span><span class="p">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">predicted_growth</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  </span><span class="si">{</span><span class="n">temp</span><span class="si">}</span><span class="s">°C → </span><span class="si">{</span><span class="n">growth</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> mm ring width"</span><span class="p">)</span>
</code></pre></div></div> <div style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 5px;"> <div class="notice--primary"> <h3> <a href="#24-making-predictions" class="anchor-heading" aria-labelledby="24-making-predictions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exercise 2.1 </h3> <p>Create a dataset representing the relationship between annual precipitation (mm) and grassland productivity (kg biomass per hectare). Fit a simple regression model and interpret the coefficients. What does the slope tell you about water limitation in grasslands?</p> <details> <summary>Solution!</summary> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="n">px</span>

<span class="c1"># Create grassland productivity data
</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Precipitation gradient (mm/year)
</span><span class="n">precipitation</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="mi">200</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1100</span><span class="p">])</span>

<span class="c1"># Biomass production (kg/ha) - increases with precipitation
</span><span class="n">biomass</span> <span class="o">=</span> <span class="mi">500</span> <span class="o">+</span> <span class="mf">3.5</span> <span class="o">*</span> <span class="n">precipitation</span> <span class="o">+</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">precipitation</span><span class="p">))</span>

<span class="c1"># Fit model
</span><span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">precipitation</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">biomass</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Intercept: </span><span class="si">{</span><span class="n">model</span><span class="p">.</span><span class="n">intercept_</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> kg/ha"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Slope: </span><span class="si">{</span><span class="n">model</span><span class="p">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s"> kg/ha per mm precipitation"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"R-squared: </span><span class="si">{</span><span class="n">model</span><span class="p">.</span><span class="n">score</span><span class="p">(</span><span class="n">precipitation</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">biomass</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># Interpretation:
# The slope tells us that each additional mm of annual precipitation 
# increases grassland productivity by ~3.5 kg/ha
# This quantifies the water use efficiency of the grassland ecosystem
</span>
<span class="c1"># Visualize
</span><span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">precipitation</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">biomass</span><span class="p">,</span> 
                 <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s">'x'</span><span class="p">:</span> <span class="s">'Annual Precipitation (mm)'</span><span class="p">,</span> <span class="s">'y'</span><span class="p">:</span> <span class="s">'Biomass (kg/ha)'</span><span class="p">})</span>
<span class="n">fig</span><span class="p">.</span><span class="n">add_scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">precipitation</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">precipitation</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> 
                <span class="n">mode</span><span class="o">=</span><span class="s">'lines'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'Regression Line'</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">'Grassland Productivity vs Precipitation'</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s">'simple_white'</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div> </div> </details> </div> </div> <h2 id="25-assumptions-and-diagnostics"> <a href="#25-assumptions-and-diagnostics" class="anchor-heading" aria-labelledby="25-assumptions-and-diagnostics"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2.5 Assumptions and Diagnostics </h2> <p>Simple linear regression makes several assumptions:</p> <ol> <li><strong>Linearity</strong>: The relationship is truly linear</li> <li><strong>Independence</strong>: Observations are independent</li> <li><strong>Homoscedasticity</strong>: Variance of residuals is constant</li> <li><strong>Normality</strong>: Residuals are normally distributed</li> </ol> <h3 id="checking-assumptions-with-residual-plots"> <a href="#checking-assumptions-with-residual-plots" class="anchor-heading" aria-labelledby="checking-assumptions-with-residual-plots"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Checking Assumptions with Residual Plots </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Calculate residuals
</span><span class="n">residuals</span> <span class="o">=</span> <span class="n">ring_width</span> <span class="o">-</span> <span class="n">growth_predicted</span>

<span class="c1"># Residual plot
</span><span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">growth_predicted</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">residuals</span><span class="p">,</span>
                 <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s">'x'</span><span class="p">:</span> <span class="s">'Predicted Values'</span><span class="p">,</span> <span class="s">'y'</span><span class="p">:</span> <span class="s">'Residuals'</span><span class="p">})</span>
<span class="n">fig</span><span class="p">.</span><span class="n">add_hline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">line_dash</span><span class="o">=</span><span class="s">'dash'</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="s">'red'</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">update_layout</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s">'Residual Plot: Checking for Patterns'</span><span class="p">,</span>
    <span class="n">template</span><span class="o">=</span><span class="s">'simple_white'</span>
<span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># A good residual plot shows random scatter around zero
# Patterns suggest the linear model may not be appropriate
</span></code></pre></div></div> <h2 id="26-limitations-of-simple-regression"> <a href="#26-limitations-of-simple-regression" class="anchor-heading" aria-labelledby="26-limitations-of-simple-regression"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2.6 Limitations of Simple Regression </h2> <p>While simple regression is powerful, it has limitations in ecological contexts:</p> <ol> <li><strong>Single predictor</strong>: Ecological systems are influenced by multiple factors simultaneously</li> <li><strong>Linear assumption</strong>: Many ecological relationships are non-linear (e.g., species-area curves, thermal performance curves)</li> <li><strong>No interactions</strong>: Cannot capture how predictors modify each other’s effects</li> </ol> <p>These limitations motivate the use of multiple regression and machine learning approaches.</p><hr /> <h1 id="chapter-3-multiple-regression"> <a href="#chapter-3-multiple-regression" class="anchor-heading" aria-labelledby="chapter-3-multiple-regression"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <strong>Chapter 3: Multiple Regression</strong> </h1> <p>In ecology, outcomes are rarely determined by a single factor. Multiple regression allows us to model how several environmental variables jointly influence an ecological response.</p> <h2 id="31-the-model"> <a href="#31-the-model" class="anchor-heading" aria-labelledby="31-the-model"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.1 The Model </h2> <p>Multiple regression extends simple regression to include multiple predictors:</p> <p><strong>y = β₀ + β₁x₁ + β₂x₂ + … + βₚxₚ + ε</strong></p> <p>Where p is the number of predictor variables.</p> <h3 id="why-multiple-regression-in-ecology"> <a href="#why-multiple-regression-in-ecology" class="anchor-heading" aria-labelledby="why-multiple-regression-in-ecology"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Why Multiple Regression in Ecology? </h3> <p>Ecological systems are complex:</p> <ul> <li>Plant growth depends on temperature, precipitation, soil nutrients, and light</li> <li>Fish abundance is influenced by water temperature, oxygen, pH, and food availability</li> <li>Carbon flux varies with radiation, temperature, humidity, and soil moisture</li> </ul> <p>Multiple regression allows us to:</p> <ol> <li>Include all relevant environmental drivers in one model</li> <li>Understand the unique contribution of each factor while controlling for others</li> <li>Make more accurate predictions</li> </ol> <h2 id="32-ecological-example-forest-carbon-flux"> <a href="#32-ecological-example-forest-carbon-flux" class="anchor-heading" aria-labelledby="32-ecological-example-forest-carbon-flux"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.2 Ecological Example: Forest Carbon Flux </h2> <p>Let’s model ecosystem carbon flux (Net Ecosystem Exchange, NEE) as a function of environmental variables.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">import</span> <span class="nn">sklearn.metrics</span> <span class="k">as</span> <span class="n">metrics</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="n">px</span>

<span class="c1"># Create synthetic forest carbon flux dataset
</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">300</span>

<span class="c1"># Environmental predictors
</span><span class="n">solar_radiation</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>      <span class="c1"># W/m² (PAR)
</span><span class="n">air_temperature</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>         <span class="c1"># °C
</span><span class="n">soil_moisture</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>          <span class="c1"># % volumetric
</span><span class="n">vapor_pressure_deficit</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="c1"># kPa
</span>
<span class="c1"># Carbon flux (μmol CO₂ m⁻² s⁻¹)
# Negative = carbon uptake (photosynthesis), Positive = carbon release (respiration)
</span><span class="n">carbon_flux</span> <span class="o">=</span> <span class="p">(</span>
    <span class="mi">5</span> <span class="o">-</span>                                    <span class="c1"># Base respiration
</span>    <span class="mf">0.015</span> <span class="o">*</span> <span class="n">solar_radiation</span> <span class="o">+</span>              <span class="c1"># Light drives photosynthesis (uptake)
</span>    <span class="mf">0.3</span> <span class="o">*</span> <span class="n">air_temperature</span> <span class="o">+</span>                <span class="c1"># Warm temps increase respiration
</span>    <span class="o">-</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">soil_moisture</span> <span class="o">+</span>                 <span class="c1"># Wet soils support more uptake
</span>    <span class="mf">2.0</span> <span class="o">*</span> <span class="n">vapor_pressure_deficit</span> <span class="o">+</span>         <span class="c1"># High VPD reduces uptake (stomatal closure)
</span>    <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>            <span class="c1"># Random variation
</span><span class="p">)</span>

<span class="c1"># Create DataFrame
</span><span class="n">flux_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s">'solar_radiation'</span><span class="p">:</span> <span class="n">solar_radiation</span><span class="p">,</span>
    <span class="s">'air_temperature'</span><span class="p">:</span> <span class="n">air_temperature</span><span class="p">,</span>
    <span class="s">'soil_moisture'</span><span class="p">:</span> <span class="n">soil_moisture</span><span class="p">,</span>
    <span class="s">'vapor_pressure_deficit'</span><span class="p">:</span> <span class="n">vapor_pressure_deficit</span><span class="p">,</span>
    <span class="s">'carbon_flux'</span><span class="p">:</span> <span class="n">carbon_flux</span>
<span class="p">})</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Forest Carbon Flux Dataset:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">flux_data</span><span class="p">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Dataset shape: </span><span class="si">{</span><span class="n">flux_data</span><span class="p">.</span><span class="n">shape</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Carbon flux range: </span><span class="si">{</span><span class="n">carbon_flux</span><span class="p">.</span><span class="nb">min</span><span class="p">()</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> to </span><span class="si">{</span><span class="n">carbon_flux</span><span class="p">.</span><span class="nb">max</span><span class="p">()</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s"> μmol/m²/s"</span><span class="p">)</span>
</code></pre></div></div> <h2 id="33-exploring-correlations"> <a href="#33-exploring-correlations" class="anchor-heading" aria-labelledby="33-exploring-correlations"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.3 Exploring Correlations </h2> <p>Before building a model, examine correlations between variables:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Correlation matrix
</span><span class="n">correlation_matrix</span> <span class="o">=</span> <span class="n">flux_data</span><span class="p">.</span><span class="n">corr</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Correlation Matrix:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">correlation_matrix</span><span class="p">.</span><span class="nb">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

<span class="c1"># Visualize correlations
</span><span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span>
    <span class="n">correlation_matrix</span><span class="p">,</span>
    <span class="n">text_auto</span><span class="o">=</span><span class="s">'.2f'</span><span class="p">,</span>
    <span class="n">color_continuous_scale</span><span class="o">=</span><span class="s">'RdBu_r'</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s">'Correlation Matrix: Environmental Variables and Carbon Flux'</span>
<span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Focus on correlations with target variable
</span><span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Correlations with Carbon Flux:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">correlation_matrix</span><span class="p">[</span><span class="s">'carbon_flux'</span><span class="p">].</span><span class="n">sort_values</span><span class="p">())</span>
</code></pre></div></div> <h2 id="34-fitting-multiple-regression"> <a href="#34-fitting-multiple-regression" class="anchor-heading" aria-labelledby="34-fitting-multiple-regression"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.4 Fitting Multiple Regression </h2> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Prepare data
</span><span class="n">X</span> <span class="o">=</span> <span class="n">flux_data</span><span class="p">[[</span><span class="s">'solar_radiation'</span><span class="p">,</span> <span class="s">'air_temperature'</span><span class="p">,</span> <span class="s">'soil_moisture'</span><span class="p">,</span> <span class="s">'vapor_pressure_deficit'</span><span class="p">]]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">flux_data</span><span class="p">[</span><span class="s">'carbon_flux'</span><span class="p">]</span>

<span class="c1"># Split into training and testing sets
</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Training set size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Testing set size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># Fit the model
</span><span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Model coefficients
</span><span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">=== Multiple Regression Model ==="</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Intercept: </span><span class="si">{</span><span class="n">model</span><span class="p">.</span><span class="n">intercept_</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Coefficients:"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">coef</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="p">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">coef_</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">coef</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div> <h2 id="35-interpreting-coefficients"> <a href="#35-interpreting-coefficients" class="anchor-heading" aria-labelledby="35-interpreting-coefficients"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.5 Interpreting Coefficients </h2> <p>Each coefficient represents the expected change in carbon flux for a one-unit increase in that predictor, <strong>holding all other predictors constant</strong>:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">=== Ecological Interpretation ==="</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"""
Solar Radiation (</span><span class="si">{</span><span class="n">model</span><span class="p">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">):
  Each additional W/m² of radiation decreases carbon flux by </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> μmol/m²/s
  → More light = more photosynthesis = more carbon uptake (negative flux)

Air Temperature (</span><span class="si">{</span><span class="n">model</span><span class="p">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">):
  Each 1°C increase raises carbon flux by </span><span class="si">{</span><span class="n">model</span><span class="p">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> μmol/m²/s
  → Warmer temps = more respiration = more carbon release (positive flux)

Soil Moisture (</span><span class="si">{</span><span class="n">model</span><span class="p">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">):
  Each 1% increase in soil moisture decreases flux by </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> μmol/m²/s
  → Wetter soils = more productivity = more carbon uptake

Vapor Pressure Deficit (</span><span class="si">{</span><span class="n">model</span><span class="p">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">):
  Each 1 kPa increase raises carbon flux by </span><span class="si">{</span><span class="n">model</span><span class="p">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> μmol/m²/s
  → High VPD = stomatal closure = reduced photosynthesis = less uptake
"""</span><span class="p">)</span>
</code></pre></div></div> <h2 id="36-model-evaluation"> <a href="#36-model-evaluation" class="anchor-heading" aria-labelledby="36-model-evaluation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.6 Model Evaluation </h2> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Make predictions on test set
</span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Calculate metrics
</span><span class="k">def</span> <span class="nf">regression_results</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">mae</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">.</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">.</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">=== Model Performance ==="</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"R-squared: </span><span class="si">{</span><span class="n">r2</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  → Model explains </span><span class="si">{</span><span class="n">r2</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">% of variance in carbon flux"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"MAE: </span><span class="si">{</span><span class="n">mae</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> μmol/m²/s"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"RMSE: </span><span class="si">{</span><span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mse</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> μmol/m²/s"</span><span class="p">)</span>

<span class="n">regression_results</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

<span class="c1"># Visualize predictions vs actual
</span><span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_pred</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s">'x'</span><span class="p">:</span> <span class="s">'Observed Carbon Flux (μmol/m²/s)'</span><span class="p">,</span> 
            <span class="s">'y'</span><span class="p">:</span> <span class="s">'Predicted Carbon Flux (μmol/m²/s)'</span><span class="p">},</span>
    <span class="n">title</span><span class="o">=</span><span class="s">'Multiple Regression: Predicted vs Observed Carbon Flux'</span>
<span class="p">)</span>
<span class="c1"># Add 1:1 line (perfect prediction)
</span><span class="n">fig</span><span class="p">.</span><span class="n">add_scatter</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">y_test</span><span class="p">.</span><span class="nb">min</span><span class="p">(),</span> <span class="n">y_test</span><span class="p">.</span><span class="nb">max</span><span class="p">()],</span>
    <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">y_test</span><span class="p">.</span><span class="nb">min</span><span class="p">(),</span> <span class="n">y_test</span><span class="p">.</span><span class="nb">max</span><span class="p">()],</span>
    <span class="n">mode</span><span class="o">=</span><span class="s">'lines'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'1:1 Line'</span><span class="p">,</span>
    <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">'red'</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s">'dash'</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="s">'simple_white'</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div> <h2 id="37-comparing-models-with-different-predictors"> <a href="#37-comparing-models-with-different-predictors" class="anchor-heading" aria-labelledby="37-comparing-models-with-different-predictors"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.7 Comparing Models with Different Predictors </h2> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Compare models with different numbers of predictors
</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Model 1: Only solar radiation
</span><span class="n">model1</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">model1</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">[[</span><span class="s">'solar_radiation'</span><span class="p">]],</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">r2_1</span> <span class="o">=</span> <span class="n">model1</span><span class="p">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">[[</span><span class="s">'solar_radiation'</span><span class="p">]],</span> <span class="n">y_test</span><span class="p">)</span>
<span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">({</span><span class="s">'Predictors'</span><span class="p">:</span> <span class="s">'Solar radiation only'</span><span class="p">,</span> <span class="s">'R²'</span><span class="p">:</span> <span class="n">r2_1</span><span class="p">})</span>

<span class="c1"># Model 2: Radiation + Temperature
</span><span class="n">model2</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">model2</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">[[</span><span class="s">'solar_radiation'</span><span class="p">,</span> <span class="s">'air_temperature'</span><span class="p">]],</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">r2_2</span> <span class="o">=</span> <span class="n">model2</span><span class="p">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">[[</span><span class="s">'solar_radiation'</span><span class="p">,</span> <span class="s">'air_temperature'</span><span class="p">]],</span> <span class="n">y_test</span><span class="p">)</span>
<span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">({</span><span class="s">'Predictors'</span><span class="p">:</span> <span class="s">'Radiation + Temperature'</span><span class="p">,</span> <span class="s">'R²'</span><span class="p">:</span> <span class="n">r2_2</span><span class="p">})</span>

<span class="c1"># Model 3: Three predictors
</span><span class="n">model3</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">model3</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">[[</span><span class="s">'solar_radiation'</span><span class="p">,</span> <span class="s">'air_temperature'</span><span class="p">,</span> <span class="s">'soil_moisture'</span><span class="p">]],</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">r2_3</span> <span class="o">=</span> <span class="n">model3</span><span class="p">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">[[</span><span class="s">'solar_radiation'</span><span class="p">,</span> <span class="s">'air_temperature'</span><span class="p">,</span> <span class="s">'soil_moisture'</span><span class="p">]],</span> <span class="n">y_test</span><span class="p">)</span>
<span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">({</span><span class="s">'Predictors'</span><span class="p">:</span> <span class="s">'Radiation + Temp + Soil moisture'</span><span class="p">,</span> <span class="s">'R²'</span><span class="p">:</span> <span class="n">r2_3</span><span class="p">})</span>

<span class="c1"># Model 4: All predictors
</span><span class="n">model4</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">model4</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">r2_4</span> <span class="o">=</span> <span class="n">model4</span><span class="p">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">({</span><span class="s">'Predictors'</span><span class="p">:</span> <span class="s">'All four predictors'</span><span class="p">,</span> <span class="s">'R²'</span><span class="p">:</span> <span class="n">r2_4</span><span class="p">})</span>

<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">=== Model Comparison ==="</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">results_df</span><span class="p">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>

<span class="c1"># Visualize
</span><span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="p">.</span><span class="n">bar</span><span class="p">(</span><span class="n">results_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">'Predictors'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'R²'</span><span class="p">,</span> 
             <span class="n">title</span><span class="o">=</span><span class="s">'Model Performance with Increasing Predictors'</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="s">'simple_white'</span><span class="p">,</span> <span class="n">xaxis_tickangle</span><span class="o">=-</span><span class="mi">45</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div> <div style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 5px;"> <div class="notice--primary"> <h3> <a href="#37-comparing-models-with-different-predictors" class="anchor-heading" aria-labelledby="37-comparing-models-with-different-predictors"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exercise 3.1 </h3> <p>Create a multiple regression model to predict fish species richness in lakes based on: lake area (ha), maximum depth (m), water temperature (°C), and dissolved oxygen (mg/L). Which environmental factor has the strongest influence on fish diversity?</p> <details> <summary>Solution!</summary> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">150</span>

<span class="c1"># Lake characteristics
</span><span class="n">lake_area</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>         <span class="c1"># hectares
</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>            <span class="c1"># meters
</span><span class="n">water_temp</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>          <span class="c1"># °C
</span><span class="n">dissolved_oxygen</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>     <span class="c1"># mg/L
</span>
<span class="c1"># Fish species richness (count)
# Larger, deeper lakes with moderate temp and high oxygen have more species
</span><span class="n">richness</span> <span class="o">=</span> <span class="p">(</span>
    <span class="mi">5</span> <span class="o">+</span>
    <span class="mf">0.005</span> <span class="o">*</span> <span class="n">lake_area</span> <span class="o">+</span>              <span class="c1"># Species-area relationship
</span>    <span class="mf">0.3</span> <span class="o">*</span> <span class="n">max_depth</span> <span class="o">+</span>                <span class="c1"># Deeper = more habitat diversity
</span>    <span class="o">-</span><span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">water_temp</span> <span class="o">-</span> <span class="mi">18</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>    <span class="c1"># Optimum around 18°C
</span>    <span class="mf">1.5</span> <span class="o">*</span> <span class="n">dissolved_oxygen</span> <span class="o">+</span>         <span class="c1"># Oxygen is critical
</span>    <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="p">).</span><span class="n">clip</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># At least 1 species
</span>
<span class="n">lake_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s">'lake_area_ha'</span><span class="p">:</span> <span class="n">lake_area</span><span class="p">,</span>
    <span class="s">'max_depth_m'</span><span class="p">:</span> <span class="n">max_depth</span><span class="p">,</span>
    <span class="s">'water_temp_C'</span><span class="p">:</span> <span class="n">water_temp</span><span class="p">,</span>
    <span class="s">'dissolved_oxygen_mgL'</span><span class="p">:</span> <span class="n">dissolved_oxygen</span><span class="p">,</span>
    <span class="s">'fish_richness'</span><span class="p">:</span> <span class="n">richness</span>
<span class="p">})</span>

<span class="c1"># Fit model
</span><span class="n">X</span> <span class="o">=</span> <span class="n">lake_data</span><span class="p">[[</span><span class="s">'lake_area_ha'</span><span class="p">,</span> <span class="s">'max_depth_m'</span><span class="p">,</span> <span class="s">'water_temp_C'</span><span class="p">,</span> <span class="s">'dissolved_oxygen_mgL'</span><span class="p">]]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">lake_data</span><span class="p">[</span><span class="s">'fish_richness'</span><span class="p">]</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"=== Fish Richness Model ==="</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"R²: </span><span class="si">{</span><span class="n">model</span><span class="p">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Coefficients (absolute value = relative importance):"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">feat</span><span class="p">,</span> <span class="n">coef</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="p">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">coef_</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">coef</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># Dissolved oxygen typically shows the strongest effect
# This makes ecological sense - oxygen is essential for fish survival
</span></code></pre></div> </div> </details> </div> </div> <h2 id="38-checking-for-multicollinearity"> <a href="#38-checking-for-multicollinearity" class="anchor-heading" aria-labelledby="38-checking-for-multicollinearity"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.8 Checking for Multicollinearity </h2> <p>When predictors are highly correlated with each other, coefficient estimates become unstable:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Check correlations between predictors
</span><span class="n">predictor_corr</span> <span class="o">=</span> <span class="n">X</span><span class="p">.</span><span class="n">corr</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Correlations between predictors:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">predictor_corr</span><span class="p">.</span><span class="nb">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

<span class="c1"># High correlations (&gt;0.7 or &lt;-0.7) suggest multicollinearity
# In our simulated data, predictors are independent
# In real ecological data, temperature and VPD are often correlated
</span></code></pre></div></div> <h2 id="39-limitations-of-multiple-regression"> <a href="#39-limitations-of-multiple-regression" class="anchor-heading" aria-labelledby="39-limitations-of-multiple-regression"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3.9 Limitations of Multiple Regression </h2> <p>While powerful, multiple regression has limitations:</p> <ol> <li><strong>Assumes linear relationships</strong>: Many ecological relationships are curved (e.g., thermal optima, saturation curves)</li> <li><strong>Assumes additive effects</strong>: Cannot capture interactions unless explicitly included</li> <li><strong>Sensitive to outliers</strong>: Extreme values can strongly influence results</li> <li><strong>Requires many observations</strong>: Need roughly 10-20 observations per predictor</li> </ol> <p>These limitations motivate the use of machine learning approaches.</p><hr /> <h1 id="chapter-4-machine-learning-approaches"> <a href="#chapter-4-machine-learning-approaches" class="anchor-heading" aria-labelledby="chapter-4-machine-learning-approaches"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <strong>Chapter 4: Machine Learning Approaches</strong> </h1> <p>Machine learning algorithms can capture complex, non-linear relationships in ecological data. This chapter introduces Random Forest, one of the most widely used and effective algorithms in ecology.</p> <h2 id="41-why-machine-learning-in-ecology"> <a href="#41-why-machine-learning-in-ecology" class="anchor-heading" aria-labelledby="41-why-machine-learning-in-ecology"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4.1 Why Machine Learning in Ecology? </h2> <p>Ecological relationships are often:</p> <ul> <li><strong>Non-linear</strong>: Species have thermal optima, resources have diminishing returns</li> <li><strong>Interactive</strong>: Effects of one variable depend on others (e.g., temperature effects depend on moisture)</li> <li><strong>Complex</strong>: Many variables influence outcomes in ways hard to specify mathematically</li> </ul> <p>Machine learning algorithms can automatically discover these patterns.</p> <h2 id="42-decision-trees-the-building-block"> <a href="#42-decision-trees-the-building-block" class="anchor-heading" aria-labelledby="42-decision-trees-the-building-block"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4.2 Decision Trees: The Building Block </h2> <p>Before understanding Random Forests, we need to understand decision trees.</p> <h3 id="how-decision-trees-work"> <a href="#how-decision-trees-work" class="anchor-heading" aria-labelledby="how-decision-trees-work"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How Decision Trees Work </h3> <ol> <li><strong>Start with all data</strong> at the root node</li> <li><strong>Find the best split</strong>: Which variable and threshold best separates high vs low values?</li> <li><strong>Create child nodes</strong> based on the split</li> <li><strong>Repeat</strong> until stopping criteria are met</li> <li><strong>Predict</strong> using the mean value in each terminal node (leaf)</li> </ol> <h3 id="ecological-intuition"> <a href="#ecological-intuition" class="anchor-heading" aria-labelledby="ecological-intuition"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Ecological Intuition </h3> <p>Think of a decision tree as a series of ecological questions:</p> <ul> <li>Is temperature &gt; 15°C? <ul> <li>YES: Is precipitation &gt; 500mm? <ul> <li>YES: High productivity</li> <li>NO: Medium productivity</li> </ul> </li> <li>NO: Low productivity</li> </ul> </li> </ul> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeRegressor</span><span class="p">,</span> <span class="n">plot_tree</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1"># Use the carbon flux data
</span><span class="n">X</span> <span class="o">=</span> <span class="n">flux_data</span><span class="p">[[</span><span class="s">'solar_radiation'</span><span class="p">,</span> <span class="s">'air_temperature'</span><span class="p">,</span> <span class="s">'soil_moisture'</span><span class="p">,</span> <span class="s">'vapor_pressure_deficit'</span><span class="p">]]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">flux_data</span><span class="p">[</span><span class="s">'carbon_flux'</span><span class="p">]</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Fit a simple decision tree
</span><span class="n">tree_model</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tree_model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Visualize the tree
</span><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plot_tree</span><span class="p">(</span><span class="n">tree_model</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">X</span><span class="p">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">filled</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">rounded</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Decision Tree for Carbon Flux Prediction'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Evaluate
</span><span class="n">tree_r2</span> <span class="o">=</span> <span class="n">tree_model</span><span class="p">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Decision Tree R²: </span><span class="si">{</span><span class="n">tree_r2</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div> <h3 id="advantages-and-disadvantages-of-decision-trees"> <a href="#advantages-and-disadvantages-of-decision-trees" class="anchor-heading" aria-labelledby="advantages-and-disadvantages-of-decision-trees"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Advantages and Disadvantages of Decision Trees </h3> <p><strong>Advantages:</strong></p> <ul> <li>Easy to interpret and visualize</li> <li>Handle non-linear relationships naturally</li> <li>No assumptions about data distribution</li> <li>Capture interactions automatically</li> </ul> <p><strong>Disadvantages:</strong></p> <ul> <li>Prone to overfitting</li> <li>Unstable (small data changes → different trees)</li> <li>Can create biased predictions</li> </ul> <h2 id="43-random-forests"> <a href="#43-random-forests" class="anchor-heading" aria-labelledby="43-random-forests"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4.3 Random Forests </h2> <p>Random Forests address the weaknesses of single decision trees by combining many trees through <strong>ensemble learning</strong>.</p> <h3 id="how-random-forests-work"> <a href="#how-random-forests-work" class="anchor-heading" aria-labelledby="how-random-forests-work"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How Random Forests Work </h3> <ol> <li><strong>Create many decision trees</strong> (typically 100-500)</li> <li><strong>Each tree uses a bootstrap sample</strong> (random sample with replacement from training data)</li> <li><strong>At each split, only a random subset of features is considered</strong></li> <li><strong>Final prediction</strong>: Average of all tree predictions</li> </ol> <p>This approach:</p> <ul> <li><strong>Reduces overfitting</strong> through averaging</li> <li><strong>Increases stability</strong> (results don’t depend on single trees)</li> <li><strong>Maintains ability to capture complex patterns</strong></li> </ul> <h3 id="implementation"> <a href="#implementation" class="anchor-heading" aria-labelledby="implementation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Implementation </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>

<span class="c1"># Fit Random Forest
</span><span class="n">rf_model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span>
    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>      <span class="c1"># Number of trees
</span>    <span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>          <span class="c1"># Maximum depth of each tree
</span>    <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>    <span class="c1"># Minimum samples in leaf nodes
</span>    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>
<span class="n">rf_model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Evaluate
</span><span class="n">y_pred_rf</span> <span class="o">=</span> <span class="n">rf_model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">rf_r2</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">.</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_rf</span><span class="p">)</span>
<span class="n">rf_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_rf</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="s">"=== Random Forest Performance ==="</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"R²: </span><span class="si">{</span><span class="n">rf_r2</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"RMSE: </span><span class="si">{</span><span class="n">rf_rmse</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> μmol/m²/s"</span><span class="p">)</span>
</code></pre></div></div> <h2 id="44-comparing-methods"> <a href="#44-comparing-methods" class="anchor-heading" aria-labelledby="44-comparing-methods"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4.4 Comparing Methods </h2> <p>Let’s systematically compare all three approaches:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>

<span class="c1"># Prepare comparison
</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Simple Linear Regression (using only solar radiation)
</span><span class="n">simple_lr</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">simple_lr</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">[[</span><span class="s">'solar_radiation'</span><span class="p">]],</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">simple_pred</span> <span class="o">=</span> <span class="n">simple_lr</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">[[</span><span class="s">'solar_radiation'</span><span class="p">]])</span>
<span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
    <span class="s">'Method'</span><span class="p">:</span> <span class="s">'Simple Regression'</span><span class="p">,</span>
    <span class="s">'R²'</span><span class="p">:</span> <span class="n">metrics</span><span class="p">.</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">simple_pred</span><span class="p">),</span>
    <span class="s">'RMSE'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">simple_pred</span><span class="p">))</span>
<span class="p">})</span>

<span class="c1"># Multiple Regression
</span><span class="n">multi_lr</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">multi_lr</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">multi_pred</span> <span class="o">=</span> <span class="n">multi_lr</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
    <span class="s">'Method'</span><span class="p">:</span> <span class="s">'Multiple Regression'</span><span class="p">,</span>
    <span class="s">'R²'</span><span class="p">:</span> <span class="n">metrics</span><span class="p">.</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">multi_pred</span><span class="p">),</span>
    <span class="s">'RMSE'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">multi_pred</span><span class="p">))</span>
<span class="p">})</span>

<span class="c1"># Decision Tree
</span><span class="n">dt</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">dt</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">dt_pred</span> <span class="o">=</span> <span class="n">dt</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
    <span class="s">'Method'</span><span class="p">:</span> <span class="s">'Decision Tree'</span><span class="p">,</span>
    <span class="s">'R²'</span><span class="p">:</span> <span class="n">metrics</span><span class="p">.</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">dt_pred</span><span class="p">),</span>
    <span class="s">'RMSE'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">dt_pred</span><span class="p">))</span>
<span class="p">})</span>

<span class="c1"># Random Forest
</span><span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">rf</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">rf_pred</span> <span class="o">=</span> <span class="n">rf</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
    <span class="s">'Method'</span><span class="p">:</span> <span class="s">'Random Forest'</span><span class="p">,</span>
    <span class="s">'R²'</span><span class="p">:</span> <span class="n">metrics</span><span class="p">.</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">rf_pred</span><span class="p">),</span>
    <span class="s">'RMSE'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">rf_pred</span><span class="p">))</span>
<span class="p">})</span>

<span class="c1"># Display results
</span><span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">=== Method Comparison ==="</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">results_df</span><span class="p">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>

<span class="c1"># Visualize
</span><span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="p">.</span><span class="n">bar</span><span class="p">(</span><span class="n">results_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">'Method'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'R²'</span><span class="p">,</span> 
             <span class="n">title</span><span class="o">=</span><span class="s">'Model Comparison: Carbon Flux Prediction'</span><span class="p">,</span>
             <span class="n">text</span><span class="o">=</span><span class="s">'R²'</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">texttemplate</span><span class="o">=</span><span class="s">'%{text:.3f}'</span><span class="p">,</span> <span class="n">textposition</span><span class="o">=</span><span class="s">'outside'</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="s">'simple_white'</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div> <h2 id="45-feature-importance"> <a href="#45-feature-importance" class="anchor-heading" aria-labelledby="45-feature-importance"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4.5 Feature Importance </h2> <p>A key advantage of Random Forests is the ability to quantify variable importance:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Feature importance from Random Forest
</span><span class="n">importance</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s">'Variable'</span><span class="p">:</span> <span class="n">X</span><span class="p">.</span><span class="n">columns</span><span class="p">,</span>
    <span class="s">'Importance'</span><span class="p">:</span> <span class="n">rf_model</span><span class="p">.</span><span class="n">feature_importances_</span>
<span class="p">}).</span><span class="n">sort_values</span><span class="p">(</span><span class="s">'Importance'</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">=== Variable Importance ==="</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">importance</span><span class="p">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>

<span class="c1"># Visualize
</span><span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="p">.</span><span class="n">bar</span><span class="p">(</span><span class="n">importance</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">'Importance'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'Variable'</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s">'h'</span><span class="p">,</span>
             <span class="n">title</span><span class="o">=</span><span class="s">'Environmental Drivers of Carbon Flux (Random Forest Importance)'</span><span class="p">,</span>
             <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s">'Importance'</span><span class="p">:</span> <span class="s">'Relative Importance'</span><span class="p">,</span> <span class="s">'Variable'</span><span class="p">:</span> <span class="s">'Environmental Variable'</span><span class="p">})</span>
<span class="n">fig</span><span class="p">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="s">'simple_white'</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div> <h3 id="ecological-interpretation"> <a href="#ecological-interpretation" class="anchor-heading" aria-labelledby="ecological-interpretation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Ecological Interpretation </h3> <p>Variable importance tells us which environmental factors most strongly control carbon flux:</p> <ul> <li>High importance = strong driver of ecosystem carbon exchange</li> <li>Helps prioritize monitoring and research efforts</li> <li>Guides understanding of ecosystem function</li> </ul> <h2 id="46-tuning-random-forest-parameters"> <a href="#46-tuning-random-forest-parameters" class="anchor-heading" aria-labelledby="46-tuning-random-forest-parameters"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4.6 Tuning Random Forest Parameters </h2> <p>Key parameters to optimize:</p> <div class="table-wrapper"><table> <thead> <tr> <th>Parameter</th> <th>Description</th> <th>Effect</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">n_estimators</code></td> <td>Number of trees</td> <td>More trees = better but slower</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">max_depth</code></td> <td>Maximum tree depth</td> <td>Controls overfitting</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">min_samples_leaf</code></td> <td>Minimum samples per leaf</td> <td>Prevents overfitting</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">max_features</code></td> <td>Features per split</td> <td>Controls randomness</td> </tr> </tbody> </table></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Experiment with different numbers of trees
</span><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">n_trees</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">500</span><span class="p">]:</span>
    <span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">n_trees</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">rf</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">rf</span><span class="p">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
    <span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">({</span><span class="s">'n_estimators'</span><span class="p">:</span> <span class="n">n_trees</span><span class="p">,</span> <span class="s">'R²'</span><span class="p">:</span> <span class="n">r2</span><span class="p">})</span>

<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">=== Effect of Number of Trees ==="</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">results_df</span><span class="p">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="p">.</span><span class="n">line</span><span class="p">(</span><span class="n">results_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">'n_estimators'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'R²'</span><span class="p">,</span> <span class="n">markers</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
              <span class="n">title</span><span class="o">=</span><span class="s">'Random Forest Performance vs Number of Trees'</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="s">'simple_white'</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div> <div style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 5px;"> <div class="notice--primary"> <h3> <a href="#46-tuning-random-forest-parameters" class="anchor-heading" aria-labelledby="46-tuning-random-forest-parameters"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exercise 4.1 </h3> <p>Build a Random Forest model to predict plant species richness in meadows based on: soil pH, nitrogen content (mg/kg), annual precipitation (mm), and grazing intensity (livestock units/ha). Compare its performance to multiple regression. Which environmental factor is most important?</p> <details> <summary>Solution!</summary> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">import</span> <span class="nn">sklearn.metrics</span> <span class="k">as</span> <span class="n">metrics</span>

<span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">200</span>

<span class="c1"># Environmental variables
</span><span class="n">soil_ph</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">4.5</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="n">nitrogen</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>          <span class="c1"># mg/kg
</span><span class="n">precipitation</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">1200</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>   <span class="c1"># mm/year
</span><span class="n">grazing</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>              <span class="c1"># livestock units/ha
</span>
<span class="c1"># Species richness (non-linear relationships)
# Optimum pH around 6.5, intermediate nitrogen best, moderate grazing increases diversity
</span><span class="n">richness</span> <span class="o">=</span> <span class="p">(</span>
    <span class="mi">20</span> <span class="o">+</span>
    <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">soil_ph</span> <span class="o">-</span> <span class="mf">6.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>           <span class="c1"># pH optimum
</span>    <span class="o">-</span><span class="mf">0.0005</span> <span class="o">*</span> <span class="p">(</span><span class="n">nitrogen</span> <span class="o">-</span> <span class="mi">50</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>      <span class="c1"># Intermediate N best
</span>    <span class="mf">0.01</span> <span class="o">*</span> <span class="n">precipitation</span> <span class="o">+</span>               <span class="c1"># More rain = more species
</span>    <span class="mi">5</span> <span class="o">*</span> <span class="n">grazing</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">grazing</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>      <span class="c1"># Moderate grazing best
</span>    <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="p">).</span><span class="n">clip</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">meadow_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s">'soil_ph'</span><span class="p">:</span> <span class="n">soil_ph</span><span class="p">,</span>
    <span class="s">'nitrogen_mg_kg'</span><span class="p">:</span> <span class="n">nitrogen</span><span class="p">,</span>
    <span class="s">'precipitation_mm'</span><span class="p">:</span> <span class="n">precipitation</span><span class="p">,</span>
    <span class="s">'grazing_intensity'</span><span class="p">:</span> <span class="n">grazing</span><span class="p">,</span>
    <span class="s">'species_richness'</span><span class="p">:</span> <span class="n">richness</span>
<span class="p">})</span>

<span class="c1"># Prepare data
</span><span class="n">X</span> <span class="o">=</span> <span class="n">meadow_data</span><span class="p">[[</span><span class="s">'soil_ph'</span><span class="p">,</span> <span class="s">'nitrogen_mg_kg'</span><span class="p">,</span> <span class="s">'precipitation_mm'</span><span class="p">,</span> <span class="s">'grazing_intensity'</span><span class="p">]]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">meadow_data</span><span class="p">[</span><span class="s">'species_richness'</span><span class="p">]</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Multiple Regression
</span><span class="n">lr</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">lr</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">lr_r2</span> <span class="o">=</span> <span class="n">lr</span><span class="p">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

<span class="c1"># Random Forest
</span><span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">rf</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">rf_r2</span> <span class="o">=</span> <span class="n">rf</span><span class="p">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"=== Model Comparison ==="</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Multiple Regression R²: </span><span class="si">{</span><span class="n">lr_r2</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Random Forest R²: </span><span class="si">{</span><span class="n">rf_r2</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">=== Feature Importance (Random Forest) ==="</span><span class="p">)</span>
<span class="k">for</span> <span class="n">feat</span><span class="p">,</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="p">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">rf</span><span class="p">.</span><span class="n">feature_importances_</span><span class="p">),</span> 
                        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">imp</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># Random Forest typically performs better due to non-linear relationships
# Soil pH and grazing intensity are usually most important due to their 
# non-linear effects on plant diversity
</span></code></pre></div> </div> </details> </div> </div> <h2 id="47-when-to-use-which-method"> <a href="#47-when-to-use-which-method" class="anchor-heading" aria-labelledby="47-when-to-use-which-method"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4.7 When to Use Which Method </h2> <div class="table-wrapper"><table> <thead> <tr> <th>Scenario</th> <th>Recommended Method</th> </tr> </thead> <tbody> <tr> <td>Simple, single predictor</td> <td>Simple Regression</td> </tr> <tr> <td>Need interpretable coefficients</td> <td>Multiple Regression</td> </tr> <tr> <td>Complex, non-linear relationships</td> <td>Random Forest</td> </tr> <tr> <td>Small dataset (&lt;50 observations)</td> <td>Simple or Multiple Regression</td> </tr> <tr> <td>Large dataset with many predictors</td> <td>Random Forest</td> </tr> <tr> <td>Need to identify key drivers</td> <td>Random Forest (feature importance)</td> </tr> <tr> <td>Publication requiring interpretability</td> <td>Multiple Regression + Random Forest for comparison</td> </tr> </tbody> </table></div><hr /> <h1 id="chapter-5-interpolation-and-gap-filling"> <a href="#chapter-5-interpolation-and-gap-filling" class="anchor-heading" aria-labelledby="chapter-5-interpolation-and-gap-filling"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <strong>Chapter 5: Interpolation and Gap Filling</strong> </h1> <p>In this final chapter, we apply regression techniques to a common problem in ecological time-series data: filling gaps caused by missing values. This is a practical application that demonstrates how the methods we’ve learned can solve real-world ecological data challenges.</p> <h2 id="51-understanding-missing-data-in-ecological-time-series"> <a href="#51-understanding-missing-data-in-ecological-time-series" class="anchor-heading" aria-labelledby="51-understanding-missing-data-in-ecological-time-series"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5.1 Understanding Missing Data in Ecological Time Series </h2> <p>Ecological monitoring data often has gaps due to:</p> <ul> <li>Sensor malfunctions or power failures</li> <li>Instrument maintenance periods</li> <li>Unfavorable weather conditions (e.g., rain on optical sensors)</li> <li>Data quality filtering that removes erroneous values</li> <li>Wildlife interference with equipment</li> </ul> <p>These gaps need to be handled appropriately for:</p> <ul> <li>Computing annual sums or means (e.g., annual carbon budget)</li> <li>Continuous time series analysis</li> <li>Model calibration and validation</li> </ul> <h2 id="52-loading-and-preparing-data"> <a href="#52-loading-and-preparing-data" class="anchor-heading" aria-labelledby="52-loading-and-preparing-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5.2 Loading and Preparing Data </h2> <p>Let’s work with meteorological data that contains missing values. In real datasets, missing values are often represented by placeholder values (like -999.99) that need to be converted to proper NaN values.</p> <p><a href="/New_BAI_DataAnalysis/assets/data/dwd_ahaus_1996_2023_missing_placeholders.parquet">Download the example file here</a></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="n">px</span>

<span class="c1"># Load meteorological data
</span><span class="n">df_dwd</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s">'./dwd_ahaus_1996_2023_missing_placeholders.parquet'</span><span class="p">)</span>
<span class="n">df_dwd</span><span class="p">[</span><span class="s">"data_time"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_dwd</span><span class="p">[</span><span class="s">"data_time"</span><span class="p">])</span>

<span class="c1"># Check for placeholder values
</span><span class="k">print</span><span class="p">(</span><span class="s">"Data preview:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_dwd</span><span class="p">.</span><span class="n">head</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="se">\n</span><span class="s">Minimum temperature value: </span><span class="si">{</span><span class="n">df_dwd</span><span class="p">[</span><span class="s">'tair_2m_mean'</span><span class="p">].</span><span class="nb">min</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="c1"># If minimum is -999.99, we have placeholder values
</span></code></pre></div></div> <h3 id="handling-placeholder-values"> <a href="#handling-placeholder-values" class="anchor-heading" aria-labelledby="handling-placeholder-values"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Handling Placeholder Values </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Find and replace placeholder values (-999.99) with NaN
</span><span class="n">indices_of_missing</span> <span class="o">=</span> <span class="n">df_dwd</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_dwd</span><span class="p">[</span><span class="s">"tair_2m_mean"</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mf">999.99</span><span class="p">,</span> <span class="s">"tair_2m_mean"</span><span class="p">].</span><span class="n">index</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Number of placeholder values found: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">indices_of_missing</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># Replace with NaN
</span><span class="n">df_dwd</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">indices_of_missing</span><span class="p">,</span> <span class="s">"tair_2m_mean"</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">NaN</span>

<span class="c1"># Now the data can be properly visualized
</span><span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_dwd</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">'data_time'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">"tair_2m_mean"</span><span class="p">,</span> 
                 <span class="n">title</span><span class="o">=</span><span class="s">"Air Temperature (Missing Values Handled)"</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="s">'simple_white'</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div> <div style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 5px;"> <div class="notice--primary"> <h3> <a href="#handling-placeholder-values" class="anchor-heading" aria-labelledby="handling-placeholder-values"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exercise 5.1 </h3> <p>Look at a quick plot of the raw data with placeholder values (-999.99). Then resample to daily values and plot again. Why are the resampled values problematic for ecological analysis?</p> <details> <summary>Solution!</summary> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Load fresh data to see the issue
</span><span class="n">df_raw</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s">'./dwd_ahaus_1996_2023_missing_placeholders.parquet'</span><span class="p">)</span>
<span class="n">df_raw</span><span class="p">[</span><span class="s">"data_time"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_raw</span><span class="p">[</span><span class="s">"data_time"</span><span class="p">])</span>

<span class="c1"># Plot with placeholder values
</span><span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_raw</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">'data_time'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">"tair_2m_mean"</span><span class="p">,</span> 
                 <span class="n">title</span><span class="o">=</span><span class="s">"Raw Data with Placeholder Values"</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1"># The -999.99 values make the actual data barely visible due to y-axis scaling
</span>
<span class="c1"># Resample to daily
</span><span class="n">df_daily</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">.</span><span class="n">resample</span><span class="p">(</span><span class="n">rule</span><span class="o">=</span><span class="s">'D'</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s">'data_time'</span><span class="p">).</span><span class="n">mean</span><span class="p">()</span>
<span class="n">fig_daily</span> <span class="o">=</span> <span class="n">px</span><span class="p">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_daily</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">df_daily</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">"tair_2m_mean"</span><span class="p">,</span>
                       <span class="n">title</span><span class="o">=</span><span class="s">"Daily Resampled Data (Incorrect)"</span><span class="p">)</span>
<span class="n">fig_daily</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Problem: The placeholder values (-999.99) are included in mean calculations
# This pulls daily averages to unrealistically low values
# For ecological analysis, this would give completely wrong estimates of:
# - Growing degree days
# - Heat stress periods  
# - Frost days
# - Any temperature-dependent ecological process
</span></code></pre></div> </div> </details> </div> </div> <h2 id="53-linear-interpolation"> <a href="#53-linear-interpolation" class="anchor-heading" aria-labelledby="53-linear-interpolation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5.3 Linear Interpolation </h2> <p>The simplest gap-filling method connects adjacent known points with straight lines.</p> <h3 id="the-mathematics"> <a href="#the-mathematics" class="anchor-heading" aria-labelledby="the-mathematics"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The Mathematics </h3> <p>For interpolating between two points (x₁, y₁) and (x₂, y₂) at position xₙ:</p> <p><strong>yₙ = y₁ + [(y₂ - y₁) / (x₂ - x₁)] × (xₙ - x₁)</strong></p> <h3 id="implementation-with-a-simple-dataset"> <a href="#implementation-with-a-simple-dataset" class="anchor-heading" aria-labelledby="implementation-with-a-simple-dataset"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Implementation with a Simple Dataset </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create a simple dataset to demonstrate interpolation
</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"full_data"</span><span class="p">:</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">12</span><span class="p">],</span>  <span class="c1"># Temperature-like pattern
</span>    <span class="s">"gapped_data"</span><span class="p">:</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">NaN</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">NaN</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">NaN</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">demo_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Dataset with gaps:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">demo_df</span><span class="p">)</span>
</code></pre></div></div> <h3 id="using-pandas-interpolate"> <a href="#using-pandas-interpolate" class="anchor-heading" aria-labelledby="using-pandas-interpolate"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using Pandas interpolate() </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Linear interpolation with pandas
</span><span class="n">demo_df</span><span class="p">[</span><span class="s">"interpolated"</span><span class="p">]</span> <span class="o">=</span> <span class="n">demo_df</span><span class="p">[</span><span class="s">"gapped_data"</span><span class="p">].</span><span class="n">interpolate</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s">'linear'</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">After interpolation:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">demo_df</span><span class="p">)</span>

<span class="c1"># Visualize
</span><span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="p">.</span><span class="n">Figure</span><span class="p">()</span>
<span class="n">fig</span><span class="p">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="p">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">demo_df</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">demo_df</span><span class="p">[</span><span class="s">'full_data'</span><span class="p">],</span> 
                         <span class="n">mode</span><span class="o">=</span><span class="s">'markers+lines'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'True Values'</span><span class="p">,</span>
                         <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'blue'</span><span class="p">)))</span>
<span class="n">fig</span><span class="p">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="p">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">demo_df</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">demo_df</span><span class="p">[</span><span class="s">'interpolated'</span><span class="p">],</span> 
                         <span class="n">mode</span><span class="o">=</span><span class="s">'markers'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'Interpolated'</span><span class="p">,</span>
                         <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'red'</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s">'x'</span><span class="p">)))</span>
<span class="n">fig</span><span class="p">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">'Linear Interpolation Example'</span><span class="p">,</span>
                  <span class="n">xaxis_title</span><span class="o">=</span><span class="s">'Time'</span><span class="p">,</span> <span class="n">yaxis_title</span><span class="o">=</span><span class="s">'Temperature (°C)'</span><span class="p">,</span>
                  <span class="n">template</span><span class="o">=</span><span class="s">'simple_white'</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div> <h3 id="evaluating-interpolation-quality"> <a href="#evaluating-interpolation-quality" class="anchor-heading" aria-labelledby="evaluating-interpolation-quality"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Evaluating Interpolation Quality </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_RMSE</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_predicted</span><span class="p">):</span>
    <span class="s">"""Calculate Root Mean Squared Error"""</span>
    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">((</span><span class="n">y_true</span> <span class="o">-</span> <span class="n">y_predicted</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

<span class="c1"># Find indices where we interpolated
</span><span class="n">gap_indices</span> <span class="o">=</span> <span class="n">demo_df</span><span class="p">[</span><span class="n">demo_df</span><span class="p">[</span><span class="s">"gapped_data"</span><span class="p">].</span><span class="n">isna</span><span class="p">()].</span><span class="n">index</span>

<span class="c1"># Compare interpolated to true values
</span><span class="n">y_true</span> <span class="o">=</span> <span class="n">demo_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gap_indices</span><span class="p">,</span> <span class="s">"full_data"</span><span class="p">]</span>
<span class="n">y_interpolated</span> <span class="o">=</span> <span class="n">demo_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gap_indices</span><span class="p">,</span> <span class="s">"interpolated"</span><span class="p">]</span>

<span class="n">rmse</span> <span class="o">=</span> <span class="n">get_RMSE</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_interpolated</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"RMSE of linear interpolation: </span><span class="si">{</span><span class="n">rmse</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">°C"</span><span class="p">)</span>
</code></pre></div></div> <h2 id="54-gap-filling-with-multiple-regression"> <a href="#54-gap-filling-with-multiple-regression" class="anchor-heading" aria-labelledby="54-gap-filling-with-multiple-regression"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5.4 Gap Filling with Multiple Regression </h2> <p>When we have correlated environmental variables, we can use them to improve gap filling.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Work with full meteorological dataset
</span><span class="n">df_dwd</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s">'./dwd_ahaus_1996_2023_missing_placeholders.parquet'</span><span class="p">)</span>
<span class="n">df_dwd</span><span class="p">[</span><span class="s">"data_time"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_dwd</span><span class="p">[</span><span class="s">"data_time"</span><span class="p">])</span>

<span class="c1"># Replace placeholders in all columns
</span><span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_dwd</span><span class="p">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">number</span><span class="p">]).</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">df_dwd</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_dwd</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mf">999.99</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">NaN</span>

<span class="c1"># Check which variables could predict temperature
</span><span class="k">print</span><span class="p">(</span><span class="s">"Correlations with air temperature:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">df_dwd</span><span class="p">.</span><span class="n">corr</span><span class="p">()[</span><span class="s">"tair_2m_mean"</span><span class="p">].</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
</code></pre></div></div> <h3 id="building-a-gap-filling-model"> <a href="#building-a-gap-filling-model" class="anchor-heading" aria-labelledby="building-a-gap-filling-model"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Building a Gap-Filling Model </h3> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># Select predictors that are often available when temperature is missing
# (e.g., radiation and humidity sensors might work when temperature sensor fails)
</span><span class="n">predictors</span> <span class="o">=</span> <span class="p">[</span><span class="s">"SWIN"</span><span class="p">,</span> <span class="s">"rH"</span><span class="p">]</span>  <span class="c1"># Solar radiation and relative humidity
</span>
<span class="c1"># Remove rows where predictors or target are missing (for training)
</span><span class="n">df_complete</span> <span class="o">=</span> <span class="n">df_dwd</span><span class="p">[[</span><span class="s">"data_time"</span><span class="p">,</span> <span class="s">"SWIN"</span><span class="p">,</span> <span class="s">"rH"</span><span class="p">,</span> <span class="s">"tair_2m_mean"</span><span class="p">]].</span><span class="n">dropna</span><span class="p">()</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">df_complete</span><span class="p">[</span><span class="n">predictors</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df_complete</span><span class="p">[</span><span class="s">"tair_2m_mean"</span><span class="p">]</span>

<span class="c1"># Split for validation
</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="c1"># Fit regression model
</span><span class="n">gap_model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">gap_model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Evaluate
</span><span class="n">y_pred</span> <span class="o">=</span> <span class="n">gap_model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Gap-filling model R²: </span><span class="si">{</span><span class="n">gap_model</span><span class="p">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"RMSE: </span><span class="si">{</span><span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">°C"</span><span class="p">)</span>

<span class="c1"># Coefficients tell us the relationships
</span><span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Model coefficients:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Solar radiation: </span><span class="si">{</span><span class="n">gap_model</span><span class="p">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">6</span><span class="n">f</span><span class="si">}</span><span class="s"> °C per W/m²"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  Relative humidity: </span><span class="si">{</span><span class="n">gap_model</span><span class="p">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> °C per %"</span><span class="p">)</span>
</code></pre></div></div> <h2 id="55-gap-filling-with-random-forest"> <a href="#55-gap-filling-with-random-forest" class="anchor-heading" aria-labelledby="55-gap-filling-with-random-forest"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5.5 Gap Filling with Random Forest </h2> <p>For more accurate gap filling, Random Forest can capture complex relationships:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>

<span class="c1"># Use more predictors
</span><span class="n">df_complete</span> <span class="o">=</span> <span class="n">df_dwd</span><span class="p">[[</span><span class="s">"SWIN"</span><span class="p">,</span> <span class="s">"rH"</span><span class="p">,</span> <span class="s">"pressure_air"</span><span class="p">,</span> <span class="s">"wind_speed"</span><span class="p">,</span> 
                      <span class="s">"precipitation"</span><span class="p">,</span> <span class="s">"tair_2m_mean"</span><span class="p">]].</span><span class="n">dropna</span><span class="p">()</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">df_complete</span><span class="p">[[</span><span class="s">"SWIN"</span><span class="p">,</span> <span class="s">"rH"</span><span class="p">,</span> <span class="s">"pressure_air"</span><span class="p">,</span> <span class="s">"wind_speed"</span><span class="p">,</span> <span class="s">"precipitation"</span><span class="p">]]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df_complete</span><span class="p">[</span><span class="s">"tair_2m_mean"</span><span class="p">]</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="c1"># Fit Random Forest
</span><span class="n">rf_gap_model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">rf_gap_model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Evaluate
</span><span class="n">y_pred_rf</span> <span class="o">=</span> <span class="n">rf_gap_model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"=== Random Forest Gap-Filling ==="</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"R²: </span><span class="si">{</span><span class="n">rf_gap_model</span><span class="p">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"RMSE: </span><span class="si">{</span><span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_rf</span><span class="p">))</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">°C"</span><span class="p">)</span>

<span class="c1"># Feature importance for gap filling
</span><span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Variable importance for temperature estimation:"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">feat</span><span class="p">,</span> <span class="n">imp</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="p">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">rf_gap_model</span><span class="p">.</span><span class="n">feature_importances_</span><span class="p">),</span> 
                        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"  </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">imp</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div> <h2 id="56-comparing-gap-filling-methods"> <a href="#56-comparing-gap-filling-methods" class="anchor-heading" aria-labelledby="56-comparing-gap-filling-methods"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5.6 Comparing Gap-Filling Methods </h2> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Aggregate to hourly for comparison
</span><span class="n">df_hourly</span> <span class="o">=</span> <span class="n">df_complete</span><span class="p">.</span><span class="n">resample</span><span class="p">(</span><span class="s">'1h'</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">df_dwd</span><span class="p">[</span><span class="s">'data_time'</span><span class="p">].</span><span class="n">loc</span><span class="p">[</span><span class="n">df_complete</span><span class="p">.</span><span class="n">index</span><span class="p">]).</span><span class="n">mean</span><span class="p">().</span><span class="n">dropna</span><span class="p">()</span>

<span class="n">X_hourly</span> <span class="o">=</span> <span class="n">df_hourly</span><span class="p">[[</span><span class="s">"SWIN"</span><span class="p">,</span> <span class="s">"rH"</span><span class="p">,</span> <span class="s">"pressure_air"</span><span class="p">,</span> <span class="s">"wind_speed"</span><span class="p">,</span> <span class="s">"precipitation"</span><span class="p">]]</span>
<span class="n">y_hourly</span> <span class="o">=</span> <span class="n">df_hourly</span><span class="p">[</span><span class="s">"tair_2m_mean"</span><span class="p">]</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X_hourly</span><span class="p">,</span> <span class="n">y_hourly</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># 1. Linear Interpolation (temporal only)
</span><span class="n">y_train_sorted</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="n">y_test_sorted</span> <span class="o">=</span> <span class="n">y_test</span><span class="p">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="n">interpolated</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">interp</span><span class="p">(</span>
    <span class="n">y_test_sorted</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="n">y_train_sorted</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="n">y_train_sorted</span>
<span class="p">)</span>
<span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
    <span class="s">'Method'</span><span class="p">:</span> <span class="s">'Linear Interpolation'</span><span class="p">,</span>
    <span class="s">'R²'</span><span class="p">:</span> <span class="n">metrics</span><span class="p">.</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y_test_sorted</span><span class="p">,</span> <span class="n">interpolated</span><span class="p">),</span>
    <span class="s">'RMSE'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test_sorted</span><span class="p">,</span> <span class="n">interpolated</span><span class="p">))</span>
<span class="p">})</span>

<span class="c1"># 2. Multiple Regression
</span><span class="n">lr</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">lr</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">lr_pred</span> <span class="o">=</span> <span class="n">lr</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
    <span class="s">'Method'</span><span class="p">:</span> <span class="s">'Multiple Regression'</span><span class="p">,</span>
    <span class="s">'R²'</span><span class="p">:</span> <span class="n">metrics</span><span class="p">.</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">lr_pred</span><span class="p">),</span>
    <span class="s">'RMSE'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">lr_pred</span><span class="p">))</span>
<span class="p">})</span>

<span class="c1"># 3. Random Forest
</span><span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">rf</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">rf_pred</span> <span class="o">=</span> <span class="n">rf</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
    <span class="s">'Method'</span><span class="p">:</span> <span class="s">'Random Forest'</span><span class="p">,</span>
    <span class="s">'R²'</span><span class="p">:</span> <span class="n">metrics</span><span class="p">.</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">rf_pred</span><span class="p">),</span>
    <span class="s">'RMSE'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">rf_pred</span><span class="p">))</span>
<span class="p">})</span>

<span class="c1"># Display comparison
</span><span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">=== Gap-Filling Method Comparison ==="</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">results_df</span><span class="p">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>

<span class="c1"># Visualize
</span><span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="p">.</span><span class="n">bar</span><span class="p">(</span><span class="n">results_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">'Method'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'RMSE'</span><span class="p">,</span> 
             <span class="n">title</span><span class="o">=</span><span class="s">'Gap-Filling Methods: RMSE Comparison'</span><span class="p">,</span>
             <span class="n">text</span><span class="o">=</span><span class="s">'RMSE'</span><span class="p">,</span>
             <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s">'RMSE'</span><span class="p">:</span> <span class="s">'RMSE (°C)'</span><span class="p">})</span>
<span class="n">fig</span><span class="p">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">texttemplate</span><span class="o">=</span><span class="s">'%{text:.2f}'</span><span class="p">,</span> <span class="n">textposition</span><span class="o">=</span><span class="s">'outside'</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="s">'simple_white'</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div> <h2 id="57-effect-of-gap-length"> <a href="#57-effect-of-gap-length" class="anchor-heading" aria-labelledby="57-effect-of-gap-length"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5.7 Effect of Gap Length </h2> <p>Different methods perform differently depending on gap length:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Test gap-filling performance for different gap lengths
</span><span class="k">def</span> <span class="nf">test_gap_length</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">gap_hours</span><span class="p">):</span>
    <span class="s">"""Test gap-filling for a specific gap length"""</span>
    <span class="c1"># Create artificial gap
</span>    <span class="n">gap_start</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">gap_end</span> <span class="o">=</span> <span class="n">gap_start</span> <span class="o">+</span> <span class="n">gap_hours</span>
    
    <span class="c1"># Get true values
</span>    <span class="n">y_true</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">gap_start</span><span class="p">:</span><span class="n">gap_end</span><span class="p">][</span><span class="s">"tair_2m_mean"</span><span class="p">]</span>
    
    <span class="c1"># Get predictor values
</span>    <span class="n">X_gap</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s">"SWIN"</span><span class="p">,</span> <span class="s">"rH"</span><span class="p">,</span> <span class="s">"pressure_air"</span><span class="p">,</span> <span class="s">"wind_speed"</span><span class="p">,</span> <span class="s">"precipitation"</span><span class="p">]].</span><span class="n">iloc</span><span class="p">[</span><span class="n">gap_start</span><span class="p">:</span><span class="n">gap_end</span><span class="p">]</span>
    
    <span class="c1"># Predict
</span>    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_gap</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>

<span class="c1"># Test different gap lengths
</span><span class="n">gap_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">72</span><span class="p">]</span>  <span class="c1"># hours
</span><span class="n">gap_results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">gap_len</span> <span class="ow">in</span> <span class="n">gap_lengths</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Linear interpolation RMSE (approximation)
</span>        <span class="n">interp_rmse</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">gap_len</span><span class="p">)</span>  <span class="c1"># Increases with gap length
</span>        
        <span class="c1"># Random Forest RMSE (relatively constant)
</span>        <span class="n">rf_rmse</span> <span class="o">=</span> <span class="n">test_gap_length</span><span class="p">(</span><span class="n">df_hourly</span><span class="p">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">rf</span><span class="p">,</span> <span class="n">gap_len</span><span class="p">)</span>
        
        <span class="n">gap_results</span><span class="p">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s">'Gap Length (hours)'</span><span class="p">:</span> <span class="n">gap_len</span><span class="p">,</span>
            <span class="s">'Linear Interpolation'</span><span class="p">:</span> <span class="n">interp_rmse</span><span class="p">,</span>
            <span class="s">'Random Forest'</span><span class="p">:</span> <span class="n">rf_rmse</span>
        <span class="p">})</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="n">gap_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">gap_results</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">=== Performance vs Gap Length ==="</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">gap_df</span><span class="p">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
</code></pre></div></div> <h2 id="58-best-practices-for-ecological-gap-filling"> <a href="#58-best-practices-for-ecological-gap-filling" class="anchor-heading" aria-labelledby="58-best-practices-for-ecological-gap-filling"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5.8 Best Practices for Ecological Gap Filling </h2> <ol> <li> <p><strong>Understand your gaps</strong>: Are they random or systematic? Short or long?</p> </li> <li><strong>Use appropriate predictors</strong>: Choose variables that are: <ul> <li>Ecologically related to the target</li> <li>Available when the target is missing</li> <li>From independent sensors</li> </ul> </li> <li> <p><strong>Validate thoroughly</strong>: Test on known data before applying to real gaps</p> </li> <li> <p><strong>Document uncertainty</strong>: Gap-filled values have uncertainty — flag them in your dataset</p> </li> <li><strong>Consider the application</strong>: <ul> <li>Short gaps (hours): Linear interpolation often sufficient</li> <li>Medium gaps (days): Multiple regression with environmental predictors</li> <li>Long gaps (weeks): Random Forest or similar methods</li> </ul> </li> <li><strong>Don’t fill everything</strong>: Very long gaps (months) may be better left as missing</li> </ol> <div style="background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 5px;"> <div class="notice--primary"> <h3> <a href="#58-best-practices-for-ecological-gap-filling" class="anchor-heading" aria-labelledby="58-best-practices-for-ecological-gap-filling"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exercise 5.2 </h3> <p>Compare all gap-filling methods (linear interpolation, multiple regression, and Random Forest) for filling temperature gaps of different lengths (1 hour, 12 hours, 24 hours). Which method is best for short gaps? For longer gaps? Why?</p> <details> <summary>Solution!</summary> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Comparison across gap lengths
</span><span class="k">print</span><span class="p">(</span><span class="s">"=== Gap-Filling Comparison Across Gap Lengths ===</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

<span class="c1"># For short gaps (1-6 hours):
# - Linear interpolation works well because temperature changes slowly
# - The adjacent values provide good estimates
# - Random Forest may actually perform worse due to prediction uncertainty
</span>
<span class="c1"># For medium gaps (12-24 hours):
# - Linear interpolation fails because it misses the diurnal cycle
# - Multiple regression helps if radiation/humidity data available
# - Random Forest captures the diurnal pattern from predictors
</span>
<span class="c1"># For long gaps (&gt;48 hours):
# - Linear interpolation is unreliable
# - Multiple regression depends on predictor quality
# - Random Forest is typically best due to complex pattern capture
</span>
<span class="k">print</span><span class="p">(</span><span class="s">"""
Summary:
- Short gaps (1-6h): Linear interpolation is often sufficient and simplest
- Medium gaps (12-24h): Multiple regression or Random Forest needed
- Long gaps (&gt;48h): Random Forest typically best, but consider leaving as missing

Key insight: The choice depends on whether temporal autocorrelation 
(adjacent values similar) or environmental relationships (predictors 
explain variance) better captures the missing pattern.
"""</span><span class="p">)</span>
</code></pre></div> </div> </details> </div> </div><hr /> <h1 id="summary"> <a href="#summary" class="anchor-heading" aria-labelledby="summary"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <strong>Summary</strong> </h1> <p>In this tutorial, we covered:</p> <ol> <li> <p><strong>Foundations of Regression</strong>: Core concepts including target variables, predictors, models, coefficients, residuals, and evaluation metrics (R², RMSE, MAE).</p> </li> <li> <p><strong>Simple Linear Regression</strong>: Modeling single predictor-response relationships, with ecological examples of tree growth and environmental drivers.</p> </li> <li> <p><strong>Multiple Regression</strong>: Incorporating multiple environmental predictors to model complex ecological responses like carbon flux.</p> </li> <li> <p><strong>Machine Learning (Random Forest)</strong>: Capturing non-linear relationships and interactions, with applications to ecological prediction and feature importance analysis.</p> </li> <li> <p><strong>Gap Filling</strong>: Practical application of regression methods to fill missing values in ecological time series.</p> </li> </ol> <p><strong>Key Ecological Insights:</strong></p> <ul> <li>Ecological systems are complex — multiple regression and machine learning often outperform simple models</li> <li>Feature importance from Random Forest helps identify key environmental drivers</li> <li>The best method depends on data characteristics, gap length, and analysis goals</li> <li>Always validate models on independent test data</li> </ul> <p><strong>Further Learning:</strong></p> <ul> <li>Generalized Additive Models (GAMs) for non-linear regression</li> <li>Mixed-effects models for hierarchical ecological data</li> <li>Gradient Boosting (XGBoost, LightGBM) for prediction</li> <li>Neural networks for very large ecological datasets</li> <li>Time series-specific methods (ARIMA, seasonal decomposition)</li> </ul> <p><strong>Remember:</strong> Models are simplifications of reality. In ecology, the goal is often not perfect prediction but understanding which factors drive ecological patterns and processes.</p> </main> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
